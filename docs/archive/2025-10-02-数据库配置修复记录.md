# 2025年10月2日 - 数据库配置修复记录

## 🐛 问题现象

用户登录成功后，dashboard页面无法加载数据，控制台显示：
- `503 Service Unavailable`
- `400 Bad Request`  
- API返回: "数据库未连接"

## 🔍 问题诊断过程

### 1. 登录API路径问题（已修复）
**问题**: 前端和后端的登录API路径不一致
- 前端调用: `/admin/auth/login`
- 后端路由: `/auth/admin/login`

**解决方案**:
- 修改了 `admin-frontend/src/services/api.ts`
- 修改了 `admin-frontend/src/App.tsx`
- 重新构建并部署前端

### 2. 数据库连接配置错误
**问题**: `.env` 文件中的数据库配置不正确

**原始配置**:
```env
DB_USER=points_app
DB_PASSWORD=GuanDongFang2024!@#
DB_NAME=points_app
```

**实际情况**:
- `points_app` 用户密码不正确，无法连接
- 数据表实际在 `points_app_dev` 数据库中

**解决方案**:
```env
DB_USER=root
DB_PASSWORD=123456
DB_NAME=points_app_dev
```

### 3. 数据库字符集冲突
**问题**: MySQL 8.0 字符集不一致导致查询失败
```
Illegal mix of collations (utf8mb4_unicode_ci,IMPLICIT) and (utf8mb4_0900_ai_ci,IMPLICIT)
```

**解决方案**: 统一所有表的字符集为 `utf8mb4_unicode_ci`
```sql
SET FOREIGN_KEY_CHECKS = 0;

ALTER TABLE admin_operation_logs CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE admin_roles CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE admin_users CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE merchants CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE payment_orders CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE points_records CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE user_points CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
ALTER TABLE users CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

SET FOREIGN_KEY_CHECKS = 1;
```

## ✅ 修复后的配置

### 服务器 `.env` 文件
```env
NODE_ENV=production
PORT=3000

# 数据库配置（已修复）
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=points_app_dev

# JWT配置
JWT_SECRET=guandongfang_points_jwt_secret_2024_secure
JWT_EXPIRES_IN=7d
```

### 数据库信息
- **数据库名**: `points_app_dev`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **表列表**:
  - admin_operation_logs
  - admin_roles
  - admin_users
  - merchants
  - payment_orders
  - points_records
  - user_points
  - users

## 🧪 验证结果

```bash
# 测试登录API
curl -X POST http://localhost:3000/api/v1/auth/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
# ✅ 返回: {"success":true,"data":{"token":"..."}}

# 测试dashboard API
curl http://localhost:3000/api/v1/admin/dashboard/stats \
  -H "Authorization: Bearer TOKEN"
# ✅ 返回: {"success":true,"data":{...}}
```

## 📝 Git提交记录

1. **fec6449** - fix: 修复登录API路径错误（api.ts）
2. **d159389** - fix: 修复App.tsx中的登录API路径
3. 服务器配置文件已更新（未提交到git）

## 🎯 系统状态

- ✅ 前端部署成功
- ✅ 后端服务运行正常
- ✅ 数据库连接成功
- ✅ API接口正常响应
- ✅ dashboard数据可以正常加载

## 🔧 后续优化建议

1. **数据库用户安全性**: 
   - 创建专用的应用数据库用户
   - 设置强密码
   - 限制权限（不使用root用户）

2. **数据库规范化**:
   - 统一使用 `points_app_dev` 或 `points_app`
   - 清理不使用的数据库

3. **字符集标准化**:
   - 在创建新表时明确指定字符集
   - 定期检查字符集一致性

4. **环境变量管理**:
   - 区分开发和生产环境配置
   - 使用环境变量管理工具

## 📊 最终配置总结

| 配置项 | 开发环境 | 生产环境 |
|--------|---------|---------|
| 数据库主机 | 127.0.0.1 | 127.0.0.1 |
| 数据库端口 | 3306 | 3306 |
| 数据库用户 | root | root |
| 数据库名称 | points_app_dev | points_app_dev |
| 字符集 | utf8mb4_unicode_ci | utf8mb4_unicode_ci |

---

**修复时间**: 2025年10月2日 18:28  
**修复人员**: 开发团队  
**状态**: ✅ 已完成  
**测试**: ✅ 通过

