# 小程序与后端API对接验证清单

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2025年9月26日
- **文档性质**：🔒 **锁定版本** - 基于已完成功能
- **验证目标**：确保小程序前端与已完成后端API完全吻合

---

## 🎯 验证总体目标

**基于已完成并验证通过的管理后台功能，确保小程序前端能够正确调用所有后端API，实现完整的端到端业务流程。**

---

## ✅ 已完成且锁定的后端API

### 管理后台API (100%完成，禁止修改)
1. **✅ 商户管理API** - merchant-api服务 (端口3003)
   - `GET /api/v1/admin/merchants/stats` - 商户统计
   - `GET /api/v1/admin/merchants` - 商户列表
   - `GET /api/v1/admin/merchants/:id` - 商户详情
   - `PUT /api/v1/admin/merchants/:id` - 商户编辑
   - `DELETE /api/v1/admin/merchants/:id` - 商户删除

2. **✅ 管理员认证API** - prd-complete-api服务 (端口3000)
   - `POST /api/v1/admin/auth/login` - 管理员登录
   - `GET /api/v1/admin/dashboard/stats` - 仪表板统计

### 小程序API (已实现，需要验证)
1. **🧪 用户认证API**
   - `POST /api/v1/auth/wechat-login` - 微信登录
   - `GET /api/v1/auth/user-info` - 用户信息

2. **🧪 积分系统API**
   - `GET /api/v1/points/balance` - 积分余额
   - `GET /api/v1/points/history` - 积分历史

3. **🧪 支付相关API**
   - `POST /api/v1/payments/create` - 创建支付订单
   - `GET /api/v1/merchants/:id` - 商户信息查询

---

## 🧪 小程序API验证步骤

### Step 1: 验证用户认证流程

#### 1.1 微信登录API验证
```bash
# 验证微信登录API是否可用
curl -X POST http://8.156.84.226/api/v1/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code": "test-code"}'

# 期望结果: 返回token和用户信息
```

#### 1.2 小程序登录逻辑验证
**文件**: `frontend/miniprogram/app.js`
- [ ] 启动时调用 `checkLoginStatus()`
- [ ] 调用 `doWechatLogin()` 获取微信code
- [ ] 调用 `/api/v1/auth/wechat-login` API
- [ ] 存储返回的token和用户信息
- [ ] 设置 `this.globalData.token` 和 `this.globalData.userInfo`

### Step 2: 验证积分系统流程

#### 2.1 积分余额API验证
```bash
# 验证积分余额API
curl -X GET http://8.156.84.226/api/v1/points/balance \
  -H "Authorization: Bearer test-token"

# 期望结果: 返回积分余额、累计获得、累计消费
```

#### 2.2 积分页面逻辑验证
**文件**: `frontend/miniprogram/pages/points/index.js`
- [ ] 页面加载时调用 `loadRealPointsData()`
- [ ] 调用 `/api/v1/points/balance` API
- [ ] 调用 `/api/v1/points/history` API
- [ ] 正确显示积分余额和历史记录
- [ ] 错误处理和加载状态显示

### Step 3: 验证支付流程

#### 3.1 商户信息API验证
```bash
# 验证商户信息API（使用真实商户ID）
curl -X GET http://8.156.84.226/api/v1/merchants/merchant_real_001

# 期望结果: 返回商户详细信息
```

#### 3.2 支付页面逻辑验证
**文件**: `frontend/miniprogram/pages/payment/index.js`
- [ ] 扫码后传入 `merchantId` 参数
- [ ] 调用 `loadRealMerchantInfo(merchantId)` 加载商户信息
- [ ] 调用 `/api/v1/merchants/:id` API
- [ ] 显示真实商户信息（名称、类目、状态）
- [ ] 创建支付订单时调用 `/api/v1/payments/create`

#### 3.3 支付创建API验证
```bash
# 验证支付创建API
curl -X POST http://8.156.84.226/api/v1/payments/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-token" \
  -d '{"merchantId": "merchant_real_001", "amount": 5000}'

# 期望结果: 返回微信支付参数
```

### Step 4: 验证数据一致性

#### 4.1 商户数据一致性
- [ ] 管理后台显示的商户信息
- [ ] 小程序通过API获取的商户信息
- [ ] 数据库中的商户记录
- **验证字段**: `merchantName`, `subMchId`, `businessCategory`, `status`

#### 4.2 用户数据一致性
- [ ] 小程序获取的用户信息
- [ ] 数据库中的用户记录
- [ ] JWT Token中的用户信息
- **验证字段**: `nickname`, `openid`, `avatar`, `phone`

---

## 🔧 API连通性测试命令

### 批量测试所有API端点
```bash
#!/bin/bash
echo "=== 🧪 小程序API连通性测试 ==="

# 测试基础连通性
echo "1. 测试服务器连通性:"
curl -I http://8.156.84.226/api/v1/ 2>/dev/null | head -3

echo -e "\n2. 测试微信登录API:"
curl -X POST http://8.156.84.226/api/v1/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code": "test"}' -s | head -c 100

echo -e "\n3. 测试积分余额API:"
curl -X GET http://8.156.84.226/api/v1/points/balance \
  -H "Authorization: Bearer test" -s | head -c 100

echo -e "\n4. 测试商户信息API:"
curl -X GET http://8.156.84.226/api/v1/merchants/merchant_real_001 -s | head -c 100

echo -e "\n5. 测试支付创建API:"
curl -X POST http://8.156.84.226/api/v1/payments/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test" \
  -d '{"merchantId": "merchant_real_001", "amount": 1000}' -s | head -c 100

echo -e "\n✅ API连通性测试完成"
```

---

## 📋 验证检查清单

### 功能验证 (必须全部通过 ✅)
- [ ] **微信登录**: 小程序能够调用微信登录API并获取用户信息
- [ ] **积分查询**: 积分页面能够显示来自数据库的真实积分数据
- [ ] **商户查询**: 支付页面能够显示来自数据库的真实商户信息
- [ ] **支付创建**: 支付流程能够创建真实的微信支付订单
- [ ] **数据同步**: 前端显示数据与数据库数据完全一致

### API响应验证 (必须全部通过 ✅)
- [ ] `/api/v1/auth/wechat-login` 返回有效的JWT Token
- [ ] `/api/v1/points/balance` 返回正确的积分余额结构
- [ ] `/api/v1/points/history` 返回积分历史记录列表
- [ ] `/api/v1/merchants/:id` 返回完整的商户信息
- [ ] `/api/v1/payments/create` 返回微信支付所需参数

### 错误处理验证 (必须全部通过 ✅)
- [ ] **网络错误**: 小程序能够正确处理API请求失败
- [ ] **登录失效**: Token失效时能够自动重新登录
- [ ] **数据异常**: API返回异常数据时显示友好错误信息
- [ ] **支付失败**: 支付API调用失败时能够正确处理

### 性能验证 (建议通过 📊)
- [ ] **响应时间**: API响应时间 < 2秒
- [ ] **加载体验**: 页面加载过程有适当的Loading状态
- [ ] **错误恢复**: 网络中断后能够自动重试

---

## 🚨 验证失败处理

### 如果API验证失败
1. **检查服务状态**: 确认相关API服务正常运行
2. **检查Nginx配置**: 确认路由配置正确
3. **检查网络连通性**: 确认小程序能够访问后端
4. **查看错误日志**: 检查PM2日志和Nginx错误日志

### 如果数据不一致
1. **对比数据库**: 直接查询数据库确认数据正确性
2. **检查API逻辑**: 确认API返回的数据字段映射正确
3. **验证前端处理**: 确认前端正确解析和显示API数据

### 如果功能异常
1. **分步骤验证**: 从API → 前端逐步验证每个环节
2. **使用测试数据**: 先用固定测试数据验证流程
3. **检查权限配置**: 确认API权限和跨域配置正确

---

## 🎯 验证完成标准

**当以下条件全部满足时，认为小程序与后端API对接完成：**

1. ✅ **所有API端点验证通过** - 能够正常调用并返回预期数据
2. ✅ **所有页面功能正常** - 登录、积分、支付、商户查询都正常工作
3. ✅ **数据完全一致** - 前端显示数据与数据库数据一致
4. ✅ **错误处理完善** - 各种异常情况都有适当的用户提示
5. ✅ **性能表现良好** - 响应速度和用户体验符合要求

**验证完成后，小程序即可与已完成的管理后台功能形成完整的业务闭环。**

---

**⚠️ 重要提醒**: 验证过程中**禁止修改已完成的管理后台功能和API**，只能在小程序端进行必要的调整和修复。
