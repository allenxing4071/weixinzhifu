# 积分系统部署状况文件

## 📋 项目概述
- **项目名称**：微信支付积分赠送系统
- **创建时间**：2025年9月24日
- **当前状态**：准备部署到生产环境

## 🌐 服务器信息
- **服务器IP**：8.156.84.226
- **域名**：guandongfang.cn
- **API域名**：api.guandongfang.cn
- **SSH用户**：root
- **SSH密码**：Xhl_196312
- **操作系统**：Ubuntu 24.04.1 LTS

## 📱 微信小程序配置
- **AppID**：wx9bed12ef0904d035
- **AppSecret**：d0169fe1d4b9441e7b180d814e868553
- **项目名称**：points-assistant

## 💳 微信支付配置
- **商户号**：1727765161
- **API密钥**：GDF2024PayApiKey12345678901234567
- **回调地址**：https://api.guandongfang.cn/api/v1/payments/callback

## 🗄️ 数据库配置
- **数据库名**：points_app
- **用户名**：points_app
- **密码**：GuanDongFang2024!G#
- **位置**：本地MySQL

## 📁 项目结构
```
weinxinzhifu/
├── backend/                    # 后端API服务 (Node.js + TypeScript)
├── frontend/miniprogram/       # 微信小程序前端
├── production-final.env        # 生产环境配置
├── nginx-guandongfang.conf     # Nginx配置
├── pm2-guandongfang.config.js  # PM2进程配置
├── guandongfang-points.tar.gz  # 部署包
└── weixinpay.pem              # SSH密钥
```

## 🎯 已完成的开发工作

### ✅ 前端小程序：
- **积分页面**：完整的积分查看和管理功能
- **支付页面**：完全仿微信支付界面 + 数字键盘
- **我的页面**：用户信息、消费记录专区
- **支付历史页面**：详细的支付记录和积分关系展示
- **积分历史页面**：积分获得和使用明细

### ✅ 后端API：
- **认证系统**：微信登录、JWT认证
- **支付系统**：支付订单创建、微信支付回调处理
- **积分系统**：积分发放、查询、记录管理
- **数据模型**：完整的数据库设计和模型

### ✅ 核心功能特性：
- **1积分=1元**：真实价值体系
- **支付后立即发放积分**：实时处理
- **商户信息突出显示**：用户清楚在哪消费
- **支付成功自动跳转积分页面**：丝滑用户体验
- **完整的支付记录追踪**：支付金额与积分关系展示

## 🚀 Mac端部署命令

### 1. 下载项目代码
```bash
# 方式1：如果有Git仓库
git clone https://github.com/allenxing4071/weinxinzhifu.git
cd weinxinzhifu

# 方式2：下载部署包
scp root@8.156.84.226:/path/to/guandongfang-points.tar.gz ./
tar -xzf guandongfang-points.tar.gz
```

### 2. 上传代码到服务器
```bash
# 上传整个项目
scp -r . root@8.156.84.226:/app/points-system/

# 或者使用已有的部署包
scp guandongfang-points.tar.gz root@8.156.84.226:/tmp/
```

### 3. SSH登录服务器执行部署
```bash
ssh root@8.156.84.226
# 密码：Xhl_196312

# 在服务器上执行：
cd /app/points-system
# 如果使用tar包：tar -xzf /tmp/guandongfang-points.tar.gz

# 复制配置文件
cp production-final.env .env

# 进入后端目录
cd backend

# 安装依赖
npm install --production

# 编译TypeScript
npm run build

# 配置数据库
mysql << 'EOF'
CREATE DATABASE IF NOT EXISTS points_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'points_app'@'localhost' IDENTIFIED BY 'GuanDongFang2024!G#';
GRANT ALL PRIVILEGES ON points_app.* TO 'points_app'@'localhost';
FLUSH PRIVILEGES;
EOF

# 导入数据库结构
mysql -u points_app -p'GuanDongFang2024!G#' points_app < sql/init.sql

# 启动应用
cd /app/points-system
pm2 start pm2-guandongfang.config.js
pm2 startup
pm2 save

# 配置Nginx
cp nginx-guandongfang.conf /etc/nginx/sites-available/api.guandongfang.cn
ln -sf /etc/nginx/sites-available/api.guandongfang.cn /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx

# 申请SSL证书
certbot --nginx -d api.guandongfang.cn --email admin@guandongfang.cn --agree-tos --non-interactive

# 测试API
curl https://api.guandongfang.cn/health
```

### 4. 验证部署结果
```bash
# 检查服务状态
pm2 status
pm2 logs

# 测试关键接口
curl https://api.guandongfang.cn/api/v1/auth/wechat-login
curl https://api.guandongfang.cn/api/v1/points/balance
curl https://api.guandongfang.cn/api/v1/payments

# 检查数据库
mysql -u points_app -p'GuanDongFang2024!G#' points_app -e "SHOW TABLES;"
```

## 📱 小程序配置

### 微信公众平台配置：
1. **登录**：https://mp.weixin.qq.com (AppID: wx9bed12ef0904d035)
2. **开发** → **开发管理** → **开发设置**
3. **配置域名**：
   - request合法域名：`https://api.guandongfang.cn`
   - socket合法域名：`wss://api.guandongfang.cn`
   - uploadFile合法域名：`https://api.guandongfang.cn`
   - downloadFile合法域名：`https://api.guandongfang.cn`

### 上传测试版本：
1. **微信开发者工具**打开项目：`frontend/miniprogram`
2. **编译**项目确认无错误
3. **上传**代码（版本号：v1.0.0-production）
4. **设为体验版**用于测试

## 🧪 测试流程

### 生成商户二维码：
```bash
# 调用后端API生成二维码
curl -X POST https://api.guandongfang.cn/api/v1/merchants/qrcode \
  -H "Content-Type: application/json" \
  -d '{
    "merchantId": "merchant_demo_001",
    "description": "数谷异联科技收款"
  }'
```

### 完整测试流程：
1. **扫描生成的商户二维码**
2. **跳转到支付页面** → 验证商户信息突出显示
3. **输入金额** → 使用数字键盘
4. **查看积分规则** → 确认"1元=1积分"
5. **支付成功** → 验证积分到账动画
6. **自动跳转** → 跳转到积分页面
7. **验证积分** → 确认积分余额正确增加

## ⚠️ 关键文件位置
- **后端配置**：`production-final.env`
- **Nginx配置**：`nginx-guandongfang.conf`
- **PM2配置**：`pm2-guandongfang.config.js`
- **小程序配置**：`frontend/miniprogram/project.config.json`
- **部署包**：`guandongfang-points.tar.gz`

## 🎯 预期结果
- **API服务**：https://api.guandongfang.cn/health 返回200
- **小程序**：能正常调用API接口
- **支付流程**：完整的支付→积分→跳转闭环
- **数据持久化**：所有支付和积分记录正确保存

---

**✅ 此文件包含Mac端部署所需的所有信息！**
