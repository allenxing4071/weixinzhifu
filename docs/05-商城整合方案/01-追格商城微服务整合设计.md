# 追格积分商城微服务架构整合方案

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年9月24日
- **产品经理**：产品团队
- **架构师**：技术团队
- **评审状态**：待评审

---

## 🎯 整合目标

将追格积分商城小程序功能整合到现有微信支付积分系统中，形成完整的"支付获得积分 → 积分商城消费"闭环生态。

### 核心整合原则
1. **模块化设计**：商城功能作为独立微服务模块
2. **数据统一**：共享用户体系和积分体系
3. **体验无缝**：支付与商城功能无缝对接
4. **架构兼容**：复用现有技术栈和基础设施

---

## 🏗️ 微服务架构扩展设计

### 新增微服务模块

```
现有架构 + 商城模块扩展

┌─────────────────────────────────────────────────────────┐
│                     API Gateway                        │
│              (路由、鉴权、限流、监控)                      │
└─────────────────────────────────────────────────────────┘
                              |
            ┌─────────────────┼─────────────────┐
            │                 │                 │
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │   现有服务群    │ │   商城服务群    │ │   共享服务群    │
    └───────────────┘ └───────────────┘ └───────────────┘
            │                 │                 │
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │ 用户服务       │ │ 商品服务       │ │ 通知服务       │
    │ 支付服务       │ │ 订单服务       │ │ 统计服务       │
    │ 积分服务       │ │ 库存服务       │ │ 配置服务       │
    │ 商户服务       │ │ 兑换服务       │ │ 文件服务       │
    └───────────────┘ └───────────────┘ └───────────────┘
```

### 新增服务详细设计

#### 1. 商品服务 (Product Service)
```typescript
interface ProductService {
  // 商品管理
  createProduct(product: CreateProductDto): Promise<ProductEntity>
  updateProduct(id: string, product: UpdateProductDto): Promise<boolean>
  deleteProduct(id: string): Promise<boolean>
  
  // 商品查询
  getProducts(filter: ProductFilter): Promise<ProductList>
  getProductDetail(id: string): Promise<ProductEntity>
  searchProducts(keyword: string): Promise<ProductEntity[]>
  
  // 分类管理
  getCategories(): Promise<CategoryEntity[]>
  getProductsByCategory(categoryId: string): Promise<ProductEntity[]>
  
  // 推荐系统
  getRecommendedProducts(userId: string, context: RecommendContext): Promise<ProductEntity[]>
}
```

#### 2. 兑换服务 (Exchange Service)
```typescript
interface ExchangeService {
  // 兑换处理
  createExchangeOrder(userId: string, productId: string, quantity: number): Promise<ExchangeOrder>
  confirmExchange(orderId: string): Promise<ExchangeResult>
  cancelExchange(orderId: string): Promise<boolean>
  
  // 订单查询
  getExchangeOrders(userId: string, status?: ExchangeStatus): Promise<ExchangeOrder[]>
  getExchangeOrderDetail(orderId: string): Promise<ExchangeOrder>
  
  // 发货管理
  updateDeliveryStatus(orderId: string, status: DeliveryStatus): Promise<boolean>
  trackDelivery(orderId: string): Promise<DeliveryInfo>
}
```

#### 3. 库存服务 (Inventory Service)
```typescript
interface InventoryService {
  // 库存管理
  checkStock(productId: string, quantity: number): Promise<boolean>
  reserveStock(productId: string, quantity: number, orderId: string): Promise<boolean>
  releaseStock(productId: string, quantity: number, orderId: string): Promise<boolean>
  updateStock(productId: string, quantity: number): Promise<boolean>
  
  // 库存查询
  getStockLevel(productId: string): Promise<StockInfo>
  getLowStockProducts(): Promise<ProductEntity[]>
  
  // 库存预警
  setStockAlert(productId: string, threshold: number): Promise<boolean>
}
```

---

## 🗄️ 数据库扩展设计

### 新增数据表

#### 商品表 (products)
```sql
CREATE TABLE products (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category_id VARCHAR(36) NOT NULL,
  points_price INT NOT NULL,
  original_price DECIMAL(10,2),
  stock_quantity INT DEFAULT 0,
  sales_count INT DEFAULT 0,
  images JSON,
  specifications JSON,
  is_hot BOOLEAN DEFAULT FALSE,
  is_new BOOLEAN DEFAULT FALSE,
  status TINYINT DEFAULT 1,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_category_id (category_id),
  INDEX idx_points_price (points_price),
  INDEX idx_status (status),
  INDEX idx_is_hot (is_hot),
  INDEX idx_sales_count (sales_count)
);
```

#### 商品分类表 (product_categories)
```sql
CREATE TABLE product_categories (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(500),
  parent_id VARCHAR(36),
  level INT DEFAULT 1,
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_parent_id (parent_id),
  INDEX idx_level (level),
  INDEX idx_sort_order (sort_order)
);
```

#### 兑换订单表 (exchange_orders)
```sql
CREATE TABLE exchange_orders (
  id VARCHAR(36) PRIMARY KEY,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36) NOT NULL,
  product_name VARCHAR(200) NOT NULL,
  quantity INT NOT NULL,
  points_cost INT NOT NULL,
  status TINYINT DEFAULT 0,
  delivery_info JSON,
  tracking_no VARCHAR(100),
  delivery_status TINYINT DEFAULT 0,
  exchanged_at TIMESTAMP NULL,
  delivered_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_product_id (product_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);
```

#### 库存记录表 (inventory_records)
```sql
CREATE TABLE inventory_records (
  id VARCHAR(36) PRIMARY KEY,
  product_id VARCHAR(36) NOT NULL,
  change_type TINYINT NOT NULL, -- 1:入库 2:出库 3:预留 4:释放
  quantity_change INT NOT NULL,
  stock_after INT NOT NULL,
  related_order_id VARCHAR(36),
  operator_id VARCHAR(36),
  description VARCHAR(200),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_change_type (change_type),
  INDEX idx_related_order_id (related_order_id),
  INDEX idx_created_at (created_at)
);
```

---

## 🔄 服务间交互设计

### 积分服务扩展

现有积分服务已经预留了`consumePoints`方法，我们需要扩展以支持商城兑换：

```typescript
// 扩展现有 PointsService
export class PointsService {
  // 现有方法保持不变...
  
  /**
   * 商城兑换积分消费（事务保证）
   */
  static async exchangePoints(
    userId: string,
    productId: string,
    pointsCost: number,
    exchangeOrderId: string
  ): Promise<ExchangeResult> {
    if (pointsCost <= 0) {
      throw new Error('兑换积分数量必须大于0')
    }
    
    const connection = await getDBConnection()
    await connection.beginTransaction()
    
    try {
      // 1. 检查积分余额
      const user = await UserModel.findById(userId)
      if (!user || user.pointsBalance < pointsCost) {
        throw new Error('积分余额不足')
      }
      
      // 2. 检查商品库存
      const stockAvailable = await InventoryService.checkStock(productId, 1)
      if (!stockAvailable) {
        throw new Error('商品库存不足')
      }
      
      // 3. 预留库存
      await InventoryService.reserveStock(productId, 1, exchangeOrderId)
      
      // 4. 扣减积分
      await this.consumePoints(userId, pointsCost, `商城兑换-${productId}`, exchangeOrderId)
      
      // 5. 创建兑换订单
      const exchangeOrder = await ExchangeService.createExchangeOrder({
        userId,
        productId,
        pointsCost,
        quantity: 1
      })
      
      await connection.commit()
      
      return {
        success: true,
        exchangeOrderId: exchangeOrder.id,
        remainingPoints: user.pointsBalance - pointsCost,
        estimatedDelivery: exchangeOrder.estimatedDelivery
      }
      
    } catch (error) {
      await connection.rollback()
      throw error
    }
  }
}
```

### 跨服务事件通信

```typescript
// 事件驱动通信机制
interface ServiceEvent {
  eventId: string
  eventType: string
  source: string
  target: string[]
  payload: any
  timestamp: Date
}

// 事件类型定义
enum EventType {
  // 支付相关
  PAYMENT_SUCCESS = 'payment.success',
  PAYMENT_FAILED = 'payment.failed',
  
  // 积分相关
  POINTS_AWARDED = 'points.awarded',
  POINTS_CONSUMED = 'points.consumed',
  
  // 商城相关
  PRODUCT_EXCHANGED = 'mall.product.exchanged',
  INVENTORY_LOW = 'mall.inventory.low',
  ORDER_DELIVERED = 'mall.order.delivered'
}

// 事件处理器
class EventHandler {
  // 支付成功后的事件处理
  async onPaymentSuccess(event: ServiceEvent) {
    const { userId, amount, orderId } = event.payload
    
    // 1. 发放积分
    await PointsService.awardPoints(userId, amount, 'payment_reward', '支付奖励', orderId)
    
    // 2. 更新用户推荐
    await RecommendationService.updateUserRecommendations(userId)
    
    // 3. 发送通知
    await NotificationService.sendPointsAwardNotification(userId, amount)
  }
  
  // 积分兑换后的事件处理
  async onProductExchanged(event: ServiceEvent) {
    const { userId, productId, pointsCost } = event.payload
    
    // 1. 更新用户画像
    await UserProfileService.updateExchangePreference(userId, productId)
    
    // 2. 更新推荐算法
    await RecommendationService.updateRecommendations(userId)
    
    // 3. 发送兑换成功通知
    await NotificationService.sendExchangeSuccessNotification(userId, productId)
  }
}
```

---

## 📱 前端架构整合

### 小程序页面结构扩展

```json
// app.json 扩展
{
  "pages": [
    // 现有页面
    "pages/points/index",
    "pages/payment/index", 
    "pages/payment/history",
    "pages/points/history",
    "pages/profile/index",
    
    // 新增商城页面
    "pages/mall/index",
    "pages/mall/category",
    "pages/mall/product-detail",
    "pages/mall/exchange-confirm",
    "pages/mall/exchange-success",
    "pages/mall/order-list",
    "pages/mall/order-detail"
  ],
  "subPackages": [
    {
      "root": "mall-package",
      "name": "mall",
      "pages": [
        "pages/index",
        "pages/category", 
        "pages/product-detail",
        "pages/exchange-confirm",
        "pages/exchange-success",
        "pages/order-list",
        "pages/order-detail"
      ]
    }
  ],
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/points/index",
        "text": "积分"
      },
      {
        "pagePath": "pages/mall/index", 
        "text": "商城"
      },
      {
        "pagePath": "pages/profile/index",
        "text": "我的"
      }
    ]
  }
}
```

### 支付页面商城功能整合

修改现有支付页面，添加商城预告功能：

```javascript
// pages/payment/index.js 扩展
Page({
  data: {
    // 现有数据...
    
    // 商城相关数据
    recommendedProducts: [],
    showMallPreview: false,
    mallPreviewLoading: false
  },

  async onLoad(options) {
    // 现有逻辑...
    
    // 加载商城推荐商品
    await this.loadMallRecommendations()
  },

  /**
   * 加载商城推荐商品
   */
  async loadMallRecommendations() {
    try {
      this.setData({ mallPreviewLoading: true })
      
      const userPoints = await PointsService.getPointsBalance()
      const expectedPoints = Math.floor(this.data.amount / 100)
      
      const recommendations = await MallService.getPaymentRecommendations({
        currentPoints: userPoints.balance,
        expectedPoints: expectedPoints,
        limit: 3
      })
      
      this.setData({
        recommendedProducts: recommendations,
        showMallPreview: recommendations.length > 0,
        mallPreviewLoading: false
      })
    } catch (error) {
      console.error('加载商城推荐失败:', error)
      this.setData({ mallPreviewLoading: false })
    }
  },

  /**
   * 跳转到商城
   */
  navigateToMall() {
    wx.navigateTo({
      url: `/mall-package/pages/index/index?source=payment_preview&expected_points=${Math.floor(this.data.amount / 100)}`
    })
  },

  /**
   * 查看推荐商品详情
   */
  viewProductDetail(e) {
    const productId = e.currentTarget.dataset.productId
    wx.navigateTo({
      url: `/mall-package/pages/product-detail/index?id=${productId}&source=payment_preview`
    })
  }
})
```

---

## 🔌 API接口设计

### 商城服务API接口

```typescript
// 商城相关API接口
const MallAPIRoutes = {
  // 商品相关
  'GET /api/mall/products': 'ProductController.getProducts',
  'GET /api/mall/products/:id': 'ProductController.getProductDetail', 
  'GET /api/mall/categories': 'ProductController.getCategories',
  'GET /api/mall/search': 'ProductController.searchProducts',
  
  // 推荐相关
  'GET /api/mall/recommendations': 'RecommendationController.getRecommendations',
  'POST /api/mall/recommendations/refresh': 'RecommendationController.refreshRecommendations',
  
  // 兑换相关
  'POST /api/mall/exchange': 'ExchangeController.createExchange',
  'GET /api/mall/exchange/orders': 'ExchangeController.getExchangeOrders',
  'GET /api/mall/exchange/orders/:id': 'ExchangeController.getExchangeOrderDetail',
  'POST /api/mall/exchange/orders/:id/cancel': 'ExchangeController.cancelExchange',
  
  // 库存相关
  'GET /api/mall/inventory/:productId': 'InventoryController.getStock',
  'POST /api/mall/inventory/check': 'InventoryController.checkMultipleStock'
}
```

### 接口数据格式

```typescript
// 商品信息接口
interface ProductResponse {
  id: string
  name: string
  description: string
  category: {
    id: string
    name: string
  }
  pointsPrice: number
  originalPrice: number
  images: string[]
  specifications: any
  stockQuantity: number
  salesCount: number
  isHot: boolean
  isNew: boolean
  status: number
}

// 兑换订单接口
interface ExchangeOrderResponse {
  id: string
  orderNo: string
  userId: string
  product: ProductResponse
  quantity: number
  pointsCost: number
  status: ExchangeOrderStatus
  deliveryInfo: {
    receiverName: string
    receiverPhone: string
    address: string
    trackingNo?: string
  }
  exchangedAt?: Date
  estimatedDelivery?: Date
  deliveredAt?: Date
}
```

---

## 🚀 部署和集成策略

### 1. 分阶段实施计划

#### Phase 1: 基础架构搭建 (Week 1-2)
- [ ] 商城微服务框架搭建
- [ ] 数据库表结构创建
- [ ] 基础API接口开发
- [ ] 前端商城页面基础框架

#### Phase 2: 核心功能开发 (Week 3-4)  
- [ ] 商品管理功能完成
- [ ] 兑换流程完整实现
- [ ] 库存管理系统
- [ ] 推荐算法初版

#### Phase 3: 系统整合 (Week 5-6)
- [ ] 支付页面商城功能集成
- [ ] 积分服务商城消费对接
- [ ] 用户状态统一管理
- [ ] 跨服务事件通信

#### Phase 4: 优化上线 (Week 7-8)
- [ ] 性能优化和压力测试
- [ ] UI/UX优化完善
- [ ] 监控和日志完善
- [ ] 生产环境部署

### 2. 技术风险控制

#### 数据一致性保证
```typescript
// 分布式事务管理
class DistributedTransaction {
  async executeExchangeTransaction(exchangeData: ExchangeTransactionData) {
    const sagaSteps = [
      // Step 1: 检查积分余额
      {
        service: 'PointsService',
        action: 'checkBalance',
        compensate: null
      },
      // Step 2: 检查库存
      {
        service: 'InventoryService', 
        action: 'checkAndReserveStock',
        compensate: 'releaseStock'
      },
      // Step 3: 扣减积分
      {
        service: 'PointsService',
        action: 'consumePoints',
        compensate: 'refundPoints'
      },
      // Step 4: 创建兑换订单
      {
        service: 'ExchangeService',
        action: 'createOrder',
        compensate: 'cancelOrder'
      }
    ]
    
    return await this.executeSaga(sagaSteps, exchangeData)
  }
}
```

### 3. 监控和运维

#### 新增监控指标
```typescript
const MallServiceMetrics = {
  // 商城业务指标
  business: {
    productViewRate: '商品浏览率',
    exchangeConversionRate: '兑换转化率', 
    averageExchangeValue: '平均兑换积分',
    inventoryTurnover: '库存周转率',
    userReturnRate: '用户回访率'
  },
  
  // 技术指标
  technical: {
    apiResponseTime: 'API响应时间',
    serviceAvailability: '服务可用性',
    databasePerformance: '数据库性能',
    cacheHitRate: '缓存命中率'
  }
}
```

---

## 💻 实施建议

### 即时行动方案

1. **立即开始基础架构搭建**
   - 在现有backend目录下创建商城服务模块
   - 复用现有的数据库连接和配置
   - 扩展现有的JWT认证体系

2. **前端分包优化**
   - 将商城功能作为独立分包
   - 保持主包轻量，提升加载速度
   - 复用现有的服务层和工具函数

3. **数据库平滑扩展**
   - 在现有数据库中新增商城相关表
   - 扩展现有积分记录表支持商城消费类型
   - 保持数据一致性和事务完整性

4. **API接口统一管理**
   - 复用现有的Express路由结构
   - 统一错误处理和参数验证
   - 保持接口风格一致性

### 技术决策建议

1. **不建议直接引入追格源码**
   - 技术栈可能不匹配
   - 代码风格差异较大
   - 安全和质量难以保证

2. **建议自主开发商城功能**
   - 完全贴合现有架构
   - 保证代码质量和安全性
   - 便于后续维护和扩展

3. **可参考追格的业务逻辑**
   - 学习其商城功能设计
   - 借鉴用户体验优化
   - 参考推荐算法思路

---

## 📋 总结和下一步行动

### 核心优势
1. **架构兼容**：完全基于现有技术栈扩展
2. **开发效率**：复用现有基础设施和工具
3. **数据统一**：共享用户和积分体系
4. **体验连贯**：支付与商城无缝对接

### 立即行动项
1. 创建商城微服务基础框架
2. 设计商城数据表结构
3. 开发核心商城API接口
4. 搭建前端商城页面框架

这个方案确保了商城功能与现有系统的完美融合，既保持了架构的一致性，又为业务扩展提供了坚实基础。

您觉得这个整合方案如何？是否需要我立即开始实施某个具体模块？
