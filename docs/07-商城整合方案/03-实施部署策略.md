# å•†åŸåŠŸèƒ½å®æ–½éƒ¨ç½²ç­–ç•¥

## ğŸ“– æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ24æ—¥
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ
- **è¯„å®¡çŠ¶æ€**ï¼šå¾…è¯„å®¡

---

## ğŸš€ åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„å‡†å¤‡ (ç¬¬1-2å‘¨)

#### åç«¯æ¶æ„æ‰©å±•
```bash
# åˆ›å»ºå•†åŸæœåŠ¡ç›®å½•ç»“æ„
backend/src/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ MallController.ts          # æ–°å¢
â”‚   â”œâ”€â”€ ProductController.ts       # æ–°å¢
â”‚   â”œâ”€â”€ ExchangeController.ts      # æ–°å¢
â”‚   â””â”€â”€ InventoryController.ts     # æ–°å¢
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ MallService.ts             # æ–°å¢
â”‚   â”œâ”€â”€ ProductService.ts          # æ–°å¢
â”‚   â”œâ”€â”€ ExchangeService.ts         # æ–°å¢
â”‚   â”œâ”€â”€ InventoryService.ts        # æ–°å¢
â”‚   â””â”€â”€ RecommendationService.ts   # æ–°å¢
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ Product.ts                 # æ–°å¢
â”‚   â”œâ”€â”€ ProductCategory.ts         # æ–°å¢
â”‚   â”œâ”€â”€ ExchangeOrder.ts           # æ–°å¢
â”‚   â””â”€â”€ InventoryRecord.ts         # æ–°å¢
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ mall.ts                    # æ–°å¢
â”‚   â”œâ”€â”€ products.ts                # æ–°å¢
â”‚   â””â”€â”€ exchange.ts                # æ–°å¢
â””â”€â”€ middleware/
    â””â”€â”€ mallAuth.ts                # æ–°å¢å•†åŸæƒé™ä¸­é—´ä»¶
```

#### æ•°æ®åº“è¿ç§»è„šæœ¬
```sql
-- 001_create_mall_tables.sql
-- å•†å“åˆ†ç±»è¡¨
CREATE TABLE product_categories (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(500),
  parent_id VARCHAR(36),
  level INT DEFAULT 1,
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_parent_id (parent_id),
  INDEX idx_level (level),
  INDEX idx_sort_order (sort_order),
  INDEX idx_status (status)
);

-- å•†å“è¡¨
CREATE TABLE products (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category_id VARCHAR(36) NOT NULL,
  points_price INT NOT NULL,
  original_price DECIMAL(10,2),
  stock_quantity INT DEFAULT 0,
  sales_count INT DEFAULT 0,
  images JSON,
  specifications JSON,
  is_hot BOOLEAN DEFAULT FALSE,
  is_new BOOLEAN DEFAULT FALSE,
  status TINYINT DEFAULT 1,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_category_id (category_id),
  INDEX idx_points_price (points_price),
  INDEX idx_status (status),
  INDEX idx_is_hot (is_hot),
  INDEX idx_is_new (is_new),
  INDEX idx_sales_count (sales_count),
  INDEX idx_sort_order (sort_order)
);

-- å…‘æ¢è®¢å•è¡¨
CREATE TABLE exchange_orders (
  id VARCHAR(36) PRIMARY KEY,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36) NOT NULL,
  product_snapshot JSON NOT NULL,
  quantity INT NOT NULL,
  points_cost INT NOT NULL,
  status TINYINT DEFAULT 0, -- 0:å¾…ç¡®è®¤ 1:å·²ç¡®è®¤ 2:å·²å‘è´§ 3:å·²å®Œæˆ -1:å·²å–æ¶ˆ
  delivery_info JSON,
  tracking_no VARCHAR(100),
  delivery_status TINYINT DEFAULT 0,
  exchanged_at TIMESTAMP NULL,
  shipped_at TIMESTAMP NULL,
  delivered_at TIMESTAMP NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_product_id (product_id),
  INDEX idx_status (status),
  INDEX idx_expires_at (expires_at),
  INDEX idx_created_at (created_at)
);

-- åº“å­˜è®°å½•è¡¨
CREATE TABLE inventory_records (
  id VARCHAR(36) PRIMARY KEY,
  product_id VARCHAR(36) NOT NULL,
  change_type TINYINT NOT NULL, -- 1:å…¥åº“ 2:å‡ºåº“ 3:é¢„ç•™ 4:é‡Šæ”¾ 5:è°ƒæ•´
  quantity_change INT NOT NULL,
  stock_before INT NOT NULL,
  stock_after INT NOT NULL,
  related_order_id VARCHAR(36),
  operator_id VARCHAR(36),
  description VARCHAR(200),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_change_type (change_type),
  INDEX idx_related_order_id (related_order_id),
  INDEX idx_created_at (created_at)
);

-- ç”¨æˆ·æ¨èåå¥½è¡¨
CREATE TABLE user_preferences (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  category_preferences JSON, -- åˆ†ç±»åå¥½æƒé‡
  price_sensitivity DECIMAL(3,2), -- ä»·æ ¼æ•æ„Ÿåº¦ 0-1
  brand_preferences JSON, -- å“ç‰Œåå¥½
  browsing_history JSON, -- æµè§ˆå†å²
  exchange_history JSON, -- å…‘æ¢å†å²åˆ†æ
  last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_user_id (user_id),
  INDEX idx_last_updated (last_updated)
);
```

### Phase 2: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ (ç¬¬3-4å‘¨)

#### å¼€å‘ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**ï¼šå•†å“ç®¡ç†ã€å…‘æ¢æµç¨‹ã€åº“å­˜ç®¡ç†
2. **ä¸­ä¼˜å…ˆçº§**ï¼šæ¨èç³»ç»Ÿã€ç”¨æˆ·åå¥½åˆ†æ
3. **ä½ä¼˜å…ˆçº§**ï¼šé«˜çº§åŠŸèƒ½ã€æ•°æ®åˆ†æã€è¿è¥å·¥å…·

#### å¼€å‘æ£€æŸ¥ç‚¹
```typescript
// æ¯æ—¥å¼€å‘æ£€æŸ¥æ¸…å•
const DevelopmentChecklist = {
  week3: {
    day1: ['å•†å“æ¨¡å‹å®Œæˆ', 'å•†å“CRUDæ¥å£', 'åŸºç¡€æµ‹è¯•ç”¨ä¾‹'],
    day2: ['å•†å“åˆ†ç±»åŠŸèƒ½', 'åº“å­˜ç®¡ç†åŸºç¡€', 'æ•°æ®åº“è¿æ¥æµ‹è¯•'],
    day3: ['å…‘æ¢æœåŠ¡æ¡†æ¶', 'ç§¯åˆ†æ‰£å‡å¯¹æ¥', 'äº‹åŠ¡å¤„ç†'],
    day4: ['å‰ç«¯å•†å“åˆ—è¡¨é¡µ', 'å•†å“è¯¦æƒ…é¡µ', 'åŸºç¡€æ ·å¼'],
    day5: ['å…‘æ¢ç¡®è®¤é¡µé¢', 'è®¢å•åˆ—è¡¨é¡µ', 'çŠ¶æ€ç®¡ç†']
  },
  week4: {
    day1: ['æ¨èç®—æ³•åŸºç¡€ç‰ˆ', 'ç”¨æˆ·åå¥½æ”¶é›†', 'A/Bæµ‹è¯•æ¡†æ¶'],
    day2: ['åº“å­˜é¢„è­¦ç³»ç»Ÿ', 'è‡ªåŠ¨é‡Šæ”¾æœºåˆ¶', 'å¼‚å¸¸å¤„ç†'],
    day3: ['å‰ç«¯å•†åŸé¦–é¡µ', 'æ¨èå±•ç¤º', 'æœç´¢åŠŸèƒ½'],
    day4: ['å…‘æ¢æµç¨‹é›†æˆæµ‹è¯•', 'æ”¯ä»˜é¡µé¢æ”¹é€ ', 'çŠ¶æ€åŒæ­¥'],
    day5: ['æ€§èƒ½ä¼˜åŒ–', 'ç¼“å­˜ç­–ç•¥', 'é”™è¯¯å¤„ç†å®Œå–„']
  }
}
```

### Phase 3: ç³»ç»Ÿæ•´åˆ (ç¬¬5-6å‘¨)

#### æ•´åˆæµ‹è¯•ç­–ç•¥
```typescript
// é›†æˆæµ‹è¯•ç”¨ä¾‹
const IntegrationTestCases = [
  {
    name: 'å®Œæ•´å…‘æ¢æµç¨‹æµ‹è¯•',
    steps: [
      'ç”¨æˆ·ç™»å½•',
      'æŸ¥çœ‹å•†å“åˆ—è¡¨',
      'é€‰æ‹©å•†å“',
      'ç¡®è®¤å…‘æ¢',
      'ç§¯åˆ†æ‰£å‡',
      'åº“å­˜æ‰£å‡', 
      'è®¢å•åˆ›å»º',
      'å‘è´§å¤„ç†',
      'è®¢å•å®Œæˆ'
    ],
    expectedResult: 'æ•´ä¸ªæµç¨‹æ— é”™è¯¯ï¼Œæ•°æ®ä¸€è‡´æ€§æ­£ç¡®'
  },
  {
    name: 'å¹¶å‘å…‘æ¢æµ‹è¯•',
    steps: [
      'æ¨¡æ‹Ÿ100ä¸ªç”¨æˆ·åŒæ—¶å…‘æ¢åŒä¸€å•†å“',
      'æ£€æŸ¥åº“å­˜æ‰£å‡æ­£ç¡®æ€§',
      'æ£€æŸ¥ç§¯åˆ†æ‰£å‡å‡†ç¡®æ€§',
      'æ£€æŸ¥è¶…å–æƒ…å†µ'
    ],
    expectedResult: 'æ— è¶…å–ï¼Œæ— ç§¯åˆ†å¼‚å¸¸æ‰£å‡'
  },
  {
    name: 'æœåŠ¡æ•…éšœæ¢å¤æµ‹è¯•',
    steps: [
      'æ¨¡æ‹Ÿç§¯åˆ†æœåŠ¡æ•…éšœ',
      'æ£€æŸ¥å…‘æ¢æµç¨‹é™çº§',
      'æœåŠ¡æ¢å¤åæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§'
    ],
    expectedResult: 'é™çº§æ­£å¸¸ï¼Œæ¢å¤åæ•°æ®ä¸€è‡´'
  }
]
```

---

## ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. å®¹å™¨åŒ–éƒ¨ç½²

#### Dockeré…ç½®æ–‡ä»¶
```dockerfile
# Dockerfile.mall-service
FROM node:18-alpine

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production --silent

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

#### Kuberneteséƒ¨ç½²é…ç½®
```yaml
# k8s/mall-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mall-service
  labels:
    app: mall-service
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mall-service
  template:
    metadata:
      labels:
        app: mall-service
    spec:
      containers:
      - name: mall-service
        image: mall-service:v1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: host
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: host
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: mall-service
spec:
  selector:
    app: mall-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP
```

### 2. ç›‘æ§å’Œæ—¥å¿—é…ç½®

#### Prometheusç›‘æ§é…ç½®
```yaml
# prometheus/mall-service-config.yml
global:
  scrape_interval: 15s

scrape_configs:
- job_name: 'mall-service'
  static_configs:
  - targets: ['mall-service:3000']
  metrics_path: /metrics
  scrape_interval: 10s

rule_files:
- "mall-service-alerts.yml"

alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager:9093
```

#### æ—¥å¿—æ”¶é›†é…ç½®
```yaml
# filebeat/mall-service-config.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /app/logs/mall-service-*.log
  fields:
    service: mall-service
    environment: production
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "mall-service-%{+yyyy.MM.dd}"

processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
```

---

## ğŸ”„ æ•°æ®è¿ç§»ç­–ç•¥

### 1. ç°æœ‰æ•°æ®æ‰©å±•

#### ç§¯åˆ†è®°å½•è¡¨æ‰©å±•
```sql
-- ä¸ºç°æœ‰ç§¯åˆ†è®°å½•è¡¨æ·»åŠ å•†åŸæ¶ˆè´¹æ”¯æŒ
ALTER TABLE points_records 
ADD COLUMN exchange_order_id VARCHAR(36) AFTER order_id,
ADD INDEX idx_exchange_order_id (exchange_order_id);

-- æ›´æ–°sourceå­—æ®µæšä¸¾å€¼
ALTER TABLE points_records 
MODIFY COLUMN source ENUM(
  'payment_reward',     -- ç°æœ‰ï¼šæ”¯ä»˜å¥–åŠ±
  'admin_adjust',       -- ç°æœ‰ï¼šç®¡ç†å‘˜è°ƒæ•´  
  'mall_consumption',   -- æ–°å¢ï¼šå•†åŸæ¶ˆè´¹
  'mall_refund',        -- æ–°å¢ï¼šå•†åŸé€€æ¬¾
  'expire_deduct',      -- ç°æœ‰ï¼šè¿‡æœŸæ‰£å‡
  'invite_reward'       -- é¢„ç•™ï¼šé‚€è¯·å¥–åŠ±
) DEFAULT 'payment_reward';
```

#### ç”¨æˆ·è¡¨æ‰©å±•
```sql
-- ä¸ºç”¨æˆ·è¡¨æ·»åŠ å•†åŸç›¸å…³å­—æ®µ
ALTER TABLE users
ADD COLUMN mall_level TINYINT DEFAULT 1 COMMENT 'å•†åŸä¼šå‘˜ç­‰çº§',
ADD COLUMN last_exchange_at TIMESTAMP NULL COMMENT 'æœ€åå…‘æ¢æ—¶é—´',
ADD COLUMN total_exchanges INT DEFAULT 0 COMMENT 'æ€»å…‘æ¢æ¬¡æ•°',
ADD COLUMN favorite_categories JSON COMMENT 'æ”¶è—åˆ†ç±»',
ADD INDEX idx_mall_level (mall_level),
ADD INDEX idx_last_exchange_at (last_exchange_at);
```

### 2. åˆå§‹åŒ–æ•°æ®

#### åŸºç¡€å•†å“åˆ†ç±»æ•°æ®
```sql
-- åˆå§‹åŒ–å•†å“åˆ†ç±»
INSERT INTO product_categories (id, name, description, icon, level, sort_order) VALUES
('cat_digital', 'æ•°ç äº§å“', 'æ‰‹æœºã€ç”µè„‘ã€æ™ºèƒ½è®¾å¤‡', '/icons/digital.png', 1, 1),
('cat_food', 'ç¾é£Ÿä¼˜æƒ ', 'é¤é¥®åˆ¸ã€é›¶é£Ÿã€ç‰¹äº§', '/icons/food.png', 1, 2),
('cat_life', 'ç”Ÿæ´»ç”¨å“', 'æ—¥ç”¨å“ã€å®¶å±…ã€ä¸ªæŠ¤', '/icons/life.png', 1, 3),
('cat_entertainment', 'å¨±ä¹æœåŠ¡', 'ç”µå½±ç¥¨ã€æ¸¸æˆã€ä¼šå‘˜', '/icons/entertainment.png', 1, 4),
('cat_travel', 'å‡ºè¡ŒæœåŠ¡', 'æ‰“è½¦åˆ¸ã€åŠ æ²¹å¡ã€æ—…æ¸¸', '/icons/travel.png', 1, 5);

-- äºŒçº§åˆ†ç±»
INSERT INTO product_categories (id, name, description, parent_id, level, sort_order) VALUES
('cat_mobile', 'æ‰‹æœºé€šè®¯', 'æ™ºèƒ½æ‰‹æœºã€é…ä»¶', 'cat_digital', 2, 1),
('cat_computer', 'ç”µè„‘åŠå…¬', 'ç¬”è®°æœ¬ã€å°å¼æœºã€é…ä»¶', 'cat_digital', 2, 2),
('cat_snack', 'ä¼‘é—²é›¶é£Ÿ', 'åšæœã€é¥¼å¹²ã€ç³–æœ', 'cat_food', 2, 1),
('cat_beverage', 'é¥®å“èŒ¶é¥®', 'å’–å•¡ã€èŒ¶å¶ã€é¥®æ–™', 'cat_food', 2, 2);
```

#### æ¼”ç¤ºå•†å“æ•°æ®
```sql
-- åˆå§‹åŒ–æ¼”ç¤ºå•†å“
INSERT INTO products (id, name, description, category_id, points_price, original_price, stock_quantity, is_hot, is_new) VALUES
('prod_iphone15', 'iPhone 15 Pro 256GB', 'æœ€æ–°æ¬¾iPhone 15 Pro', 'cat_mobile', 999900, 9999.00, 10, true, true),
('prod_airpods', 'AirPods Pro 2', 'ä¸»åŠ¨é™å™ªæ— çº¿è€³æœº', 'cat_mobile', 189900, 1899.00, 50, true, false),
('prod_starbucks', 'æ˜Ÿå·´å…‹å¤§æ¯æ‹¿é“åˆ¸', 'å…¨å›½é—¨åº—é€šç”¨', 'cat_beverage', 3500, 35.00, 1000, false, false),
('prod_kfc', 'KFCå…¨å®¶æ¡¶åˆ¸', '9å—é¸¡+è–¯æ¡+å¯ä¹', 'cat_food', 8900, 89.00, 500, true, false),
('prod_movie', 'ç”µå½±ç¥¨é€šç”¨åˆ¸', 'å…¨å›½å½±é™¢é€šç”¨', 'cat_entertainment', 4500, 45.00, 2000, false, true);
```

---

## ğŸ”§ æŠ€æœ¯å®æ–½ç»†èŠ‚

### 1. ç°æœ‰æœåŠ¡æ‰©å±•

#### ç§¯åˆ†æœåŠ¡æ‰©å±• (PointsService.ts)
```typescript
// åœ¨ç°æœ‰PointsServiceåŸºç¡€ä¸Šæ·»åŠ å•†åŸåŠŸèƒ½
export class PointsService {
  // ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜...

  /**
   * å•†åŸå…‘æ¢ç§¯åˆ†æ£€æŸ¥
   */
  static async checkExchangeEligibility(
    userId: string, 
    pointsRequired: number
  ): Promise<{
    eligible: boolean
    currentBalance: number
    shortage: number
  }> {
    const balance = await this.getUserPointsBalance(userId)
    
    return {
      eligible: balance.balance >= pointsRequired,
      currentBalance: balance.balance,
      shortage: Math.max(0, pointsRequired - balance.balance)
    }
  }

  /**
   * å•†åŸå…‘æ¢ç§¯åˆ†æ‰£å‡
   */
  static async exchangePointsDeduction(
    userId: string,
    pointsCost: number,
    productId: string,
    exchangeOrderId: string
  ): Promise<void> {
    await this.consumePoints(
      userId,
      pointsCost,
      `å•†åŸå…‘æ¢-${productId}`,
      exchangeOrderId
    )
  }

  /**
   * å…‘æ¢é€€æ¬¾ç§¯åˆ†è¿”è¿˜
   */
  static async refundExchangePoints(
    userId: string,
    pointsToRefund: number,
    exchangeOrderId: string,
    reason: string
  ): Promise<void> {
    await this.awardPoints(
      userId,
      pointsToRefund,
      'mall_refund',
      `å…‘æ¢é€€æ¬¾-${reason}`,
      exchangeOrderId
    )
  }
}
```

### 2. æ–°æœåŠ¡å®ç°

#### å•†å“æœåŠ¡å®ç°
```typescript
// backend/src/services/ProductService.ts
export class ProductService {
  /**
   * è·å–å•†å“åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰å’Œåˆ†é¡µï¼‰
   */
  static async getProducts(filters: ProductFilters): Promise<ProductListResult> {
    const {
      categoryId,
      keyword,
      minPoints,
      maxPoints,
      isHot,
      isNew,
      page = 1,
      pageSize = 20
    } = filters

    let query = `
      SELECT p.*, c.name as category_name, c.icon as category_icon
      FROM products p
      LEFT JOIN product_categories c ON p.category_id = c.id
      WHERE p.status = 1
    `
    const params: any[] = []

    // åŠ¨æ€æ„å»ºæŸ¥è¯¢æ¡ä»¶
    if (categoryId) {
      query += ' AND p.category_id = ?'
      params.push(categoryId)
    }

    if (keyword) {
      query += ' AND (p.name LIKE ? OR p.description LIKE ?)'
      params.push(`%${keyword}%`, `%${keyword}%`)
    }

    if (minPoints !== undefined) {
      query += ' AND p.points_price >= ?'
      params.push(minPoints)
    }

    if (maxPoints !== undefined) {
      query += ' AND p.points_price <= ?'
      params.push(maxPoints)
    }

    if (isHot !== undefined) {
      query += ' AND p.is_hot = ?'
      params.push(isHot)
    }

    if (isNew !== undefined) {
      query += ' AND p.is_new = ?'
      params.push(isNew)
    }

    // æ’åºå’Œåˆ†é¡µ
    query += ' ORDER BY p.sort_order DESC, p.sales_count DESC, p.created_at DESC'
    query += ' LIMIT ? OFFSET ?'
    params.push(pageSize, (page - 1) * pageSize)

    const [products, totalCount] = await Promise.all([
      DatabaseConnection.query(query, params),
      this.getProductsCount(filters)
    ])

    return {
      products: products.map(this.formatProductData),
      pagination: {
        page,
        pageSize,
        total: totalCount,
        totalPages: Math.ceil(totalCount / pageSize)
      }
    }
  }

  /**
   * è·å–å•†å“è¯¦æƒ…
   */
  static async getProductDetail(productId: string): Promise<ProductDetail | null> {
    const query = `
      SELECT p.*, c.name as category_name, c.icon as category_icon
      FROM products p
      LEFT JOIN product_categories c ON p.category_id = c.id
      WHERE p.id = ? AND p.status = 1
    `

    const [products] = await DatabaseConnection.query(query, [productId])
    
    if (!products.length) {
      return null
    }

    const product = this.formatProductData(products[0])

    // è·å–åº“å­˜ä¿¡æ¯
    const stockInfo = await InventoryService.getStockLevel(productId)
    product.stockInfo = stockInfo

    // è®°å½•æµè§ˆå†å²ï¼ˆå¼‚æ­¥ï¼‰
    this.recordProductView(productId).catch(console.error)

    return product
  }
}
```

### 3. å‰ç«¯å®ç°

#### å•†åŸé¦–é¡µå®ç°
```javascript
// mall-package/pages/index/index.js
import { MallService } from '../../../services/mall.js'
import { PointsService } from '../../../services/points.js'

Page({
  data: {
    userPoints: 0,
    categories: [],
    recommendedProducts: [],
    hotProducts: [],
    newProducts: [],
    loading: true,
    refreshing: false
  },

  async onLoad(options) {
    // è·å–æ¥æºä¿¡æ¯
    const source = options.source || 'direct'
    const expectedPoints = parseInt(options.expected_points) || 0
    
    console.log('å•†åŸé¡µé¢åŠ è½½:', { source, expectedPoints })
    
    await this.initializePage(source, expectedPoints)
  },

  async initializePage(source, expectedPoints) {
    try {
      this.setData({ loading: true })

      // å¹¶è¡ŒåŠ è½½æ•°æ®
      const [pointsBalance, categories, recommendations] = await Promise.all([
        PointsService.getPointsBalance(),
        MallService.getCategories(),
        MallService.getRecommendations({
          source,
          expectedPoints,
          limit: 6
        })
      ])

      this.setData({
        userPoints: pointsBalance.balance,
        categories: categories.slice(0, 8), // æ˜¾ç¤ºå‰8ä¸ªåˆ†ç±»
        recommendedProducts: recommendations.affordable || [],
        loading: false
      })

      // åŠ è½½çƒ­é—¨å’Œæ–°å“ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
      this.loadSecondaryData()

    } catch (error) {
      console.error('å•†åŸé¡µé¢åˆå§‹åŒ–å¤±è´¥:', error)
      this.setData({ loading: false })
      
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    }
  },

  async loadSecondaryData() {
    try {
      const [hotProducts, newProducts] = await Promise.all([
        MallService.getProducts({ isHot: true, pageSize: 4 }),
        MallService.getProducts({ isNew: true, pageSize: 4 })
      ])

      this.setData({
        hotProducts: hotProducts.products,
        newProducts: newProducts.products
      })
    } catch (error) {
      console.error('åŠ è½½æ¬¡è¦æ•°æ®å¤±è´¥:', error)
    }
  },

  // è·³è½¬åˆ°å•†å“è¯¦æƒ…
  navigateToProduct(e) {
    const productId = e.currentTarget.dataset.productId
    wx.navigateTo({
      url: `../product-detail/index?id=${productId}`
    })
  },

  // è·³è½¬åˆ°åˆ†ç±»é¡µé¢
  navigateToCategory(e) {
    const categoryId = e.currentTarget.dataset.categoryId
    wx.navigateTo({
      url: `../category/index?id=${categoryId}`
    })
  },

  // ä¸‹æ‹‰åˆ·æ–°
  async onPullDownRefresh() {
    this.setData({ refreshing: true })
    await this.initializePage('refresh', 0)
    this.setData({ refreshing: false })
    wx.stopPullDownRefresh()
  }
})
```

---

## ğŸ¯ éƒ¨ç½²æµæ°´çº¿

### 1. CI/CDé…ç½®

#### GitHub Actionsé…ç½®
```yaml
# .github/workflows/mall-service-deploy.yml
name: Mall Service Deploy

on:
  push:
    branches: [ main ]
    paths: [ 'backend/**', 'mall-package/**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'
    
    - name: Install dependencies
      run: cd backend && npm ci
    
    - name: Run tests
      run: cd backend && npm test
    
    - name: Run linting
      run: cd backend && npm run lint

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t mall-service:${{ github.sha }} -f backend/Dockerfile.mall backend/
    
    - name: Deploy to production
      run: |
        kubectl set image deployment/mall-service mall-service=mall-service:${{ github.sha }}
        kubectl rollout status deployment/mall-service
```

### 2. è“ç»¿éƒ¨ç½²ç­–ç•¥

#### éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# scripts/deploy-mall-service.sh

set -e

VERSION=$1
ENVIRONMENT=${2:-production}

echo "ğŸš€ å¼€å§‹éƒ¨ç½²å•†åŸæœåŠ¡ - ç‰ˆæœ¬: $VERSION"

# 1. æ„å»ºæ–°ç‰ˆæœ¬é•œåƒ
echo "ğŸ“¦ æ„å»ºDockeré•œåƒ..."
docker build -t mall-service:$VERSION -f backend/Dockerfile.mall backend/

# 2. æ¨é€åˆ°é•œåƒä»“åº“
echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
docker tag mall-service:$VERSION registry.example.com/mall-service:$VERSION
docker push registry.example.com/mall-service:$VERSION

# 3. æ›´æ–°Kuberneteséƒ¨ç½²
echo "ğŸ”„ æ›´æ–°Kuberneteséƒ¨ç½²..."
kubectl set image deployment/mall-service-green mall-service=registry.example.com/mall-service:$VERSION

# 4. ç­‰å¾…éƒ¨ç½²å®Œæˆ
echo "â³ ç­‰å¾…æ–°ç‰ˆæœ¬å°±ç»ª..."
kubectl rollout status deployment/mall-service-green --timeout=300s

# 5. å¥åº·æ£€æŸ¥
echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
HEALTH_CHECK_URL="http://mall-service-green/health"
for i in {1..10}; do
  if curl -f $HEALTH_CHECK_URL; then
    echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
    break
  fi
  if [ $i -eq 10 ]; then
    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»šéƒ¨ç½²"
    kubectl rollout undo deployment/mall-service-green
    exit 1
  fi
  sleep 10
done

# 6. åˆ‡æ¢æµé‡
echo "ğŸ”€ åˆ‡æ¢ç”Ÿäº§æµé‡..."
kubectl patch service mall-service -p '{"spec":{"selector":{"version":"green"}}}'

# 7. éªŒè¯æ–°ç‰ˆæœ¬
echo "ğŸ§ª éªŒè¯æ–°ç‰ˆæœ¬åŠŸèƒ½..."
./scripts/verify-mall-service.sh

echo "ğŸ‰ å•†åŸæœåŠ¡éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ“‹ éªŒæ”¶æµ‹è¯•æ¸…å•

### 1. åŠŸèƒ½æµ‹è¯•

#### è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹
```typescript
// __tests__/integration/mall-service.test.ts
describe('å•†åŸæœåŠ¡é›†æˆæµ‹è¯•', () => {
  beforeAll(async () => {
    await setupTestDatabase()
    await seedTestData()
  })

  describe('å•†å“ç®¡ç†', () => {
    test('åº”è¯¥èƒ½å¤Ÿè·å–å•†å“åˆ—è¡¨', async () => {
      const response = await request(app)
        .get('/api/mall/products')
        .expect(200)
      
      expect(response.body.success).toBe(true)
      expect(response.body.data.products).toBeInstanceOf(Array)
    })

    test('åº”è¯¥èƒ½å¤ŸæŒ‰åˆ†ç±»ç­›é€‰å•†å“', async () => {
      const response = await request(app)
        .get('/api/mall/products?category_id=cat_digital')
        .expect(200)
      
      expect(response.body.data.products.every(p => p.category.id === 'cat_digital')).toBe(true)
    })
  })

  describe('å…‘æ¢æµç¨‹', () => {
    test('åº”è¯¥èƒ½å¤ŸæˆåŠŸå…‘æ¢å•†å“', async () => {
      // 1. åˆ›å»ºå…‘æ¢è®¢å•
      const exchangeResponse = await request(app)
        .post('/api/mall/exchange')
        .send({
          productId: 'prod_starbucks',
          quantity: 1,
          deliveryInfo: testDeliveryInfo
        })
        .set('Authorization', `Bearer ${testUserToken}`)
        .expect(200)

      expect(exchangeResponse.body.success).toBe(true)
      
      // 2. éªŒè¯ç§¯åˆ†æ‰£å‡
      const pointsResponse = await request(app)
        .get('/api/points/balance')
        .set('Authorization', `Bearer ${testUserToken}`)
        .expect(200)

      expect(pointsResponse.body.data.balance).toBe(initialBalance - 3500)
      
      // 3. éªŒè¯åº“å­˜æ‰£å‡
      const productResponse = await request(app)
        .get('/api/mall/products/prod_starbucks')
        .expect(200)

      expect(productResponse.body.data.stockQuantity).toBe(initialStock - 1)
    })
  })
})
```

### 2. æ€§èƒ½æµ‹è¯•

#### å‹åŠ›æµ‹è¯•è„šæœ¬
```javascript
// performance-test/mall-load-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 10 },   // é¢„çƒ­
    { duration: '5m', target: 50 },   // æ­£å¸¸è´Ÿè½½
    { duration: '2m', target: 100 },  // å³°å€¼è´Ÿè½½
    { duration: '5m', target: 0 },    // ç¼“æ…¢é™çº§
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%è¯·æ±‚å“åº”æ—¶é—´<500ms
    http_req_failed: ['rate<0.01'],   // é”™è¯¯ç‡<1%
  },
};

export default function () {
  // æµ‹è¯•å•†å“åˆ—è¡¨æ¥å£
  let response = http.get('https://api.guandongfang.cn/api/mall/products');
  check(response, {
    'å•†å“åˆ—è¡¨å“åº”æˆåŠŸ': (r) => r.status === 200,
    'å“åº”æ—¶é—´æ­£å¸¸': (r) => r.timings.duration < 500,
  });

  // æµ‹è¯•å•†å“è¯¦æƒ…æ¥å£
  response = http.get('https://api.guandongfang.cn/api/mall/products/prod_starbucks');
  check(response, {
    'å•†å“è¯¦æƒ…å“åº”æˆåŠŸ': (r) => r.status === 200,
    'æ•°æ®å®Œæ•´æ€§': (r) => JSON.parse(r.body).data.id === 'prod_starbucks',
  });
}
```

---

## ğŸš¨ åº”æ€¥é¢„æ¡ˆ

### 1. æ•…éšœå¤„ç†é¢„æ¡ˆ

#### æœåŠ¡é™çº§ç­–ç•¥
```typescript
// å•†åŸæœåŠ¡é™çº§é…ç½®
const FallbackConfig = {
  productService: {
    // å•†å“æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥
    fallback: () => ({
      products: [],
      message: 'å•†å“æ•°æ®æ­£åœ¨æ›´æ–°ï¼Œè¯·ç¨åå†è¯•'
    }),
    enableCache: true,
    cacheTime: 300000 // 5åˆ†é’Ÿç¼“å­˜
  },
  
  recommendationService: {
    // æ¨èæœåŠ¡ä¸å¯ç”¨æ—¶æ˜¾ç¤ºçƒ­é—¨å•†å“
    fallback: async () => {
      const hotProducts = await ProductService.getProducts({ 
        isHot: true, 
        pageSize: 6 
      })
      return {
        type: 'hot',
        products: hotProducts.products,
        reason: 'ä¸ºæ‚¨æ¨èçƒ­é—¨å•†å“'
      }
    }
  },
  
  exchangeService: {
    // å…‘æ¢æœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤„ç†
    fallback: () => {
      throw new Error('å…‘æ¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•')
    },
    enableQueue: true, // å¯ç”¨è¯·æ±‚é˜Ÿåˆ—
    queueTimeout: 30000 // 30ç§’è¶…æ—¶
  }
}
```

### 2. æ•°æ®æ¢å¤é¢„æ¡ˆ

#### å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
```bash
#!/bin/bash
# scripts/backup-mall-data.sh

# æ•°æ®åº“å¤‡ä»½
echo "ğŸ“¦ å¼€å§‹å¤‡ä»½å•†åŸæ•°æ®..."

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mall-service/$BACKUP_DATE"

mkdir -p $BACKUP_DIR

# å¤‡ä»½å•†åŸç›¸å…³è¡¨
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD $DB_NAME \
  products product_categories exchange_orders inventory_records user_preferences \
  --single-transaction --routines --triggers \
  > $BACKUP_DIR/mall-tables.sql

# å¤‡ä»½Redisç¼“å­˜
redis-cli --rdb $BACKUP_DIR/mall-cache.rdb

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
tar -czf $BACKUP_DIR.tar.gz $BACKUP_DIR/

echo "âœ… å•†åŸæ•°æ®å¤‡ä»½å®Œæˆ: $BACKUP_DIR.tar.gz"
```

---

## ğŸ“Š ç›‘æ§æŠ¥è¡¨

### 1. ä¸šåŠ¡ç›‘æ§

#### å…³é”®æŒ‡æ ‡ä»ªè¡¨æ¿
```typescript
const MallDashboardMetrics = {
  realTime: {
    // å®æ—¶æŒ‡æ ‡
    activeUsers: 'å½“å‰åœ¨çº¿å•†åŸç”¨æˆ·æ•°',
    ongoingExchanges: 'è¿›è¡Œä¸­çš„å…‘æ¢è®¢å•',
    systemLoad: 'ç³»ç»Ÿè´Ÿè½½',
    errorRate: 'é”™è¯¯ç‡'
  },
  
  daily: {
    // æ—¥æŠ¥æŒ‡æ ‡
    totalExchanges: 'æ—¥å…‘æ¢è®¢å•æ•°',
    totalPointsConsumed: 'æ—¥ç§¯åˆ†æ¶ˆè´¹é‡',
    popularProducts: 'çƒ­é—¨å•†å“æ’è¡Œ',
    userEngagement: 'ç”¨æˆ·å‚ä¸åº¦'
  },
  
  weekly: {
    // å‘¨æŠ¥æŒ‡æ ‡
    conversionRate: 'æ”¯ä»˜åˆ°å…‘æ¢è½¬åŒ–ç‡',
    userRetention: 'ç”¨æˆ·ç•™å­˜ç‡',
    inventoryTurnover: 'åº“å­˜å‘¨è½¬ç‡',
    revenueImpact: 'æ”¶å…¥å½±å“åˆ†æ'
  }
}
```

### 2. è‡ªåŠ¨åŒ–æŠ¥å‘Š

#### æ¯æ—¥æŠ¥å‘Šç”Ÿæˆ
```typescript
class MallReportGenerator {
  async generateDailyReport(date: Date): Promise<DailyReport> {
    const dateStr = date.toISOString().split('T')[0]
    
    const metrics = await Promise.all([
      this.getExchangeMetrics(date),
      this.getProductMetrics(date),
      this.getUserMetrics(date),
      this.getSystemMetrics(date)
    ])

    const report: DailyReport = {
      date: dateStr,
      exchange: metrics[0],
      products: metrics[1], 
      users: metrics[2],
      system: metrics[3],
      recommendations: await this.generateRecommendations(metrics)
    }

    // å‘é€æŠ¥å‘Š
    await NotificationService.sendDailyReport(report)
    
    return report
  }
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å¼€å‘è§„èŒƒ

#### ä»£ç è§„èŒƒ
```typescript
// ç»Ÿä¸€çš„APIå“åº”æ ¼å¼
class APIResponseHelper {
  static success<T>(data: T, message = 'æ“ä½œæˆåŠŸ'): APIResponse<T> {
    return {
      success: true,
      code: 'SUCCESS',
      message,
      data,
      timestamp: Date.now()
    }
  }
  
  static error(code: string, message: string): APIResponse<null> {
    return {
      success: false,
      code,
      message,
      data: null,
      timestamp: Date.now()
    }
  }
}

// ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
class Logger {
  static logMallOperation(operation: string, userId: string, details: any) {
    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      service: 'mall-service',
      operation,
      userId,
      details,
      level: 'info'
    }))
  }
}
```

### 2. è¿ç»´è§„èŒƒ

#### æœåŠ¡å¥åº·æ£€æŸ¥
```typescript
// å•†åŸæœåŠ¡å¥åº·æ£€æŸ¥
app.get('/health', async (req, res) => {
  const healthChecks = await Promise.allSettled([
    checkDatabaseConnection(),
    checkRedisConnection(),
    checkDependentServices()
  ])
  
  const allHealthy = healthChecks.every(result => result.status === 'fulfilled')
  
  res.status(allHealthy ? 200 : 503).json({
    status: allHealthy ? 'healthy' : 'unhealthy',
    timestamp: new Date().toISOString(),
    checks: {
      database: healthChecks[0].status,
      redis: healthChecks[1].status,
      dependencies: healthChecks[2].status
    }
  })
})
```

---

## ğŸ“‹ æ€»ç»“

### å®æ–½æˆåŠŸå…³é”®å› ç´ 
1. **æ¸è¿›å¼è¿ç§»**ï¼šåˆ†é˜¶æ®µé€æ­¥å®æ–½ï¼Œé™ä½é£é™©
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šä¸¥æ ¼ä¿è¯è·¨æœåŠ¡æ•°æ®ä¸€è‡´æ€§
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜å’Œæ•°æ®åº“ä¼˜åŒ–
4. **ç›‘æ§å®Œå–„**ï¼šå…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
5. **åº”æ€¥å‡†å¤‡**ï¼šå®Œæ•´çš„æ•…éšœå¤„ç†å’Œæ¢å¤é¢„æ¡ˆ

### é£é™©æ§åˆ¶æªæ–½
1. **ä»£ç è´¨é‡**ï¼šä¸¥æ ¼çš„ä»£ç å®¡æŸ¥å’Œæµ‹è¯•è¦†ç›–
2. **éƒ¨ç½²å®‰å…¨**ï¼šè“ç»¿éƒ¨ç½²å’Œè‡ªåŠ¨å›æ»šæœºåˆ¶  
3. **æ•°æ®å®‰å…¨**ï¼šå®šæœŸå¤‡ä»½å’Œæƒé™æ§åˆ¶
4. **æœåŠ¡ç¨³å®š**ï¼šç†”æ–­é™çº§å’Œæ•…éšœéš”ç¦»

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. ç«‹å³å¼€å§‹Phase 1åŸºç¡€æ¶æ„æ­å»º
2. å¹¶è¡Œè¿›è¡Œæ•°æ®åº“è¡¨ç»“æ„åˆ›å»º
3. æ­å»ºåŸºç¡€çš„CI/CDæµæ°´çº¿
4. åˆ¶å®šè¯¦ç»†çš„æµ‹è¯•è®¡åˆ’

è¿™ä¸ªå®æ–½ç­–ç•¥ç¡®ä¿äº†å•†åŸåŠŸèƒ½çš„å¹³æ»‘é›†æˆï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

**æ–‡æ¡£çŠ¶æ€**ï¼šå¾…æŠ€æœ¯è¯„å®¡  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šå¼€å§‹æ¶æ„æ­å»º  
**è´£ä»»äºº**ï¼šæŠ€æœ¯å›¢é˜Ÿ  
**è¯„å®¡æ—¶é—´**ï¼šå¾…å®š

