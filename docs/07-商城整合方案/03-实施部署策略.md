# 商城功能实施部署策略

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月24日
- **技术负责人**：开发团队
- **评审状态**：待评审

---

## 🚀 分阶段实施计划

### Phase 1: 基础架构准备 (第1-2周)

#### 后端架构扩展
```bash
# 创建商城服务目录结构
backend/src/
├── controllers/
│   ├── MallController.ts          # 新增
│   ├── ProductController.ts       # 新增
│   ├── ExchangeController.ts      # 新增
│   └── InventoryController.ts     # 新增
├── services/
│   ├── MallService.ts             # 新增
│   ├── ProductService.ts          # 新增
│   ├── ExchangeService.ts         # 新增
│   ├── InventoryService.ts        # 新增
│   └── RecommendationService.ts   # 新增
├── models/
│   ├── Product.ts                 # 新增
│   ├── ProductCategory.ts         # 新增
│   ├── ExchangeOrder.ts           # 新增
│   └── InventoryRecord.ts         # 新增
├── routes/
│   ├── mall.ts                    # 新增
│   ├── products.ts                # 新增
│   └── exchange.ts                # 新增
└── middleware/
    └── mallAuth.ts                # 新增商城权限中间件
```

#### 数据库迁移脚本
```sql
-- 001_create_mall_tables.sql
-- 商品分类表
CREATE TABLE product_categories (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(500),
  parent_id VARCHAR(36),
  level INT DEFAULT 1,
  sort_order INT DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_parent_id (parent_id),
  INDEX idx_level (level),
  INDEX idx_sort_order (sort_order),
  INDEX idx_status (status)
);

-- 商品表
CREATE TABLE products (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category_id VARCHAR(36) NOT NULL,
  points_price INT NOT NULL,
  original_price DECIMAL(10,2),
  stock_quantity INT DEFAULT 0,
  sales_count INT DEFAULT 0,
  images JSON,
  specifications JSON,
  is_hot BOOLEAN DEFAULT FALSE,
  is_new BOOLEAN DEFAULT FALSE,
  status TINYINT DEFAULT 1,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_category_id (category_id),
  INDEX idx_points_price (points_price),
  INDEX idx_status (status),
  INDEX idx_is_hot (is_hot),
  INDEX idx_is_new (is_new),
  INDEX idx_sales_count (sales_count),
  INDEX idx_sort_order (sort_order)
);

-- 兑换订单表
CREATE TABLE exchange_orders (
  id VARCHAR(36) PRIMARY KEY,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36) NOT NULL,
  product_snapshot JSON NOT NULL,
  quantity INT NOT NULL,
  points_cost INT NOT NULL,
  status TINYINT DEFAULT 0, -- 0:待确认 1:已确认 2:已发货 3:已完成 -1:已取消
  delivery_info JSON,
  tracking_no VARCHAR(100),
  delivery_status TINYINT DEFAULT 0,
  exchanged_at TIMESTAMP NULL,
  shipped_at TIMESTAMP NULL,
  delivered_at TIMESTAMP NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_product_id (product_id),
  INDEX idx_status (status),
  INDEX idx_expires_at (expires_at),
  INDEX idx_created_at (created_at)
);

-- 库存记录表
CREATE TABLE inventory_records (
  id VARCHAR(36) PRIMARY KEY,
  product_id VARCHAR(36) NOT NULL,
  change_type TINYINT NOT NULL, -- 1:入库 2:出库 3:预留 4:释放 5:调整
  quantity_change INT NOT NULL,
  stock_before INT NOT NULL,
  stock_after INT NOT NULL,
  related_order_id VARCHAR(36),
  operator_id VARCHAR(36),
  description VARCHAR(200),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_change_type (change_type),
  INDEX idx_related_order_id (related_order_id),
  INDEX idx_created_at (created_at)
);

-- 用户推荐偏好表
CREATE TABLE user_preferences (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  category_preferences JSON, -- 分类偏好权重
  price_sensitivity DECIMAL(3,2), -- 价格敏感度 0-1
  brand_preferences JSON, -- 品牌偏好
  browsing_history JSON, -- 浏览历史
  exchange_history JSON, -- 兑换历史分析
  last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_user_id (user_id),
  INDEX idx_last_updated (last_updated)
);
```

### Phase 2: 核心功能开发 (第3-4周)

#### 开发优先级
1. **高优先级**：商品管理、兑换流程、库存管理
2. **中优先级**：推荐系统、用户偏好分析
3. **低优先级**：高级功能、数据分析、运营工具

#### 开发检查点
```typescript
// 每日开发检查清单
const DevelopmentChecklist = {
  week3: {
    day1: ['商品模型完成', '商品CRUD接口', '基础测试用例'],
    day2: ['商品分类功能', '库存管理基础', '数据库连接测试'],
    day3: ['兑换服务框架', '积分扣减对接', '事务处理'],
    day4: ['前端商品列表页', '商品详情页', '基础样式'],
    day5: ['兑换确认页面', '订单列表页', '状态管理']
  },
  week4: {
    day1: ['推荐算法基础版', '用户偏好收集', 'A/B测试框架'],
    day2: ['库存预警系统', '自动释放机制', '异常处理'],
    day3: ['前端商城首页', '推荐展示', '搜索功能'],
    day4: ['兑换流程集成测试', '支付页面改造', '状态同步'],
    day5: ['性能优化', '缓存策略', '错误处理完善']
  }
}
```

### Phase 3: 系统整合 (第5-6周)

#### 整合测试策略
```typescript
// 集成测试用例
const IntegrationTestCases = [
  {
    name: '完整兑换流程测试',
    steps: [
      '用户登录',
      '查看商品列表',
      '选择商品',
      '确认兑换',
      '积分扣减',
      '库存扣减', 
      '订单创建',
      '发货处理',
      '订单完成'
    ],
    expectedResult: '整个流程无错误，数据一致性正确'
  },
  {
    name: '并发兑换测试',
    steps: [
      '模拟100个用户同时兑换同一商品',
      '检查库存扣减正确性',
      '检查积分扣减准确性',
      '检查超卖情况'
    ],
    expectedResult: '无超卖，无积分异常扣减'
  },
  {
    name: '服务故障恢复测试',
    steps: [
      '模拟积分服务故障',
      '检查兑换流程降级',
      '服务恢复后检查数据一致性'
    ],
    expectedResult: '降级正常，恢复后数据一致'
  }
]
```

---

## 🏭 生产环境部署

### 1. 容器化部署

#### Docker配置文件
```dockerfile
# Dockerfile.mall-service
FROM node:18-alpine

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm ci --only=production --silent

# 复制源码
COPY . .

# 构建应用
RUN npm run build

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# 启动应用
CMD ["npm", "start"]
```

#### Kubernetes部署配置
```yaml
# k8s/mall-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mall-service
  labels:
    app: mall-service
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mall-service
  template:
    metadata:
      labels:
        app: mall-service
    spec:
      containers:
      - name: mall-service
        image: mall-service:v1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: host
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: host
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: mall-service
spec:
  selector:
    app: mall-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP
```

### 2. 监控和日志配置

#### Prometheus监控配置
```yaml
# prometheus/mall-service-config.yml
global:
  scrape_interval: 15s

scrape_configs:
- job_name: 'mall-service'
  static_configs:
  - targets: ['mall-service:3000']
  metrics_path: /metrics
  scrape_interval: 10s

rule_files:
- "mall-service-alerts.yml"

alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager:9093
```

#### 日志收集配置
```yaml
# filebeat/mall-service-config.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /app/logs/mall-service-*.log
  fields:
    service: mall-service
    environment: production
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "mall-service-%{+yyyy.MM.dd}"

processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
```

---

## 🔄 数据迁移策略

### 1. 现有数据扩展

#### 积分记录表扩展
```sql
-- 为现有积分记录表添加商城消费支持
ALTER TABLE points_records 
ADD COLUMN exchange_order_id VARCHAR(36) AFTER order_id,
ADD INDEX idx_exchange_order_id (exchange_order_id);

-- 更新source字段枚举值
ALTER TABLE points_records 
MODIFY COLUMN source ENUM(
  'payment_reward',     -- 现有：支付奖励
  'admin_adjust',       -- 现有：管理员调整  
  'mall_consumption',   -- 新增：商城消费
  'mall_refund',        -- 新增：商城退款
  'expire_deduct',      -- 现有：过期扣减
  'invite_reward'       -- 预留：邀请奖励
) DEFAULT 'payment_reward';
```

#### 用户表扩展
```sql
-- 为用户表添加商城相关字段
ALTER TABLE users
ADD COLUMN mall_level TINYINT DEFAULT 1 COMMENT '商城会员等级',
ADD COLUMN last_exchange_at TIMESTAMP NULL COMMENT '最后兑换时间',
ADD COLUMN total_exchanges INT DEFAULT 0 COMMENT '总兑换次数',
ADD COLUMN favorite_categories JSON COMMENT '收藏分类',
ADD INDEX idx_mall_level (mall_level),
ADD INDEX idx_last_exchange_at (last_exchange_at);
```

### 2. 初始化数据

#### 基础商品分类数据
```sql
-- 初始化商品分类
INSERT INTO product_categories (id, name, description, icon, level, sort_order) VALUES
('cat_digital', '数码产品', '手机、电脑、智能设备', '/icons/digital.png', 1, 1),
('cat_food', '美食优惠', '餐饮券、零食、特产', '/icons/food.png', 1, 2),
('cat_life', '生活用品', '日用品、家居、个护', '/icons/life.png', 1, 3),
('cat_entertainment', '娱乐服务', '电影票、游戏、会员', '/icons/entertainment.png', 1, 4),
('cat_travel', '出行服务', '打车券、加油卡、旅游', '/icons/travel.png', 1, 5);

-- 二级分类
INSERT INTO product_categories (id, name, description, parent_id, level, sort_order) VALUES
('cat_mobile', '手机通讯', '智能手机、配件', 'cat_digital', 2, 1),
('cat_computer', '电脑办公', '笔记本、台式机、配件', 'cat_digital', 2, 2),
('cat_snack', '休闲零食', '坚果、饼干、糖果', 'cat_food', 2, 1),
('cat_beverage', '饮品茶饮', '咖啡、茶叶、饮料', 'cat_food', 2, 2);
```

#### 演示商品数据
```sql
-- 初始化演示商品
INSERT INTO products (id, name, description, category_id, points_price, original_price, stock_quantity, is_hot, is_new) VALUES
('prod_iphone15', 'iPhone 15 Pro 256GB', '最新款iPhone 15 Pro', 'cat_mobile', 999900, 9999.00, 10, true, true),
('prod_airpods', 'AirPods Pro 2', '主动降噪无线耳机', 'cat_mobile', 189900, 1899.00, 50, true, false),
('prod_starbucks', '星巴克大杯拿铁券', '全国门店通用', 'cat_beverage', 3500, 35.00, 1000, false, false),
('prod_kfc', 'KFC全家桶券', '9块鸡+薯条+可乐', 'cat_food', 8900, 89.00, 500, true, false),
('prod_movie', '电影票通用券', '全国影院通用', 'cat_entertainment', 4500, 45.00, 2000, false, true);
```

---

## 🔧 技术实施细节

### 1. 现有服务扩展

#### 积分服务扩展 (PointsService.ts)
```typescript
// 在现有PointsService基础上添加商城功能
export class PointsService {
  // 现有方法保持不变...

  /**
   * 商城兑换积分检查
   */
  static async checkExchangeEligibility(
    userId: string, 
    pointsRequired: number
  ): Promise<{
    eligible: boolean
    currentBalance: number
    shortage: number
  }> {
    const balance = await this.getUserPointsBalance(userId)
    
    return {
      eligible: balance.balance >= pointsRequired,
      currentBalance: balance.balance,
      shortage: Math.max(0, pointsRequired - balance.balance)
    }
  }

  /**
   * 商城兑换积分扣减
   */
  static async exchangePointsDeduction(
    userId: string,
    pointsCost: number,
    productId: string,
    exchangeOrderId: string
  ): Promise<void> {
    await this.consumePoints(
      userId,
      pointsCost,
      `商城兑换-${productId}`,
      exchangeOrderId
    )
  }

  /**
   * 兑换退款积分返还
   */
  static async refundExchangePoints(
    userId: string,
    pointsToRefund: number,
    exchangeOrderId: string,
    reason: string
  ): Promise<void> {
    await this.awardPoints(
      userId,
      pointsToRefund,
      'mall_refund',
      `兑换退款-${reason}`,
      exchangeOrderId
    )
  }
}
```

### 2. 新服务实现

#### 商品服务实现
```typescript
// backend/src/services/ProductService.ts
export class ProductService {
  /**
   * 获取商品列表（支持筛选和分页）
   */
  static async getProducts(filters: ProductFilters): Promise<ProductListResult> {
    const {
      categoryId,
      keyword,
      minPoints,
      maxPoints,
      isHot,
      isNew,
      page = 1,
      pageSize = 20
    } = filters

    let query = `
      SELECT p.*, c.name as category_name, c.icon as category_icon
      FROM products p
      LEFT JOIN product_categories c ON p.category_id = c.id
      WHERE p.status = 1
    `
    const params: any[] = []

    // 动态构建查询条件
    if (categoryId) {
      query += ' AND p.category_id = ?'
      params.push(categoryId)
    }

    if (keyword) {
      query += ' AND (p.name LIKE ? OR p.description LIKE ?)'
      params.push(`%${keyword}%`, `%${keyword}%`)
    }

    if (minPoints !== undefined) {
      query += ' AND p.points_price >= ?'
      params.push(minPoints)
    }

    if (maxPoints !== undefined) {
      query += ' AND p.points_price <= ?'
      params.push(maxPoints)
    }

    if (isHot !== undefined) {
      query += ' AND p.is_hot = ?'
      params.push(isHot)
    }

    if (isNew !== undefined) {
      query += ' AND p.is_new = ?'
      params.push(isNew)
    }

    // 排序和分页
    query += ' ORDER BY p.sort_order DESC, p.sales_count DESC, p.created_at DESC'
    query += ' LIMIT ? OFFSET ?'
    params.push(pageSize, (page - 1) * pageSize)

    const [products, totalCount] = await Promise.all([
      DatabaseConnection.query(query, params),
      this.getProductsCount(filters)
    ])

    return {
      products: products.map(this.formatProductData),
      pagination: {
        page,
        pageSize,
        total: totalCount,
        totalPages: Math.ceil(totalCount / pageSize)
      }
    }
  }

  /**
   * 获取商品详情
   */
  static async getProductDetail(productId: string): Promise<ProductDetail | null> {
    const query = `
      SELECT p.*, c.name as category_name, c.icon as category_icon
      FROM products p
      LEFT JOIN product_categories c ON p.category_id = c.id
      WHERE p.id = ? AND p.status = 1
    `

    const [products] = await DatabaseConnection.query(query, [productId])
    
    if (!products.length) {
      return null
    }

    const product = this.formatProductData(products[0])

    // 获取库存信息
    const stockInfo = await InventoryService.getStockLevel(productId)
    product.stockInfo = stockInfo

    // 记录浏览历史（异步）
    this.recordProductView(productId).catch(console.error)

    return product
  }
}
```

### 3. 前端实现

#### 商城首页实现
```javascript
// mall-package/pages/index/index.js
import { MallService } from '../../../services/mall.js'
import { PointsService } from '../../../services/points.js'

Page({
  data: {
    userPoints: 0,
    categories: [],
    recommendedProducts: [],
    hotProducts: [],
    newProducts: [],
    loading: true,
    refreshing: false
  },

  async onLoad(options) {
    // 获取来源信息
    const source = options.source || 'direct'
    const expectedPoints = parseInt(options.expected_points) || 0
    
    console.log('商城页面加载:', { source, expectedPoints })
    
    await this.initializePage(source, expectedPoints)
  },

  async initializePage(source, expectedPoints) {
    try {
      this.setData({ loading: true })

      // 并行加载数据
      const [pointsBalance, categories, recommendations] = await Promise.all([
        PointsService.getPointsBalance(),
        MallService.getCategories(),
        MallService.getRecommendations({
          source,
          expectedPoints,
          limit: 6
        })
      ])

      this.setData({
        userPoints: pointsBalance.balance,
        categories: categories.slice(0, 8), // 显示前8个分类
        recommendedProducts: recommendations.affordable || [],
        loading: false
      })

      // 加载热门和新品（低优先级）
      this.loadSecondaryData()

    } catch (error) {
      console.error('商城页面初始化失败:', error)
      this.setData({ loading: false })
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'none'
      })
    }
  },

  async loadSecondaryData() {
    try {
      const [hotProducts, newProducts] = await Promise.all([
        MallService.getProducts({ isHot: true, pageSize: 4 }),
        MallService.getProducts({ isNew: true, pageSize: 4 })
      ])

      this.setData({
        hotProducts: hotProducts.products,
        newProducts: newProducts.products
      })
    } catch (error) {
      console.error('加载次要数据失败:', error)
    }
  },

  // 跳转到商品详情
  navigateToProduct(e) {
    const productId = e.currentTarget.dataset.productId
    wx.navigateTo({
      url: `../product-detail/index?id=${productId}`
    })
  },

  // 跳转到分类页面
  navigateToCategory(e) {
    const categoryId = e.currentTarget.dataset.categoryId
    wx.navigateTo({
      url: `../category/index?id=${categoryId}`
    })
  },

  // 下拉刷新
  async onPullDownRefresh() {
    this.setData({ refreshing: true })
    await this.initializePage('refresh', 0)
    this.setData({ refreshing: false })
    wx.stopPullDownRefresh()
  }
})
```

---

## 🎯 部署流水线

### 1. CI/CD配置

#### GitHub Actions配置
```yaml
# .github/workflows/mall-service-deploy.yml
name: Mall Service Deploy

on:
  push:
    branches: [ main ]
    paths: [ 'backend/**', 'mall-package/**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'
    
    - name: Install dependencies
      run: cd backend && npm ci
    
    - name: Run tests
      run: cd backend && npm test
    
    - name: Run linting
      run: cd backend && npm run lint

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t mall-service:${{ github.sha }} -f backend/Dockerfile.mall backend/
    
    - name: Deploy to production
      run: |
        kubectl set image deployment/mall-service mall-service=mall-service:${{ github.sha }}
        kubectl rollout status deployment/mall-service
```

### 2. 蓝绿部署策略

#### 部署脚本
```bash
#!/bin/bash
# scripts/deploy-mall-service.sh

set -e

VERSION=$1
ENVIRONMENT=${2:-production}

echo "🚀 开始部署商城服务 - 版本: $VERSION"

# 1. 构建新版本镜像
echo "📦 构建Docker镜像..."
docker build -t mall-service:$VERSION -f backend/Dockerfile.mall backend/

# 2. 推送到镜像仓库
echo "📤 推送镜像到仓库..."
docker tag mall-service:$VERSION registry.example.com/mall-service:$VERSION
docker push registry.example.com/mall-service:$VERSION

# 3. 更新Kubernetes部署
echo "🔄 更新Kubernetes部署..."
kubectl set image deployment/mall-service-green mall-service=registry.example.com/mall-service:$VERSION

# 4. 等待部署完成
echo "⏳ 等待新版本就绪..."
kubectl rollout status deployment/mall-service-green --timeout=300s

# 5. 健康检查
echo "🔍 执行健康检查..."
HEALTH_CHECK_URL="http://mall-service-green/health"
for i in {1..10}; do
  if curl -f $HEALTH_CHECK_URL; then
    echo "✅ 健康检查通过"
    break
  fi
  if [ $i -eq 10 ]; then
    echo "❌ 健康检查失败，回滚部署"
    kubectl rollout undo deployment/mall-service-green
    exit 1
  fi
  sleep 10
done

# 6. 切换流量
echo "🔀 切换生产流量..."
kubectl patch service mall-service -p '{"spec":{"selector":{"version":"green"}}}'

# 7. 验证新版本
echo "🧪 验证新版本功能..."
./scripts/verify-mall-service.sh

echo "🎉 商城服务部署完成！"
```

---

## 📋 验收测试清单

### 1. 功能测试

#### 自动化测试用例
```typescript
// __tests__/integration/mall-service.test.ts
describe('商城服务集成测试', () => {
  beforeAll(async () => {
    await setupTestDatabase()
    await seedTestData()
  })

  describe('商品管理', () => {
    test('应该能够获取商品列表', async () => {
      const response = await request(app)
        .get('/api/mall/products')
        .expect(200)
      
      expect(response.body.success).toBe(true)
      expect(response.body.data.products).toBeInstanceOf(Array)
    })

    test('应该能够按分类筛选商品', async () => {
      const response = await request(app)
        .get('/api/mall/products?category_id=cat_digital')
        .expect(200)
      
      expect(response.body.data.products.every(p => p.category.id === 'cat_digital')).toBe(true)
    })
  })

  describe('兑换流程', () => {
    test('应该能够成功兑换商品', async () => {
      // 1. 创建兑换订单
      const exchangeResponse = await request(app)
        .post('/api/mall/exchange')
        .send({
          productId: 'prod_starbucks',
          quantity: 1,
          deliveryInfo: testDeliveryInfo
        })
        .set('Authorization', `Bearer ${testUserToken}`)
        .expect(200)

      expect(exchangeResponse.body.success).toBe(true)
      
      // 2. 验证积分扣减
      const pointsResponse = await request(app)
        .get('/api/points/balance')
        .set('Authorization', `Bearer ${testUserToken}`)
        .expect(200)

      expect(pointsResponse.body.data.balance).toBe(initialBalance - 3500)
      
      // 3. 验证库存扣减
      const productResponse = await request(app)
        .get('/api/mall/products/prod_starbucks')
        .expect(200)

      expect(productResponse.body.data.stockQuantity).toBe(initialStock - 1)
    })
  })
})
```

### 2. 性能测试

#### 压力测试脚本
```javascript
// performance-test/mall-load-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 10 },   // 预热
    { duration: '5m', target: 50 },   // 正常负载
    { duration: '2m', target: 100 },  // 峰值负载
    { duration: '5m', target: 0 },    // 缓慢降级
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%请求响应时间<500ms
    http_req_failed: ['rate<0.01'],   // 错误率<1%
  },
};

export default function () {
  // 测试商品列表接口
  let response = http.get('https://api.guandongfang.cn/api/mall/products');
  check(response, {
    '商品列表响应成功': (r) => r.status === 200,
    '响应时间正常': (r) => r.timings.duration < 500,
  });

  // 测试商品详情接口
  response = http.get('https://api.guandongfang.cn/api/mall/products/prod_starbucks');
  check(response, {
    '商品详情响应成功': (r) => r.status === 200,
    '数据完整性': (r) => JSON.parse(r.body).data.id === 'prod_starbucks',
  });
}
```

---

## 🚨 应急预案

### 1. 故障处理预案

#### 服务降级策略
```typescript
// 商城服务降级配置
const FallbackConfig = {
  productService: {
    // 商品服务不可用时的降级策略
    fallback: () => ({
      products: [],
      message: '商品数据正在更新，请稍后再试'
    }),
    enableCache: true,
    cacheTime: 300000 // 5分钟缓存
  },
  
  recommendationService: {
    // 推荐服务不可用时显示热门商品
    fallback: async () => {
      const hotProducts = await ProductService.getProducts({ 
        isHot: true, 
        pageSize: 6 
      })
      return {
        type: 'hot',
        products: hotProducts.products,
        reason: '为您推荐热门商品'
      }
    }
  },
  
  exchangeService: {
    // 兑换服务不可用时的处理
    fallback: () => {
      throw new Error('兑换服务暂时不可用，请稍后重试')
    },
    enableQueue: true, // 启用请求队列
    queueTimeout: 30000 // 30秒超时
  }
}
```

### 2. 数据恢复预案

#### 备份和恢复策略
```bash
#!/bin/bash
# scripts/backup-mall-data.sh

# 数据库备份
echo "📦 开始备份商城数据..."

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mall-service/$BACKUP_DATE"

mkdir -p $BACKUP_DIR

# 备份商城相关表
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD $DB_NAME \
  products product_categories exchange_orders inventory_records user_preferences \
  --single-transaction --routines --triggers \
  > $BACKUP_DIR/mall-tables.sql

# 备份Redis缓存
redis-cli --rdb $BACKUP_DIR/mall-cache.rdb

# 压缩备份文件
tar -czf $BACKUP_DIR.tar.gz $BACKUP_DIR/

echo "✅ 商城数据备份完成: $BACKUP_DIR.tar.gz"
```

---

## 📊 监控报表

### 1. 业务监控

#### 关键指标仪表板
```typescript
const MallDashboardMetrics = {
  realTime: {
    // 实时指标
    activeUsers: '当前在线商城用户数',
    ongoingExchanges: '进行中的兑换订单',
    systemLoad: '系统负载',
    errorRate: '错误率'
  },
  
  daily: {
    // 日报指标
    totalExchanges: '日兑换订单数',
    totalPointsConsumed: '日积分消费量',
    popularProducts: '热门商品排行',
    userEngagement: '用户参与度'
  },
  
  weekly: {
    // 周报指标
    conversionRate: '支付到兑换转化率',
    userRetention: '用户留存率',
    inventoryTurnover: '库存周转率',
    revenueImpact: '收入影响分析'
  }
}
```

### 2. 自动化报告

#### 每日报告生成
```typescript
class MallReportGenerator {
  async generateDailyReport(date: Date): Promise<DailyReport> {
    const dateStr = date.toISOString().split('T')[0]
    
    const metrics = await Promise.all([
      this.getExchangeMetrics(date),
      this.getProductMetrics(date),
      this.getUserMetrics(date),
      this.getSystemMetrics(date)
    ])

    const report: DailyReport = {
      date: dateStr,
      exchange: metrics[0],
      products: metrics[1], 
      users: metrics[2],
      system: metrics[3],
      recommendations: await this.generateRecommendations(metrics)
    }

    // 发送报告
    await NotificationService.sendDailyReport(report)
    
    return report
  }
}
```

---

## 💡 最佳实践建议

### 1. 开发规范

#### 代码规范
```typescript
// 统一的API响应格式
class APIResponseHelper {
  static success<T>(data: T, message = '操作成功'): APIResponse<T> {
    return {
      success: true,
      code: 'SUCCESS',
      message,
      data,
      timestamp: Date.now()
    }
  }
  
  static error(code: string, message: string): APIResponse<null> {
    return {
      success: false,
      code,
      message,
      data: null,
      timestamp: Date.now()
    }
  }
}

// 统一的日志格式
class Logger {
  static logMallOperation(operation: string, userId: string, details: any) {
    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      service: 'mall-service',
      operation,
      userId,
      details,
      level: 'info'
    }))
  }
}
```

### 2. 运维规范

#### 服务健康检查
```typescript
// 商城服务健康检查
app.get('/health', async (req, res) => {
  const healthChecks = await Promise.allSettled([
    checkDatabaseConnection(),
    checkRedisConnection(),
    checkDependentServices()
  ])
  
  const allHealthy = healthChecks.every(result => result.status === 'fulfilled')
  
  res.status(allHealthy ? 200 : 503).json({
    status: allHealthy ? 'healthy' : 'unhealthy',
    timestamp: new Date().toISOString(),
    checks: {
      database: healthChecks[0].status,
      redis: healthChecks[1].status,
      dependencies: healthChecks[2].status
    }
  })
})
```

---

## 📋 总结

### 实施成功关键因素
1. **渐进式迁移**：分阶段逐步实施，降低风险
2. **数据一致性**：严格保证跨服务数据一致性
3. **性能优化**：多级缓存和数据库优化
4. **监控完善**：全面的监控和告警体系
5. **应急准备**：完整的故障处理和恢复预案

### 风险控制措施
1. **代码质量**：严格的代码审查和测试覆盖
2. **部署安全**：蓝绿部署和自动回滚机制  
3. **数据安全**：定期备份和权限控制
4. **服务稳定**：熔断降级和故障隔离

### 下一步行动
1. 立即开始Phase 1基础架构搭建
2. 并行进行数据库表结构创建
3. 搭建基础的CI/CD流水线
4. 制定详细的测试计划

这个实施策略确保了商城功能的平滑集成，同时保持系统的稳定性和可扩展性。

---

**文档状态**：待技术评审  
**下一步行动**：开始架构搭建  
**责任人**：技术团队  
**评审时间**：待定

