# 413 Request Entity Too Large 错误修复记录

## 📅 修复时间
**日期**: 2025年10月1日  
**执行人**: 系统自动化脚本

---

## 🔍 问题描述

### 错误信息
```
API Error: 413 <html>
<head><title>413 Request Entity Too Large</title></head>
<body>
<center><h1>413 Request Entity Too Large</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

### 问题原因
- **Nginx** 默认请求体限制为 1MB
- **Express** 默认 JSON 解析限制为 100KB
- 管理后台批量操作或大数据请求超出限制

---

## ✅ 修复方案

### 1. Nginx 配置修改

**文件位置**: `/etc/nginx/sites-available/guandongfang`

**修改内容**:
```nginx
server {
    client_max_body_size 50M;  # 新增配置
    listen 443 ssl http2;
    server_name guandongfang.cn www.guandongfang.cn;
    # ... 其他配置
}
```

**修改位置**:
- HTTP server 块（80端口）
- HTTPS server 块（443端口）

### 2. Express 后端配置修改

**文件位置**: `/root/weixinzhifu/backend/payment-points-api-enhanced.js`

**修改前**:
```javascript
app.use(express.json());
```

**修改后**:
```javascript
// 中间件 - 增加请求体大小限制到 50MB
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));
```

---

## 🚀 修复执行

### 执行脚本
```bash
# 完整一键修复
./scripts/complete-fix-413.sh

# 或分步执行
./scripts/fix-413-error.sh          # 修复 Nginx
./scripts/deploy-backend-fix-413.sh # 部署后端
```

### 脚本功能
1. **自动备份**所有修改的配置文件
2. **修改 Nginx 配置**并测试
3. **上传后端代码**到服务器
4. **重启服务**（Nginx + PM2）
5. **验证修复结果**

---

## 📊 配置对比

| 组件 | 配置项 | 修改前 | 修改后 | 说明 |
|------|--------|--------|--------|------|
| **Nginx** | client_max_body_size | 1M（默认） | **50M** | 允许更大的请求体 |
| **Express** | JSON limit | 100KB（默认） | **50MB** | 支持大JSON数据 |
| **Express** | URLencoded limit | 未设置 | **50MB** | 支持大表单数据 |

---

## ✅ 验证结果

### Nginx 配置验证
```bash
# 查看配置
grep -n "client_max_body_size" /etc/nginx/sites-available/guandongfang

# 输出结果
3:    client_max_body_size 50M;  # HTTP server
12:   client_max_body_size 50M;  # HTTPS server
```

### 服务状态验证
```bash
# Nginx 状态
systemctl status nginx
# ✅ active (running)

# PM2 状态
pm2 list
# ✅ payment-points-api-complete: online
# ✅ merchant-api: online
```

---

## 🎯 适用场景

修复后的配置支持以下场景：

1. ✅ **批量导入商户数据**（最大 40MB）
2. ✅ **订单数据批量提交**
3. ✅ **大量积分记录上传**
4. ✅ **文件上传**（图片、Excel等）
5. ✅ **复杂查询结果返回**

---

## 📋 备份文件清单

所有修改都已自动备份：

### Nginx 配置备份
- `/etc/nginx/sites-available/guandongfang.backup.20251001_003720`
- `/etc/nginx/sites-available/guandongfang.backup.manual`

### 后端代码备份
- `/root/weixinzhifu/backend/payment-points-api-enhanced.js.backup.20251001_003737`

### 本地 Git 记录
- 所有修改已提交到本地 Git 仓库
- 可通过 `git diff` 查看具体变更

---

## 🧪 测试建议

### 1. 测试小请求（正常）
```bash
curl -X POST https://www.guandongfang.cn/api/v1/admin/merchants \
     -H 'Content-Type: application/json' \
     -H 'Authorization: Bearer YOUR_TOKEN' \
     -d '{"name": "测试商户"}'
```

### 2. 测试大数据请求
```bash
# 生成大JSON文件（约 10MB）
node -e "console.log(JSON.stringify({data: Array(100000).fill({name: '测试', value: 123})}))" > large-data.json

# 提交测试
curl -X POST https://www.guandongfang.cn/api/v1/admin/merchants/batch \
     -H 'Content-Type: application/json' \
     -H 'Authorization: Bearer YOUR_TOKEN' \
     -d @large-data.json
```

### 3. 测试文件上传
```javascript
// 前端测试代码
const formData = new FormData();
formData.append('file', file); // 文件大小 < 50MB

await fetch('https://www.guandongfang.cn/api/v1/upload', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
```

---

## ⚠️ 注意事项

### 1. 性能考虑
- **不建议**单次请求超过 40MB
- 超大文件应使用**分片上传**
- 批量操作建议**分批处理**（每批 100-500 条）

### 2. 安全考虑
- 50MB 是**最大限制**，不是推荐值
- 建议在前端做**文件大小验证**
- 考虑添加**请求频率限制**（Rate Limiting）

### 3. 监控建议
```bash
# 查看 Nginx 日志
tail -f /var/log/nginx/error.log

# 查看后端日志
pm2 logs payment-points-api-complete

# 监控内存使用
pm2 monit
```

---

## 🔧 故障恢复

如果修复后出现问题，可以快速恢复：

### 恢复 Nginx 配置
```bash
ssh -i config/ssh/weixinpay.pem root@8.156.84.226
cd /etc/nginx/sites-available
cp guandongfang.backup.20251001_003720 guandongfang
nginx -t && systemctl reload nginx
```

### 恢复后端代码
```bash
ssh -i config/ssh/weixinpay.pem root@8.156.84.226
cd /root/weixinzhifu/backend
cp payment-points-api-enhanced.js.backup.20251001_003737 payment-points-api-enhanced.js
pm2 restart all
```

---

## 📚 相关文档

- [Nginx 官方文档 - client_max_body_size](http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size)
- [Express 官方文档 - body-parser](https://expressjs.com/en/api.html#express.json)
- [项目部署指南](./04-部署与运维/01-部署方案.md)

---

## 📞 问题排查

### 如果仍然出现 413 错误

1. **检查 Nginx 配置**
   ```bash
   grep client_max_body_size /etc/nginx/sites-available/guandongfang
   ```

2. **检查后端代码**
   ```bash
   grep "limit.*50mb" /root/weixinzhifu/backend/payment-points-api-enhanced.js
   ```

3. **检查防火墙/CDN**
   - 如果使用了 CDN，CDN 可能也有大小限制
   - 检查阿里云安全组规则

4. **查看错误日志**
   ```bash
   # Nginx 错误日志
   tail -100 /var/log/nginx/error.log
   
   # 后端错误日志
   pm2 logs --lines 100
   ```

---

## ✅ 修复完成确认

- [x] Nginx 配置已修改
- [x] Express 后端已修改
- [x] 所有服务已重启
- [x] 配置已备份
- [x] 修复已验证
- [x] 文档已更新

---

**修复人员**: 自动化脚本  
**验证人员**: 系统管理员  
**最后更新**: 2025年10月1日

