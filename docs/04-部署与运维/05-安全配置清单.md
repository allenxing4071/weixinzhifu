# 安全配置清单

> **更新时间**: 2025年10月1日
> **适用环境**: 生产环境、测试环境
> **重要性**: ⚠️ **必读** - 关系到系统安全

---

## 📋 目录

1. [环境变量配置](#环境变量配置)
2. [数据库安全](#数据库安全)
3. [服务器安全](#服务器安全)
4. [HTTPS配置](#https配置)
5. [防火墙配置](#防火墙配置)
6. [日常维护](#日常维护)

---

## 环境变量配置

### 1. 创建.env文件

```bash
cd /root/payment-points-backend
cp .env.example .env
nano .env
```

### 2. 必需配置项

```bash
# ==================== 环境配置 ====================
NODE_ENV=production  # 生产环境设置为production

# ==================== 服务器配置 ====================
PORT=3000

# ==================== 数据库配置 ====================
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=points_app_user  # ⚠️ 不要使用root
DB_PASSWORD=YOUR_STRONG_PASSWORD_HERE  # ⚠️ 必须修改
DB_NAME=points_app_prod
DB_CONNECTION_LIMIT=10

# ==================== JWT配置 ====================
# ⚠️ 生成强密钥：node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=your_random_32_byte_secret_key_change_this_in_production
JWT_EXPIRES_IN=7d

# ==================== CORS配置 ====================
# 多个域名用逗号分隔
ALLOWED_ORIGINS=https://www.guandongfang.cn,https://guandongfang.cn

# ==================== 日志配置 ====================
LOG_LEVEL=info  # error, warn, info, debug
LOG_FILE=logs/app.log

# ==================== 限流配置 ====================
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_LOGIN_MAX=5
```

### 3. 生成强密钥

```bash
# 生成JWT密钥（32字节）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 输出示例：
# a3f5c8d2e7b9f1a4c6d8e2f9a1b3c5d7e9f2a4b6c8d1e3f5a7b9c2d4e6f8a1b3
```

将生成的密钥填入`.env`的`JWT_SECRET`:
```bash
JWT_SECRET=a3f5c8d2e7b9f1a4c6d8e2f9a1b3c5d7e9f2a4b6c8d1e3f5a7b9c2d4e6f8a1b3
```

### 4. 文件权限设置

```bash
# .env文件只允许所有者读取
chmod 600 .env

# 验证权限
ls -l .env
# 应该显示：-rw------- 1 root root
```

---

## 数据库安全

### 1. 创建专用数据库用户

⚠️ **不要使用root用户连接数据库**

```sql
-- 1. 登录MySQL
mysql -u root -p

-- 2. 创建专用数据库
CREATE DATABASE IF NOT EXISTS points_app_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 3. 创建专用用户
CREATE USER 'points_app_user'@'localhost' IDENTIFIED BY 'YOUR_STRONG_PASSWORD';

-- 4. 授予必要权限（仅限该数据库）
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, INDEX ON points_app_prod.* TO 'points_app_user'@'localhost';

-- 5. 刷新权限
FLUSH PRIVILEGES;

-- 6. 验证权限
SHOW GRANTS FOR 'points_app_user'@'localhost';

-- 7. 退出
EXIT;
```

### 2. 修改MySQL配置

```bash
# 编辑MySQL配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

添加或修改以下配置:
```ini
[mysqld]
# 只允许本地连接
bind-address = 127.0.0.1

# 禁用远程root登录
skip-networking = 0

# 慢查询日志（帮助发现性能问题）
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# 最大连接数
max_connections = 200

# 字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

重启MySQL:
```bash
sudo systemctl restart mysql
```

### 3. 定期备份数据库

创建备份脚本 `/root/backup-db.sh`:
```bash
#!/bin/bash

# 配置
DB_USER="points_app_user"
DB_PASS="YOUR_PASSWORD"
DB_NAME="points_app_prod"
BACKUP_DIR="/root/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: backup_$DATE.sql.gz"
```

设置权限和定时任务:
```bash
# 设置执行权限
chmod +x /root/backup-db.sh

# 添加到crontab（每天凌晨3点执行）
crontab -e

# 添加以下行：
0 3 * * * /root/backup-db.sh >> /var/log/mysql-backup.log 2>&1
```

---

## 服务器安全

### 1. 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# 安装安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 2. 配置SSH安全

编辑SSH配置:
```bash
sudo nano /etc/ssh/sshd_config
```

推荐配置:
```ini
# 禁用root登录
PermitRootLogin no

# 禁用密码登录（仅允许密钥）
PasswordAuthentication no
PubkeyAuthentication yes

# 修改SSH端口（可选，增加安全性）
Port 2222

# 限制登录尝试
MaxAuthTries 3
MaxSessions 2

# 禁用空密码
PermitEmptyPasswords no

# 设置登录超时
LoginGraceTime 30
```

重启SSH:
```bash
sudo systemctl restart sshd
```

### 3. 配置防火墙

```bash
# 安装UFW
sudo apt install ufw

# 默认规则：拒绝所有入站，允许所有出站
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH（如果改了端口，改为对应端口）
sudo ufw allow 22/tcp

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许Node.js应用端口（仅本地）
sudo ufw allow from 127.0.0.1 to any port 3000

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status verbose
```

### 4. 安装Fail2ban

防止暴力破解:
```bash
# 安装
sudo apt install fail2ban

# 创建本地配置
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# 编辑配置
sudo nano /etc/fail2ban/jail.local
```

配置示例:
```ini
[DEFAULT]
bantime = 3600    # 封禁1小时
findtime = 600    # 10分钟内
maxretry = 5      # 失败5次则封禁

[sshd]
enabled = true
port = 22
logpath = /var/log/auth.log
```

启动服务:
```bash
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 查看状态
sudo fail2ban-client status
```

---

## HTTPS配置

### 1. 安装Certbot

```bash
# 安装Certbot和Nginx插件
sudo apt install certbot python3-certbot-nginx
```

### 2. 获取SSL证书

```bash
# 为域名申请证书
sudo certbot --nginx -d www.guandongfang.cn -d guandongfang.cn

# 按提示输入邮箱和同意条款
```

### 3. 配置Nginx反向代理

编辑Nginx配置:
```bash
sudo nano /etc/nginx/sites-available/points-api
```

配置内容:
```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name www.guandongfang.cn guandongfang.cn;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name www.guandongfang.cn guandongfang.cn;

    # SSL证书（Certbot自动配置）
    ssl_certificate /etc/letsencrypt/live/www.guandongfang.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.guandongfang.cn/privkey.pem;

    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头部
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 反向代理到Node.js
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 管理后台静态文件
    location / {
        root /root/admin-frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 日志
    access_log /var/log/nginx/points-api-access.log;
    error_log /var/log/nginx/points-api-error.log;
}
```

启用配置:
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/points-api /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 4. 自动续期证书

```bash
# 测试续期
sudo certbot renew --dry-run

# Certbot会自动添加续期任务到crontab
# 可以查看：
sudo cat /etc/cron.d/certbot
```

---

## 防火墙配置

### 阿里云安全组规则

登录阿里云控制台 → ECS → 网络与安全 → 安全组

#### 入方向规则

| 优先级 | 协议 | 端口 | 授权对象 | 说明 |
|--------|------|------|----------|------|
| 1 | TCP | 22 | YOUR_IP/32 | SSH（限制IP） |
| 2 | TCP | 80 | 0.0.0.0/0 | HTTP |
| 3 | TCP | 443 | 0.0.0.0/0 | HTTPS |
| 100 | 全部 | -1/-1 | 拒绝 0.0.0.0/0 | 拒绝其他 |

#### 出方向规则

| 优先级 | 协议 | 端口 | 授权对象 | 说明 |
|--------|------|------|----------|------|
| 1 | 全部 | -1/-1 | 0.0.0.0/0 | 允许所有出站 |

⚠️ **重要**:
- 不要开放3306（MySQL）端口
- 不要开放3000（Node.js）端口
- SSH端口建议限制IP访问

---

## 日常维护

### 1. 日志检查

#### 应用日志
```bash
# 查看最新日志
tail -f /root/payment-points-backend/logs/combined.log

# 查看错误日志
tail -f /root/payment-points-backend/logs/error.log

# 搜索特定错误
grep "Error" /root/payment-points-backend/logs/error.log

# 统计今天的错误数
grep "$(date +%Y-%m-%d)" /root/payment-points-backend/logs/error.log | wc -l
```

#### Nginx日志
```bash
# 访问日志
tail -f /var/log/nginx/points-api-access.log

# 错误日志
tail -f /var/log/nginx/points-api-error.log

# 分析访问量最高的IP
awk '{print $1}' /var/log/nginx/points-api-access.log | sort | uniq -c | sort -rn | head -10
```

#### 系统日志
```bash
# 查看系统日志
sudo journalctl -xe

# 查看特定服务日志
sudo journalctl -u pm2-root

# 实时查看
sudo journalctl -f
```

### 2. 性能监控

```bash
# 服务器资源监控
htop

# 磁盘使用
df -h

# 内存使用
free -m

# 网络连接
netstat -tunlp

# PM2进程监控
pm2 monit

# PM2日志
pm2 logs
```

### 3. 数据库维护

```bash
# 检查数据库大小
mysql -u points_app_user -p -e "
SELECT
  table_schema AS 'Database',
  ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = 'points_app_prod'
GROUP BY table_schema;
"

# 优化表
mysql -u points_app_user -p points_app_prod -e "OPTIMIZE TABLE payment_orders;"

# 查看慢查询
sudo cat /var/log/mysql/slow.log
```

### 4. 安全检查清单

#### 每日检查
- [ ] 查看应用错误日志
- [ ] 检查PM2进程状态
- [ ] 查看服务器资源使用

#### 每周检查
- [ ] 查看Nginx访问日志，分析异常IP
- [ ] 检查Fail2ban封禁记录
- [ ] 查看数据库慢查询日志
- [ ] 检查磁盘空间使用

#### 每月检查
- [ ] 更新系统安全补丁
- [ ] 检查SSL证书有效期
- [ ] 审查数据库备份
- [ ] 检查防火墙规则
- [ ] 审查用户权限

### 5. 应急响应

#### 发现异常访问
```bash
# 1. 查看异常IP
tail -100 /var/log/nginx/points-api-access.log | grep "POST"

# 2. 封禁IP
sudo ufw deny from 异常IP

# 3. 查看Fail2ban状态
sudo fail2ban-client status sshd
```

#### 数据库被攻击
```bash
# 1. 立即停止数据库
sudo systemctl stop mysql

# 2. 检查数据完整性
# 3. 从备份恢复
# 4. 修改所有密码
# 5. 检查安全漏洞
```

#### 服务器负载过高
```bash
# 1. 查看进程
top

# 2. 重启服务
pm2 restart all

# 3. 重启Nginx
sudo systemctl restart nginx

# 4. 必要时重启服务器
sudo reboot
```

---

## 安全检查工具

### 1. 安装安全扫描工具

```bash
# 安装Lynis（安全审计工具）
sudo apt install lynis

# 运行安全审计
sudo lynis audit system

# 查看报告
sudo cat /var/log/lynis.log
```

### 2. 检查开放端口

```bash
# 查看监听端口
sudo netstat -tunlp

# 使用nmap扫描（外部）
nmap -sV your_server_ip
```

### 3. 检查文件权限

```bash
# 检查关键文件权限
ls -l /root/payment-points-backend/.env
ls -l /etc/nginx/sites-available/points-api
ls -l /root/backup-db.sh
```

---

## 总结

### ✅ 完成清单

部署完成后，确保以下项目都已完成：

#### 数据库安全
- [ ] 创建专用数据库用户（非root）
- [ ] 设置强密码
- [ ] 限制用户权限
- [ ] 配置MySQL只允许本地连接
- [ ] 配置自动备份

#### 服务器安全
- [ ] 更新系统
- [ ] 配置SSH安全（禁用root，使用密钥）
- [ ] 配置防火墙（UFW）
- [ ] 安装Fail2ban
- [ ] 限制不必要的端口

#### 应用安全
- [ ] 创建.env文件
- [ ] 生成强JWT密钥
- [ ] 配置ALLOWED_ORIGINS
- [ ] 设置合理的限流参数
- [ ] .env文件权限设为600

#### HTTPS配置
- [ ] 安装SSL证书
- [ ] 配置Nginx反向代理
- [ ] 配置HTTPS重定向
- [ ] 配置安全响应头
- [ ] 设置证书自动续期

#### 监控与维护
- [ ] 配置日志轮转
- [ ] 设置监控告警
- [ ] 配置数据库备份
- [ ] 文档化应急响应流程

---

**安全是持续的过程，不是一次性的任务！** 🔒

定期审查和更新安全配置，保持系统安全性。
