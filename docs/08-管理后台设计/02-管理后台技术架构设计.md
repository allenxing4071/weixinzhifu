# 积分管理后台技术架构设计文档

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月
- **技术负责人**：后端开发团队
- **评审状态**：待技术评审

---

## 🏗 整体技术架构

### 系统架构图
```
┌─────────────────────────────────────────────────────────┐
│                    管理后台前端                          │
│  React + TypeScript + Ant Design Pro + ECharts        │
├─────────────────────────────────────────────────────────┤
│                     Nginx                              │
│              (静态文件 + API代理)                        │
├─────────────────────────────────────────────────────────┤
│                   后端API服务                           │
│     Express.js + TypeScript (扩展现有API)              │
├─────────────────────────────────────────────────────────┤
│              数据层 (复用现有架构)                       │
│     MySQL 8.0 + Redis 6.0 + 业务数据表                │
└─────────────────────────────────────────────────────────┘
```

### 技术选型说明

#### 前端技术栈
- **React 18**：主流框架，生态成熟
- **TypeScript**：类型安全，提升开发效率
- **Ant Design Pro**：企业级管理后台解决方案
- **ECharts**：强大的数据可视化库
- **Redux Toolkit**：状态管理
- **React Query**：服务端状态管理

#### 后端技术栈（扩展现有）
- **Express.js**：复用现有框架
- **TypeScript**：保持技术栈一致性
- **JWT认证**：扩展支持管理员认证
- **RBAC权限模型**：基于角色的访问控制
- **数据验证**：Joi参数验证

---

## 🗄️ 数据库设计

### 新增管理后台相关表

#### 1. 管理员表 (admins)
```sql
CREATE TABLE admins (
  id VARCHAR(50) PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
  real_name VARCHAR(100) NOT NULL COMMENT '真实姓名',
  email VARCHAR(100) COMMENT '邮箱',
  phone VARCHAR(20) COMMENT '手机号',
  role_id VARCHAR(50) NOT NULL COMMENT '角色ID',
  status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
  last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
  last_login_ip VARCHAR(45) NULL COMMENT '最后登录IP',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (role_id) REFERENCES admin_roles(id),
  INDEX idx_username (username),
  INDEX idx_status (status),
  INDEX idx_role (role_id)
);
```

#### 2. 角色表 (admin_roles)
```sql
CREATE TABLE admin_roles (
  id VARCHAR(50) PRIMARY KEY,
  role_name VARCHAR(100) NOT NULL UNIQUE COMMENT '角色名称',
  role_code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色代码',
  description TEXT COMMENT '角色描述',
  permissions JSON COMMENT '权限列表',
  status ENUM('active', 'inactive') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_role_code (role_code),
  INDEX idx_status (status)
);
```

#### 3. 管理日志表 (admin_logs)
```sql
CREATE TABLE admin_logs (
  id VARCHAR(50) PRIMARY KEY,
  admin_id VARCHAR(50) NOT NULL COMMENT '管理员ID',
  action VARCHAR(100) NOT NULL COMMENT '操作类型',
  resource VARCHAR(100) COMMENT '操作资源',
  resource_id VARCHAR(50) COMMENT '资源ID',
  details JSON COMMENT '操作详情',
  ip_address VARCHAR(45) COMMENT 'IP地址',
  user_agent TEXT COMMENT '用户代理',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (admin_id) REFERENCES admins(id),
  INDEX idx_admin_id (admin_id),
  INDEX idx_action (action),
  INDEX idx_created_at (created_at)
);
```

#### 4. 系统配置表 (system_config)
```sql
CREATE TABLE system_config (
  id VARCHAR(50) PRIMARY KEY,
  config_key VARCHAR(100) NOT NULL UNIQUE COMMENT '配置键',
  config_value TEXT COMMENT '配置值',
  config_type ENUM('string', 'number', 'boolean', 'json') DEFAULT 'string',
  description VARCHAR(255) COMMENT '配置描述',
  is_public BOOLEAN DEFAULT FALSE COMMENT '是否公开配置',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_config_key (config_key),
  INDEX idx_is_public (is_public)
);
```

### 数据视图扩展

#### 管理后台统计视图
```sql
-- 用户统计概览
CREATE VIEW v_admin_user_stats AS
SELECT 
  COUNT(*) as total_users,
  COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,
  COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_users,
  AVG(points_balance) as avg_points_balance,
  SUM(points_balance) as total_points_balance
FROM users;

-- 商户统计概览
CREATE VIEW v_admin_merchant_stats AS
SELECT 
  COUNT(*) as total_merchants,
  COUNT(CASE WHEN status = 'active' THEN 1 END) as active_merchants,
  COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_new_merchants,
  SUM(total_amount) as total_transaction_amount,
  SUM(total_orders) as total_orders
FROM merchants;

-- 支付统计概览
CREATE VIEW v_admin_payment_stats AS
SELECT 
  COUNT(*) as total_orders,
  COUNT(CASE WHEN status = 'paid' THEN 1 END) as paid_orders,
  COUNT(CASE WHEN DATE(created_at) = CURDATE() THEN 1 END) as today_orders,
  SUM(CASE WHEN status = 'paid' THEN amount ELSE 0 END) as total_paid_amount,
  AVG(CASE WHEN status = 'paid' THEN amount ELSE NULL END) as avg_order_amount
FROM payment_orders;
```

---

## 🔐 安全架构设计

### 认证机制
```typescript
// JWT Token结构
interface AdminToken {
  adminId: string
  username: string
  roleId: string
  permissions: string[]
  sessionId: string
  exp: number
  iat: number
}
```

### 权限控制
```typescript
// 权限枚举
enum Permission {
  // 用户管理
  USER_VIEW = 'user:view',
  USER_EDIT = 'user:edit',
  USER_DELETE = 'user:delete',
  
  // 商户管理
  MERCHANT_VIEW = 'merchant:view',
  MERCHANT_APPROVE = 'merchant:approve',
  MERCHANT_EDIT = 'merchant:edit',
  
  // 积分管理
  POINTS_VIEW = 'points:view',
  POINTS_ADJUST = 'points:adjust',
  POINTS_CONFIG = 'points:config',
  
  // 订单管理
  ORDER_VIEW = 'order:view',
  ORDER_REFUND = 'order:refund',
  
  // 系统管理
  SYSTEM_CONFIG = 'system:config',
  SYSTEM_LOGS = 'system:logs',
  
  // 财务管理
  FINANCE_VIEW = 'finance:view',
  FINANCE_EXPORT = 'finance:export'
}
```

### API安全设计
```typescript
// 权限中间件
const requirePermission = (permission: Permission) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const token = req.headers.authorization?.replace('Bearer ', '')
    const decoded = jwt.verify(token, JWT_SECRET) as AdminToken
    
    if (!decoded.permissions.includes(permission)) {
      return res.status(403).json({
        success: false,
        code: 'INSUFFICIENT_PERMISSIONS',
        message: '权限不足'
      })
    }
    
    // 记录操作日志
    await AdminLogService.log({
      adminId: decoded.adminId,
      action: req.method + ' ' + req.path,
      ip: req.ip,
      userAgent: req.get('User-Agent')
    })
    
    next()
  }
}
```

---

## 🌐 前端架构设计

### 项目结构
```
admin-frontend/
├── src/
│   ├── components/          # 通用组件
│   │   ├── Charts/         # 图表组件
│   │   ├── Forms/          # 表单组件
│   │   └── Tables/         # 表格组件
│   ├── pages/              # 页面组件
│   │   ├── Dashboard/      # 仪表板
│   │   ├── Users/          # 用户管理
│   │   ├── Merchants/      # 商户管理
│   │   ├── Points/         # 积分管理
│   │   ├── Orders/         # 订单管理
│   │   └── Settings/       # 系统设置
│   ├── services/           # API服务
│   ├── utils/              # 工具函数
│   ├── hooks/              # 自定义Hooks
│   ├── store/              # 状态管理
│   └── types/              # TypeScript类型
├── public/
└── package.json
```

### 核心服务设计
```typescript
// API服务基类
class AdminApiService {
  private baseURL = 'http://8.156.84.226/api/v1/admin'
  
  // 用户管理API
  users = {
    list: (params: UserListParams) => this.get('/users', params),
    detail: (id: string) => this.get(`/users/${id}`),
    update: (id: string, data: UpdateUserData) => this.put(`/users/${id}`, data),
    adjustPoints: (id: string, points: number, reason: string) => 
      this.post(`/users/${id}/points/adjust`, { points, reason })
  }
  
  // 商户管理API
  merchants = {
    list: (params: MerchantListParams) => this.get('/merchants', params),
    approve: (id: string, approved: boolean) => 
      this.post(`/merchants/${id}/approve`, { approved }),
    stats: (id: string) => this.get(`/merchants/${id}/stats`)
  }
  
  // 积分管理API
  points = {
    stats: (params: StatsParams) => this.get('/points/stats', params),
    records: (params: RecordParams) => this.get('/points/records', params),
    config: () => this.get('/points/config'),
    updateConfig: (config: PointsConfig) => this.put('/points/config', config)
  }
}
```

---

## 📊 数据可视化设计

### 仪表板图表配置
```typescript
// 支付趋势图配置
const paymentTrendChart = {
  type: 'line',
  data: {
    xAxis: ['今日', '昨日', '前日', '3日前', '4日前', '5日前', '6日前'],
    series: [
      {
        name: '支付金额',
        data: [12000, 15000, 8000, 18000, 22000, 16000, 19000],
        color: '#1890ff'
      },
      {
        name: '支付订单数',
        data: [120, 150, 80, 180, 220, 160, 190],
        color: '#52c41a'
      }
    ]
  }
}

// 积分分布饼图
const pointsDistributionChart = {
  type: 'pie',
  data: [
    { name: '活跃用户积分', value: 400000 },
    { name: '沉睡用户积分', value: 200000 },
    { name: '即将过期积分', value: 50000 }
  ]
}
```

### 数据刷新策略
```typescript
// 实时数据刷新配置
const dataRefreshConfig = {
  dashboard: {
    interval: 5 * 60 * 1000,  // 5分钟
    apis: ['stats/overview', 'stats/trends']
  },
  userList: {
    interval: 30 * 1000,     // 30秒
    condition: 'onFocus'     // 页面获得焦点时刷新
  },
  systemMonitor: {
    interval: 10 * 1000,     // 10秒
    apis: ['system/health', 'system/performance']
  }
}
```

---

## 🔌 API接口设计

### RESTful API规范

#### 管理员认证接口
```typescript
// 管理员登录
POST /api/v1/admin/auth/login
{
  "username": "admin",
  "password": "password",
  "captcha": "1234"
}

// 响应
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "adminInfo": {
      "id": "admin_001",
      "username": "admin",
      "realName": "张三",
      "role": "super_admin",
      "permissions": ["user:view", "user:edit", ...]
    }
  }
}
```

#### 用户管理接口
```typescript
// 用户列表查询
GET /api/v1/admin/users?page=1&pageSize=20&status=active&keyword=search

// 用户详情
GET /api/v1/admin/users/:id

// 调整用户积分
POST /api/v1/admin/users/:id/points/adjust
{
  "points": 100,
  "reason": "活动奖励",
  "type": "add"
}
```

#### 商户管理接口
```typescript
// 商户审核
POST /api/v1/admin/merchants/:id/approve
{
  "approved": true,
  "comment": "审核通过"
}

// 商户数据统计
GET /api/v1/admin/merchants/:id/stats?startDate=2024-01-01&endDate=2024-12-31
```

#### 数据统计接口
```typescript
// 仪表板数据
GET /api/v1/admin/dashboard/stats

// 响应结构
{
  "success": true,
  "data": {
    "overview": {
      "totalUsers": 10000,
      "activeUsers": 8500,
      "totalMerchants": 150,
      "todayOrders": 1200,
      "todayAmount": 580000,
      "todayPoints": 580000
    },
    "trends": {
      "userGrowth": [...],
      "paymentTrend": [...],
      "pointsTrend": [...]
    },
    "alerts": [
      {
        "type": "warning",
        "message": "今日支付异常率偏高",
        "value": "3.2%"
      }
    ]
  }
}
```

---

## 🛡️ 安全架构实现

### 认证流程设计
```typescript
// 管理员认证服务
class AdminAuthService {
  static async login(username: string, password: string) {
    // 1. 验证用户名密码
    const admin = await AdminModel.findByUsername(username)
    if (!admin || !await bcrypt.compare(password, admin.passwordHash)) {
      throw new Error('用户名或密码错误')
    }
    
    // 2. 检查账号状态
    if (admin.status !== 'active') {
      throw new Error('账号已被禁用')
    }
    
    // 3. 生成会话
    const sessionId = generateSessionId()
    await redis.setex(`admin_session:${sessionId}`, 7200, admin.id)
    
    // 4. 生成JWT
    const token = jwt.sign({
      adminId: admin.id,
      username: admin.username,
      roleId: admin.roleId,
      sessionId,
      permissions: await this.getAdminPermissions(admin.roleId)
    }, JWT_SECRET, { expiresIn: '2h' })
    
    // 5. 记录登录日志
    await AdminLogService.log({
      adminId: admin.id,
      action: 'LOGIN',
      ip: req.ip
    })
    
    return { token, adminInfo: admin }
  }
}
```

### 权限验证中间件
```typescript
// 权限装饰器
const RequirePermission = (permission: Permission) => {
  return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {
    const originalMethod = descriptor.value
    
    descriptor.value = async function(req: Request, res: Response, next: NextFunction) {
      try {
        const hasPermission = await checkPermission(req.user, permission)
        if (!hasPermission) {
          return res.status(403).json({
            success: false,
            code: 'INSUFFICIENT_PERMISSIONS',
            message: '权限不足'
          })
        }
        
        return await originalMethod.call(this, req, res, next)
      } catch (error) {
        next(error)
      }
    }
    
    return descriptor
  }
}
```

---

## 📱 前端组件架构

### 核心组件设计

#### 1. 数据表格组件
```typescript
interface AdminTableProps<T> {
  columns: ColumnConfig[]
  dataSource: T[]
  loading?: boolean
  pagination?: PaginationConfig
  selection?: SelectionConfig
  actions?: ActionConfig[]
  onSearch?: (params: SearchParams) => void
  onExport?: () => void
}

const AdminTable = <T,>({ 
  columns, 
  dataSource, 
  loading,
  ...props 
}: AdminTableProps<T>) => {
  // 表格实现
}
```

#### 2. 统计卡片组件
```typescript
interface StatsCardProps {
  title: string
  value: number | string
  trend?: {
    value: number
    type: 'up' | 'down'
    period: string
  }
  icon?: ReactNode
  color?: string
  loading?: boolean
}

const StatsCard: React.FC<StatsCardProps> = ({ 
  title, 
  value, 
  trend, 
  icon,
  color = '#1890ff',
  loading = false 
}) => {
  // 卡片实现
}
```

#### 3. 图表容器组件
```typescript
interface ChartContainerProps {
  title: string
  type: 'line' | 'bar' | 'pie' | 'area'
  data: ChartData
  height?: number
  loading?: boolean
  refreshInterval?: number
  onRefresh?: () => void
}

const ChartContainer: React.FC<ChartContainerProps> = ({
  title,
  type,
  data,
  height = 400,
  loading = false,
  refreshInterval,
  onRefresh
}) => {
  // 图表实现
}
```

---

## 🚀 部署架构

### 前后端分离部署
```
┌─────────────────────────────────────────┐
│              CDN / 阿里云OSS             │
│            (静态资源分发)                │
├─────────────────────────────────────────┤
│                Nginx                   │
│     ┌─────────────┬─────────────────┐    │
│     │   前端静态   │    API代理      │    │
│     │   文件服务   │   (后端接口)    │    │
│     └─────────────┴─────────────────┘    │
├─────────────────────────────────────────┤
│              Node.js API               │
│          (Express + TypeScript)        │
├─────────────────────────────────────────┤
│         MySQL + Redis                  │
│        (复用现有数据库)                  │
└─────────────────────────────────────────┘
```

### 构建部署流程
```bash
# 前端构建
cd admin-frontend
npm run build
# 生成 dist/ 目录

# 部署到服务器
scp -r dist/* root@8.156.84.226:/var/www/admin/

# 后端API扩展
cd backend
# 添加管理后台API路由
# 扩展现有Express应用

# 重启服务
pm2 restart points-api-simple
```

---

## 📋 开发里程碑

### 里程碑1：文档设计完成（1周）
- ✅ PRD文档完成
- ✅ 技术架构设计完成
- ✅ UI/UX设计稿完成
- ✅ API接口文档完成

### 里程碑2：基础框架完成（2周）
- [ ] 前端项目脚手架搭建
- [ ] 管理员认证系统
- [ ] 权限管理框架
- [ ] 基础页面布局

### 里程碑3：核心功能完成（4周）
- [ ] 仪表板页面
- [ ] 用户管理模块
- [ ] 商户管理模块
- [ ] 积分管理模块

### 里程碑4：高级功能完成（3周）
- [ ] 数据统计报表
- [ ] 系统监控页面
- [ ] 操作日志管理
- [ ] 系统配置管理

### 里程碑5：测试部署完成（1周）
- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 生产环境部署

---

## 🎯 技术实施建议

### 开发优先级
1. **高优先级**：登录认证、仪表板、用户管理
2. **中优先级**：商户管理、积分管理、订单管理
3. **低优先级**：高级报表、系统监控、营销功能

### 技术债务控制
1. **代码规范**：ESLint + Prettier统一代码风格
2. **单元测试**：关键业务逻辑测试覆盖率≥80%
3. **文档同步**：代码和文档同步更新
4. **性能监控**：前端性能和API性能监控

---

**文档状态**：待技术团队评审  
**下一步行动**：UI/UX设计和前端技术选型细化  
**责任人**：技术负责人  
**预计开发时间**：10周（2.5个月）
