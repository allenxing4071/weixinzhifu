# å•†æˆ·ç®¡ç†ç³»ç»Ÿå®æ–½æ–¹æ¡ˆ

## ğŸ“– æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**ï¼šV1.0  
- **çŠ¶æ€**ï¼šåŸºäºç°æœ‰åŠŸèƒ½ä¼˜åŒ–

---

## ğŸ¯ å½“å‰çŠ¶æ€å’Œå¿«é€Ÿä¸Šçº¿æ–¹æ¡ˆ

### **ç°æœ‰åŠŸèƒ½çŠ¶æ€**
âœ… å•†æˆ·åŸºç¡€CRUDï¼ˆ9ä¸ªå­—æ®µï¼‰  
âœ… MockWechatApiServiceï¼ˆ5ä¸ªçœŸå®å•†æˆ·æ•°æ®ï¼‰  
âœ… Reactç®¡ç†åå°ç•Œé¢  
âœ… åŸºç¡€ç»Ÿè®¡åŠŸèƒ½  

### **ç«‹å³è¦è§£å†³çš„é—®é¢˜**
1. **å•†æˆ·è¡¨ç¼ºå°‘å…³é”®å­—æ®µ** - éœ€è¦`applyment_id`
2. **äºŒç»´ç ç”ŸæˆåŠŸèƒ½** - åŸºäºç°æœ‰`sub_mch_id`
3. **æ•°æ®å®Œæ•´æ€§** - è¡¥å……ç°æœ‰5ä¸ªå•†æˆ·çš„ä¿¡æ¯

### **å¿«é€Ÿä¸Šçº¿è®¡åˆ’**
ç›®æ ‡ï¼š1å‘¨å†…åŸºäºç°æœ‰åŠŸèƒ½ä¸Šçº¿åŸºç¡€ç‰ˆæœ¬

---

## ğŸ—„ï¸ æ•°æ®åº“ä¼˜åŒ–ï¼ˆåŸºäºç°æœ‰è¡¨ç»“æ„ï¼‰

### å½“å‰å•†æˆ·è¡¨ç»“æ„
```sql
-- ç°æœ‰å­—æ®µï¼ˆä¿æŒä¸å˜ï¼‰
CREATE TABLE merchants (
  id VARCHAR(50) PRIMARY KEY,
  merchant_name VARCHAR(128) NOT NULL,
  merchant_no VARCHAR(32) UNIQUE NOT NULL,
  contact_person VARCHAR(64) NOT NULL,
  contact_phone VARCHAR(16) NOT NULL,
  business_license VARCHAR(64) NOT NULL,
  status ENUM('active', 'inactive', 'pending') DEFAULT 'pending',
  qr_code VARCHAR(512),
  sub_mch_id VARCHAR(32),
  total_amount DECIMAL(15,2) DEFAULT 0.00,
  total_orders INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### ç«‹å³æ·»åŠ çš„å­—æ®µï¼ˆæœ€å°å¿…è¦ï¼‰
```sql
-- æ·»åŠ å¾®ä¿¡ç”³è¯·å•å·ï¼ˆç”ŸæˆäºŒç»´ç å¿…éœ€ï¼‰
ALTER TABLE merchants ADD COLUMN applyment_id VARCHAR(64);

-- æ·»åŠ å¯é€‰çš„è¡¥å……å­—æ®µ
ALTER TABLE merchants ADD COLUMN merchant_type VARCHAR(32) DEFAULT 'INDIVIDUAL';
ALTER TABLE merchants ADD COLUMN contact_email VARCHAR(128);
```

### ç°æœ‰å•†æˆ·æ•°æ®æ›´æ–°
åŸºäºMockWechatApiServiceä¸­çš„5ä¸ªçœŸå®å•†æˆ·ï¼Œè¡¥å……`applyment_id`ï¼š

```sql
-- æ›´æ–°ç°æœ‰5ä¸ªå•†æˆ·çš„ç”³è¯·å•å·
UPDATE merchants SET applyment_id = '2000002691156098' WHERE merchant_name = 'ä»å¯¿å¿æ€€ä»è¡—é“äº‘é”¦æ±‡ä¼šæ‰€ï¼ˆä¸ªä½“å·¥å•†æˆ·ï¼‰';
UPDATE merchants SET applyment_id = '2000002690858917' WHERE merchant_name = 'ä»å¯¿å¿æ€€ä»è¡—é“å‚¨åºœé±¼åº„åº—ï¼ˆä¸ªä½“å·¥å•†æˆ·ï¼‰';
UPDATE merchants SET applyment_id = '2000002690623402' WHERE merchant_name = 'ä»å¯¿å¿æ€€ä»è¡—é“é¢å–„æ»‹å…»å›­å…»ç”Ÿé¦†ï¼ˆä¸ªä½“å·¥å•†æˆ·ï¼‰';
UPDATE merchants SET applyment_id = '2000002690164951' WHERE merchant_name = 'æˆéƒ½å¸‚ä¸­é‘«åšæµ·å›½é™…é…’ä¸šè´¸æ˜“æœ‰é™å…¬å¸';
UPDATE merchants SET applyment_id = '2000002689372247' WHERE merchant_name = 'å¾·é˜³å¸‚åæ€ç§‘æŠ€æœ‰é™å…¬å¸';
```

---

## ğŸ”§ å•†æˆ·æ¨¡å‹ä¼˜åŒ–ï¼ˆåŸºäºç°æœ‰ä»£ç ï¼‰

### å½“å‰Merchantæ¥å£ï¼ˆä¿æŒï¼‰
```typescript
export interface Merchant {
  id: string
  merchantName: string
  merchantNo: string
  contactPerson: string
  contactPhone: string
  businessLicense: string
  status: 'active' | 'inactive' | 'pending'
  qrCode?: string // æ”¶æ¬¾äºŒç»´ç 
  subMchId?: string // å¾®ä¿¡æ”¯ä»˜ç‰¹çº¦å•†æˆ·å·
  totalAmount: number // æ€»æ”¶æ¬¾é‡‘é¢
  totalOrders: number // æ€»è®¢å•æ•°
  createdAt: Date
  updatedAt: Date
}
```

### æ·»åŠ çš„å­—æ®µ
```typescript
export interface EnhancedMerchant extends Merchant {
  applymentId?: string // å¾®ä¿¡ç”³è¯·å•å·
  merchantType?: string // å•†æˆ·ç±»å‹
  contactEmail?: string // è”ç³»é‚®ç®±
}
```

### å•†æˆ·æ¨¡å‹ç±»æ–°å¢æ–¹æ³•
```typescript
// åœ¨ç°æœ‰MerchantModelç±»ä¸­æ·»åŠ 
export class MerchantModel {
  /**
   * æ›´æ–°å¾®ä¿¡ç”³è¯·å•å·
   */
  static async updateApplymentId(merchantId: string, applymentId: string): Promise<boolean> {
    const connection = await getDBConnection()
    
    const [result] = await connection.execute<ResultSetHeader>(
      'UPDATE merchants SET applyment_id = ?, updated_at = NOW() WHERE id = ?',
      [applymentId, merchantId]
    )
    
    return result.affectedRows > 0
  }
  
  /**
   * æ£€æŸ¥å•†æˆ·æ˜¯å¦å¯ä»¥ç”ŸæˆäºŒç»´ç 
   */
  static async checkQRCodeEligibility(merchantId: string): Promise<{
    eligible: boolean;
    message: string;
  }> {
    const merchant = await this.findById(merchantId)
    
    if (!merchant) {
      return { eligible: false, message: 'å•†æˆ·ä¸å­˜åœ¨' }
    }
    
    if (merchant.status !== 'active') {
      return { eligible: false, message: 'å•†æˆ·çŠ¶æ€ä¸æ˜¯active' }
    }
    
    if (!merchant.subMchId) {
      return { eligible: false, message: 'ç¼ºå°‘å¾®ä¿¡ç‰¹çº¦å•†æˆ·å·' }
    }
    
    return { eligible: true, message: 'å¯ä»¥ç”ŸæˆäºŒç»´ç ' }
  }
}
```

---

## ğŸš€ äºŒç»´ç ç”ŸæˆåŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰

### åŸºäºç°æœ‰ä»£ç çš„å®ç°
```typescript
export class SimpleMerchantQRCodeService {
  /**
   * ä¸ºå•†æˆ·ç”Ÿæˆæ”¶æ¬¾äºŒç»´ç ï¼ˆåŸºç¡€ç‰ˆï¼‰
   */
  async generateQRCode(merchantId: string): Promise<{
    success: boolean;
    qrCodeUrl?: string;
    message?: string;
  }> {
    try {
      // 1. æ£€æŸ¥å•†æˆ·èµ„æ ¼
      const eligibility = await MerchantModel.checkQRCodeEligibility(merchantId)
      if (!eligibility.eligible) {
        return { success: false, message: eligibility.message }
      }
      
      const merchant = await MerchantModel.findById(merchantId)
      
      // 2. ç”ŸæˆäºŒç»´ç å†…å®¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const qrContent = `weixin://wxpay/bizpayurl?pr=${merchant?.subMchId}_${Date.now()}`
      
      // 3. ä½¿ç”¨qrcodeåº“ç”Ÿæˆå›¾ç‰‡
      const qrCodeBuffer = await QRCode.toBuffer(qrContent)
      
      // 4. ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆæˆ–äº‘å­˜å‚¨ï¼‰
      const fileName = `qrcode_${merchantId}_${Date.now()}.png`
      const qrCodeUrl = `/uploads/qrcodes/${fileName}`
      
      // 5. æ›´æ–°å•†æˆ·äºŒç»´ç ä¿¡æ¯
      await MerchantModel.updateQRCode(merchantId, qrCodeUrl)
      
      return {
        success: true,
        qrCodeUrl,
        message: 'äºŒç»´ç ç”ŸæˆæˆåŠŸ'
      }
      
    } catch (error: any) {
      return {
        success: false,
        message: `ç”Ÿæˆå¤±è´¥: ${error.message}`
      }
    }
  }
}
```

---

## ğŸ“± ç®¡ç†åå°åŠŸèƒ½å¢å¼º

### åŸºäºç°æœ‰Reactä»£ç çš„æ”¹è¿›

#### 1. å•†æˆ·åˆ—è¡¨é¡µé¢å¢åŠ åŠŸèƒ½
```typescript
// åœ¨ç°æœ‰MerchantsPageç»„ä»¶ä¸­æ·»åŠ 
const handleGenerateQRCode = async (merchantId: string) => {
  try {
    const result = await apiRequest(`/admin/merchants/${merchantId}/generate-qrcode`, {
      method: 'POST'
    })
    
    if (result.success) {
      message.success('äºŒç»´ç ç”ŸæˆæˆåŠŸ')
      loadMerchants() // åˆ·æ–°åˆ—è¡¨
    } else {
      message.error(result.message)
    }
  } catch (error) {
    message.error('ç”Ÿæˆå¤±è´¥')
  }
}

// åœ¨è¡¨æ ¼columnsä¸­æ·»åŠ æ“ä½œåˆ—
{
  title: 'æ“ä½œ',
  key: 'action',
  render: (_, record) => (
    <Space>
      <Button 
        type="primary" 
        size="small"
        disabled={!record.subMchId || record.status !== 'active'}
        onClick={() => handleGenerateQRCode(record.id)}
      >
        ç”ŸæˆäºŒç»´ç 
      </Button>
    </Space>
  )
}
```

#### 2. æ–°å¢å•†æˆ·ç¼–è¾‘é¡µé¢
```typescript
const EditMerchantPage = ({ merchantId }) => {
  const [form] = Form.useForm()
  const [loading, setLoading] = useState(false)
  
  const handleSubmit = async (values) => {
    setLoading(true)
    try {
      const result = await apiRequest(`/admin/merchants/${merchantId}`, {
        method: 'PUT',
        body: JSON.stringify(values)
      })
      
      if (result.success) {
        message.success('æ›´æ–°æˆåŠŸ')
      }
    } catch (error) {
      message.error('æ›´æ–°å¤±è´¥')
    }
    setLoading(false)
  }
  
  return (
    <Form form={form} onFinish={handleSubmit}>
      <Form.Item name="merchantName" label="å•†æˆ·åç§°" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactPerson" label="è”ç³»äºº" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactPhone" label="è”ç³»ç”µè¯" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactEmail" label="è”ç³»é‚®ç®±">
        <Input />
      </Form.Item>
      <Form.Item name="applymentId" label="å¾®ä¿¡ç”³è¯·å•å·">
        <Input />
      </Form.Item>
      <Form.Item name="subMchId" label="ç‰¹çº¦å•†æˆ·å·">
        <Input />
      </Form.Item>
      <Button type="primary" htmlType="submit" loading={loading}>
        ä¿å­˜
      </Button>
    </Form>
  )
}
```

---

## ğŸ”— APIæ¥å£è®¾è®¡ï¼ˆåŸºäºç°æœ‰è·¯ç”±ï¼‰

### åœ¨ç°æœ‰è·¯ç”±åŸºç¡€ä¸Šæ·»åŠ 
```typescript
// åœ¨ /api/v1/admin/merchants è·¯ç”±ä¸­æ·»åŠ 

// ç”ŸæˆäºŒç»´ç 
router.post('/:merchantId/generate-qrcode', async (req, res) => {
  try {
    const { merchantId } = req.params
    const qrCodeService = new SimpleMerchantQRCodeService()
    const result = await qrCodeService.generateQRCode(merchantId)
    res.json(result)
  } catch (error) {
    res.status(500).json({ success: false, message: error.message })
  }
})

// æ›´æ–°å•†æˆ·ä¿¡æ¯
router.put('/:merchantId', async (req, res) => {
  try {
    const { merchantId } = req.params
    const updateData = req.body
    
    // éªŒè¯å­—æ®µ
    const allowedFields = ['merchantName', 'contactPerson', 'contactPhone', 'contactEmail', 'applymentId', 'subMchId']
    const filteredData = Object.keys(updateData)
      .filter(key => allowedFields.includes(key))
      .reduce((obj, key) => ({ ...obj, [key]: updateData[key] }), {})
    
    const success = await MerchantModel.update(merchantId, filteredData)
    
    if (success) {
      res.json({ success: true, message: 'æ›´æ–°æˆåŠŸ' })
    } else {
      res.json({ success: false, message: 'æ›´æ–°å¤±è´¥' })
    }
  } catch (error) {
    res.status(500).json({ success: false, message: error.message })
  }
})
```

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### Phase 1: ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨å†…ï¼‰
- [ ] æ‰§è¡Œæ•°æ®åº“ALTERè¯­å¥æ·»åŠ å­—æ®µ
- [ ] æ›´æ–°5ä¸ªå•†æˆ·çš„applyment_id
- [ ] åœ¨MerchantModelä¸­æ·»åŠ æ–°æ–¹æ³•
- [ ] å®ç°SimpleMerchantQRCodeService
- [ ] åœ¨ç®¡ç†åå°æ·»åŠ ç”ŸæˆäºŒç»´ç æŒ‰é’®
- [ ] æµ‹è¯•äºŒç»´ç ç”ŸæˆåŠŸèƒ½

### éªŒæ”¶æ ‡å‡†
- [ ] å•†æˆ·è¡¨æ–°å¢3ä¸ªå­—æ®µ
- [ ] 5ä¸ªå•†æˆ·æ•°æ®å®Œæ•´
- [ ] æœ‰sub_mch_idçš„å•†æˆ·å¯ä»¥ç”ŸæˆäºŒç»´ç 
- [ ] ç®¡ç†åå°æ˜¾ç¤ºç”ŸæˆæŒ‰é’®ä¸”å¯ç”¨

### Phase 2: åç»­ä¼˜åŒ–ï¼ˆä¸‹å‘¨ï¼‰
- [ ] å®Œå–„å•†æˆ·ç¼–è¾‘åŠŸèƒ½
- [ ] å¢åŠ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- [ ] ä¼˜åŒ–äºŒç»´ç ç”Ÿæˆé€»è¾‘
- [ ] æ·»åŠ æ“ä½œæ—¥å¿—

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸ç ´åç°æœ‰åŠŸèƒ½** - æ‰€æœ‰ä¿®æ”¹éƒ½åŸºäºç°æœ‰ä»£ç æ‰©å±•
2. **æ•°æ®å®‰å…¨** - æ‰§è¡ŒSQLå‰å¤‡ä»½æ•°æ®åº“
3. **æ¸è¿›å¼æ”¹è¿›** - å…ˆå®ç°åŸºç¡€åŠŸèƒ½ï¼Œå†ä¼˜åŒ–
4. **ä¿æŒç®€å•** - é¿å…è¿‡åº¦è®¾è®¡ï¼Œä¸“æ³¨å¿«é€Ÿä¸Šçº¿

---

**æ–‡æ¡£çŠ¶æ€**ï¼šä¸ç°æœ‰ä»£ç åŒ¹é…  
**å®æ–½æ—¶é—´**ï¼š1å‘¨å†…å®Œæˆ  
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ