# 商户管理系统实施方案

## 📖 文档信息
- **版本**：V1.0  
- **状态**：基于现有功能优化

---

## 🎯 当前状态和快速上线方案

### **现有功能状态**
✅ 商户基础CRUD（9个字段）  
✅ MockWechatApiService（5个真实商户数据）  
✅ React管理后台界面  
✅ 基础统计功能  

### **立即要解决的问题**
1. **商户表缺少关键字段** - 需要`applyment_id`
2. **二维码生成功能** - 基于现有`sub_mch_id`
3. **数据完整性** - 补充现有5个商户的信息

### **快速上线计划**
目标：1周内基于现有功能上线基础版本

---

## 🗄️ 数据库优化（基于现有表结构）

### 当前商户表结构
```sql
-- 现有字段（保持不变）
CREATE TABLE merchants (
  id VARCHAR(50) PRIMARY KEY,
  merchant_name VARCHAR(128) NOT NULL,
  merchant_no VARCHAR(32) UNIQUE NOT NULL,
  contact_person VARCHAR(64) NOT NULL,
  contact_phone VARCHAR(16) NOT NULL,
  business_license VARCHAR(64) NOT NULL,
  status ENUM('active', 'inactive', 'pending') DEFAULT 'pending',
  qr_code VARCHAR(512),
  sub_mch_id VARCHAR(32),
  total_amount DECIMAL(15,2) DEFAULT 0.00,
  total_orders INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 立即添加的字段（最小必要）
```sql
-- 添加微信申请单号（生成二维码必需）
ALTER TABLE merchants ADD COLUMN applyment_id VARCHAR(64);

-- 添加可选的补充字段
ALTER TABLE merchants ADD COLUMN merchant_type VARCHAR(32) DEFAULT 'INDIVIDUAL';
ALTER TABLE merchants ADD COLUMN contact_email VARCHAR(128);
```

### 现有商户数据更新
基于MockWechatApiService中的5个真实商户，补充`applyment_id`：

```sql
-- 更新现有5个商户的申请单号
UPDATE merchants SET applyment_id = '2000002691156098' WHERE merchant_name = '仁寿县怀仁街道云锦汇会所（个体工商户）';
UPDATE merchants SET applyment_id = '2000002690858917' WHERE merchant_name = '仁寿县怀仁街道储府鱼庄店（个体工商户）';
UPDATE merchants SET applyment_id = '2000002690623402' WHERE merchant_name = '仁寿县怀仁街道颐善滋养园养生馆（个体工商户）';
UPDATE merchants SET applyment_id = '2000002690164951' WHERE merchant_name = '成都市中鑫博海国际酒业贸易有限公司';
UPDATE merchants SET applyment_id = '2000002689372247' WHERE merchant_name = '德阳市叁思科技有限公司';
```

---

## 🔧 商户模型优化（基于现有代码）

### 当前Merchant接口（保持）
```typescript
export interface Merchant {
  id: string
  merchantName: string
  merchantNo: string
  contactPerson: string
  contactPhone: string
  businessLicense: string
  status: 'active' | 'inactive' | 'pending'
  qrCode?: string // 收款二维码
  subMchId?: string // 微信支付特约商户号
  totalAmount: number // 总收款金额
  totalOrders: number // 总订单数
  createdAt: Date
  updatedAt: Date
}
```

### 添加的字段
```typescript
export interface EnhancedMerchant extends Merchant {
  applymentId?: string // 微信申请单号
  merchantType?: string // 商户类型
  contactEmail?: string // 联系邮箱
}
```

### 商户模型类新增方法
```typescript
// 在现有MerchantModel类中添加
export class MerchantModel {
  /**
   * 更新微信申请单号
   */
  static async updateApplymentId(merchantId: string, applymentId: string): Promise<boolean> {
    const connection = await getDBConnection()
    
    const [result] = await connection.execute<ResultSetHeader>(
      'UPDATE merchants SET applyment_id = ?, updated_at = NOW() WHERE id = ?',
      [applymentId, merchantId]
    )
    
    return result.affectedRows > 0
  }
  
  /**
   * 检查商户是否可以生成二维码
   */
  static async checkQRCodeEligibility(merchantId: string): Promise<{
    eligible: boolean;
    message: string;
  }> {
    const merchant = await this.findById(merchantId)
    
    if (!merchant) {
      return { eligible: false, message: '商户不存在' }
    }
    
    if (merchant.status !== 'active') {
      return { eligible: false, message: '商户状态不是active' }
    }
    
    if (!merchant.subMchId) {
      return { eligible: false, message: '缺少微信特约商户号' }
    }
    
    return { eligible: true, message: '可以生成二维码' }
  }
}
```

---

## 🚀 二维码生成功能（简化版）

### 基于现有代码的实现
```typescript
export class SimpleMerchantQRCodeService {
  /**
   * 为商户生成收款二维码（基础版）
   */
  async generateQRCode(merchantId: string): Promise<{
    success: boolean;
    qrCodeUrl?: string;
    message?: string;
  }> {
    try {
      // 1. 检查商户资格
      const eligibility = await MerchantModel.checkQRCodeEligibility(merchantId)
      if (!eligibility.eligible) {
        return { success: false, message: eligibility.message }
      }
      
      const merchant = await MerchantModel.findById(merchantId)
      
      // 2. 生成二维码内容（简化版）
      const qrContent = `weixin://wxpay/bizpayurl?pr=${merchant?.subMchId}_${Date.now()}`
      
      // 3. 使用qrcode库生成图片
      const qrCodeBuffer = await QRCode.toBuffer(qrContent)
      
      // 4. 保存到文件（或云存储）
      const fileName = `qrcode_${merchantId}_${Date.now()}.png`
      const qrCodeUrl = `/uploads/qrcodes/${fileName}`
      
      // 5. 更新商户二维码信息
      await MerchantModel.updateQRCode(merchantId, qrCodeUrl)
      
      return {
        success: true,
        qrCodeUrl,
        message: '二维码生成成功'
      }
      
    } catch (error: any) {
      return {
        success: false,
        message: `生成失败: ${error.message}`
      }
    }
  }
}
```

---

## 📱 管理后台功能增强

### 基于现有React代码的改进

#### 1. 商户列表页面增加功能
```typescript
// 在现有MerchantsPage组件中添加
const handleGenerateQRCode = async (merchantId: string) => {
  try {
    const result = await apiRequest(`/admin/merchants/${merchantId}/generate-qrcode`, {
      method: 'POST'
    })
    
    if (result.success) {
      message.success('二维码生成成功')
      loadMerchants() // 刷新列表
    } else {
      message.error(result.message)
    }
  } catch (error) {
    message.error('生成失败')
  }
}

// 在表格columns中添加操作列
{
  title: '操作',
  key: 'action',
  render: (_, record) => (
    <Space>
      <Button 
        type="primary" 
        size="small"
        disabled={!record.subMchId || record.status !== 'active'}
        onClick={() => handleGenerateQRCode(record.id)}
      >
        生成二维码
      </Button>
    </Space>
  )
}
```

#### 2. 新增商户编辑页面
```typescript
const EditMerchantPage = ({ merchantId }) => {
  const [form] = Form.useForm()
  const [loading, setLoading] = useState(false)
  
  const handleSubmit = async (values) => {
    setLoading(true)
    try {
      const result = await apiRequest(`/admin/merchants/${merchantId}`, {
        method: 'PUT',
        body: JSON.stringify(values)
      })
      
      if (result.success) {
        message.success('更新成功')
      }
    } catch (error) {
      message.error('更新失败')
    }
    setLoading(false)
  }
  
  return (
    <Form form={form} onFinish={handleSubmit}>
      <Form.Item name="merchantName" label="商户名称" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactPerson" label="联系人" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactPhone" label="联系电话" rules={[{ required: true }]}>
        <Input />
      </Form.Item>
      <Form.Item name="contactEmail" label="联系邮箱">
        <Input />
      </Form.Item>
      <Form.Item name="applymentId" label="微信申请单号">
        <Input />
      </Form.Item>
      <Form.Item name="subMchId" label="特约商户号">
        <Input />
      </Form.Item>
      <Button type="primary" htmlType="submit" loading={loading}>
        保存
      </Button>
    </Form>
  )
}
```

---

## 🔗 API接口设计（基于现有路由）

### 在现有路由基础上添加
```typescript
// 在 /api/v1/admin/merchants 路由中添加

// 生成二维码
router.post('/:merchantId/generate-qrcode', async (req, res) => {
  try {
    const { merchantId } = req.params
    const qrCodeService = new SimpleMerchantQRCodeService()
    const result = await qrCodeService.generateQRCode(merchantId)
    res.json(result)
  } catch (error) {
    res.status(500).json({ success: false, message: error.message })
  }
})

// 更新商户信息
router.put('/:merchantId', async (req, res) => {
  try {
    const { merchantId } = req.params
    const updateData = req.body
    
    // 验证字段
    const allowedFields = ['merchantName', 'contactPerson', 'contactPhone', 'contactEmail', 'applymentId', 'subMchId']
    const filteredData = Object.keys(updateData)
      .filter(key => allowedFields.includes(key))
      .reduce((obj, key) => ({ ...obj, [key]: updateData[key] }), {})
    
    const success = await MerchantModel.update(merchantId, filteredData)
    
    if (success) {
      res.json({ success: true, message: '更新成功' })
    } else {
      res.json({ success: false, message: '更新失败' })
    }
  } catch (error) {
    res.status(500).json({ success: false, message: error.message })
  }
})
```

---

## 📋 实施检查清单

### Phase 1: 立即执行（本周内）
- [ ] 执行数据库ALTER语句添加字段
- [ ] 更新5个商户的applyment_id
- [ ] 在MerchantModel中添加新方法
- [ ] 实现SimpleMerchantQRCodeService
- [ ] 在管理后台添加生成二维码按钮
- [ ] 测试二维码生成功能

### 验收标准
- [ ] 商户表新增3个字段
- [ ] 5个商户数据完整
- [ ] 有sub_mch_id的商户可以生成二维码
- [ ] 管理后台显示生成按钮且可用

### Phase 2: 后续优化（下周）
- [ ] 完善商户编辑功能
- [ ] 增加文件上传功能
- [ ] 优化二维码生成逻辑
- [ ] 添加操作日志

---

## ⚠️ 注意事项

1. **不破坏现有功能** - 所有修改都基于现有代码扩展
2. **数据安全** - 执行SQL前备份数据库
3. **渐进式改进** - 先实现基础功能，再优化
4. **保持简单** - 避免过度设计，专注快速上线

---

**文档状态**：与现有代码匹配  
**实施时间**：1周内完成  
**负责人**：开发团队