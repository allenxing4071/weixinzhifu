# 01-部署方案文档

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月
- **运维负责人**：[姓名]
- **技术负责人**：[姓名]
- **评审状态**：待评审

---

## 🎯 部署概述

本文档详细描述积分赠送小程序的完整部署方案，包括环境搭建、服务器配置、小程序发布、监控运维等全流程。

### 部署目标
1. **稳定可靠**：确保生产环境7×24小时稳定运行
2. **安全合规**：满足微信平台和支付安全要求
3. **高可用**：支持高并发访问和故障快速恢复
4. **可监控**：完整的监控告警和日志系统

---

## 🏗 整体架构部署图

### 生产环境架构
```
用户端小程序
     ↓
   CDN加速
     ↓
   负载均衡
     ↓
┌─────────────┬─────────────┬─────────────┐
│  应用服务器1  │  应用服务器2  │  应用服务器3  │
│   Node.js   │   Node.js   │   Node.js   │
└─────────────┴─────────────┴─────────────┘
     ↓               ↓               ↓
┌─────────────────────────────────────────┐
│             Redis 集群                   │
│        (缓存 + Session存储)              │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│          MySQL 主从集群                  │
│      主库(写) + 从库(读)                 │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│            监控告警系统                  │
│   Prometheus + Grafana + AlertManager   │
└─────────────────────────────────────────┘
```

---

## 🌐 环境配置规划

### 环境分层设计

#### 1. 开发环境 (DEV)
```yaml
环境用途: 开发调试
配置规格:
  应用服务器: 2核4G内存 × 1台
  数据库: MySQL 8.0 单实例
  缓存: Redis 6.0 单实例
域名配置: dev-api.example.com
数据特点: 测试数据，可随时重置
访问控制: 内网访问，IP白名单
```

#### 2. 测试环境 (TEST)
```yaml
环境用途: 功能测试、集成测试
配置规格:
  应用服务器: 4核8G内存 × 2台
  数据库: MySQL 8.0 主从配置
  缓存: Redis 6.0 哨兵模式
域名配置: test-api.example.com
数据特点: 模拟生产数据结构
访问控制: VPN访问，团队成员可访问
```

#### 3. 预生产环境 (STAGING)
```yaml
环境用途: 上线前最终验证
配置规格:
  应用服务器: 8核16G内存 × 2台
  数据库: MySQL 8.0 主从配置
  缓存: Redis 6.0 集群模式
域名配置: staging-api.example.com
数据特点: 脱敏的生产数据
访问控制: 严格访问控制，仅核心团队
```

#### 4. 生产环境 (PROD)
```yaml
环境用途: 正式服务用户
配置规格:
  应用服务器: 16核32G内存 × 3台
  数据库: MySQL 8.0 高可用集群
  缓存: Redis 6.0 集群 + 哨兵
域名配置: api.example.com
数据特点: 真实用户数据
访问控制: 最高级别安全防护
```

---

## 🔧 服务器配置详解

### 1. 应用服务器配置

#### 基础环境安装
```bash
# 1. 系统更新
sudo yum update -y

# 2. 安装Node.js 18.x LTS
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 3. 安装PM2进程管理器
sudo npm install -g pm2

# 4. 安装Nginx
sudo yum install -y nginx

# 5. 安装常用工具
sudo yum install -y git vim wget curl htop
```

#### 应用部署配置
```javascript
// ecosystem.config.js - PM2配置文件
module.exports = {
  apps: [
    {
      name: 'points-app',
      script: 'dist/app.js',
      instances: 'max', // 启动CPU核心数个实例
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      env_production: {
        NODE_ENV: 'production',
        PORT: 3000,
        DB_HOST: 'mysql-cluster.internal',
        REDIS_HOST: 'redis-cluster.internal'
      },
      log_date_format: 'YYYY-MM-DD HH:mm Z',
      error_file: '/var/log/points-app/error.log',
      out_file: '/var/log/points-app/out.log',
      log_file: '/var/log/points-app/combined.log',
      time: true,
      max_memory_restart: '1G',
      watch: false,
      ignore_watch: ['node_modules', 'logs'],
      restart_delay: 4000
    }
  ]
}
```

#### Nginx反向代理配置
```nginx
# /etc/nginx/conf.d/points-app.conf
upstream points_backend {
    server 127.0.0.1:3000 weight=3;
    server 127.0.0.1:3001 weight=2;
    server 127.0.0.1:3002 weight=1;
    keepalive 32;
}

server {
    listen 80;
    server_name api.example.com;
    
    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/api.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/api.example.com.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头配置
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 日志配置
    access_log /var/log/nginx/points-app-access.log;
    error_log /var/log/nginx/points-app-error.log;
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API代理
    location /api/ {
        proxy_pass http://points_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 30;
        proxy_send_timeout 30;
        proxy_read_timeout 30;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 2. 数据库配置

#### MySQL主从复制配置
```ini
# 主库配置 /etc/my.cnf
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1

# 性能优化
innodb_buffer_pool_size = 16G
innodb_log_file_size = 1G
innodb_log_buffer_size = 256M
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1

# 连接配置
max_connections = 1000
max_connect_errors = 10000
wait_timeout = 28800
interactive_timeout = 28800

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

```ini
# 从库配置 /etc/my.cnf
[mysqld]
server-id = 2
log-bin = mysql-bin
binlog-format = ROW
relay-log = relay-bin
read_only = 1
super_read_only = 1

# 其他配置与主库相同...
```

#### 数据库初始化脚本
```sql
-- 创建应用数据库
CREATE DATABASE points_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用用户
CREATE USER 'points_app'@'%' IDENTIFIED BY 'StrongPassword123!';
GRANT SELECT, INSERT, UPDATE, DELETE ON points_app.* TO 'points_app'@'%';
FLUSH PRIVILEGES;

-- 创建只读用户（用于从库）
CREATE USER 'points_readonly'@'%' IDENTIFIED BY 'ReadOnlyPassword123!';
GRANT SELECT ON points_app.* TO 'points_readonly'@'%';
FLUSH PRIVILEGES;
```

### 3. Redis配置

#### Redis集群配置
```conf
# redis.conf
port 6379
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip 10.0.1.100
cluster-announce-port 6379
cluster-announce-bus-port 16379

# 内存配置
maxmemory 8gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes

# 安全配置
requirepass RedisPassword123!
masterauth RedisPassword123!

# 日志配置
logfile /var/log/redis/redis.log
loglevel notice
```

---

## 📱 小程序发布流程

### 1. 微信公众平台配置

#### 基础信息配置
```yaml
小程序基本信息:
  名称: "XX积分助手"
  AppID: "wx1234567890abcdef"
  类目: "工具-效率"
  简介: "为商户和用户提供便捷的积分奖励服务"

开发设置:
  服务器域名:
    request合法域名: "https://api.example.com"
    socket合法域名: "wss://api.example.com"
    uploadFile合法域名: "https://upload.example.com"
    downloadFile合法域名: "https://download.example.com"
  
  业务域名:
    - "https://www.example.com"
    - "https://help.example.com"
```

#### 微信支付配置
```yaml
支付配置:
  商户号: "1234567890"
  API密钥: "32位随机字符串"
  证书配置:
    - apiclient_cert.pem
    - apiclient_key.pem
    - WXCertUtil.crt
  
  回调地址:
    支付回调: "https://api.example.com/api/payment/callback"
    退款回调: "https://api.example.com/api/refund/callback"
```

### 2. 小程序代码发布

#### 发布前检查清单
```markdown
代码质量检查:
- [ ] 所有功能模块单元测试通过
- [ ] 代码覆盖率 ≥ 80%
- [ ] ESLint代码规范检查通过
- [ ] 代码包大小 ≤ 2MB

功能完整性检查:
- [ ] 用户注册登录功能正常
- [ ] 扫码支付流程完整
- [ ] 积分发放准确无误
- [ ] 积分查询功能正常
- [ ] 商户管理功能完整

合规性检查:
- [ ] 用户协议和隐私政策完整
- [ ] 客服联系方式有效
- [ ] 所有接口使用HTTPS
- [ ] 敏感数据已加密
- [ ] 审核材料准备完整
```

#### 发布操作流程
```bash
# 1. 生产环境构建
npm run build:prod

# 2. 代码包大小检查
du -sh dist/
# 确保 < 2MB

# 3. 开发者工具上传
# 在微信开发者工具中:
# - 点击"上传"按钮
# - 填写版本号和备注
# - 确认上传

# 4. 微信公众平台提交审核
# 登录 https://mp.weixin.qq.com
# - 进入"版本管理"
# - 选择上传的版本
# - 填写功能描述
# - 提交审核

# 5. 审核通过后发布
# - 审核通过通知
# - 点击"发布"按钮
# - 小程序正式上线
```

---

## 🚀 自动化部署方案

### 1. CI/CD流水线设计

#### Jenkins流水线配置
```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18.17.0'
        APP_NAME = 'points-app'
        DEPLOY_ENV = 'production'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git submodule update --init --recursive'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'nvm use ${NODE_VERSION}'
                sh 'npm ci --production=false'
            }
        }
        
        stage('Code Quality') {
            parallel {
                stage('Lint') {
                    steps {
                        sh 'npm run lint'
                    }
                }
                stage('Test') {
                    steps {
                        sh 'npm run test:coverage'
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'coverage',
                            reportFiles: 'index.html',
                            reportName: 'Coverage Report'
                        ])
                    }
                }
                stage('Security Scan') {
                    steps {
                        sh 'npm audit --audit-level moderate'
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm run build:${DEPLOY_ENV}'
                archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                sh './scripts/deploy-staging.sh'
            }
        }
        
        stage('Integration Tests') {
            when {
                branch 'develop'
            }
            steps {
                sh 'npm run test:integration'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'master'
            }
            steps {
                script {
                    def userInput = input(
                        id: 'DeployToProd',
                        message: 'Deploy to Production?',
                        parameters: [
                            choice(
                                choices: ['Deploy', 'Abort'],
                                description: 'Choose action',
                                name: 'action'
                            )
                        ]
                    )
                    if (userInput == 'Deploy') {
                        sh './scripts/deploy-production.sh'
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                branch 'master'
            }
            steps {
                sh 'npm run test:smoke'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            dingtalk(
                robot: 'deployment-robot',
                type: 'MARKDOWN',
                title: '部署成功',
                text: "### 🎉 ${APP_NAME} 部署成功\n- 分支: ${env.BRANCH_NAME}\n- 构建: ${env.BUILD_NUMBER}\n- 时间: ${new Date()}"
            )
        }
        failure {
            dingtalk(
                robot: 'deployment-robot',
                type: 'MARKDOWN',
                title: '部署失败',
                text: "### ❌ ${APP_NAME} 部署失败\n- 分支: ${env.BRANCH_NAME}\n- 构建: ${env.BUILD_NUMBER}\n- 时间: ${new Date()}"
            )
        }
    }
}
```

### 2. 部署脚本

#### 生产环境部署脚本
```bash
#!/bin/bash
# deploy-production.sh

set -e

APP_NAME="points-app"
DEPLOY_DIR="/opt/${APP_NAME}"
BACKUP_DIR="/opt/backups/${APP_NAME}"
BUILD_DIR="./dist"

echo "🚀 开始部署到生产环境..."

# 1. 创建备份
echo "📦 创建当前版本备份..."
sudo mkdir -p ${BACKUP_DIR}
sudo tar -czf ${BACKUP_DIR}/backup-$(date +%Y%m%d_%H%M%S).tar.gz -C ${DEPLOY_DIR} .

# 2. 停止应用
echo "🛑 停止应用服务..."
sudo pm2 stop ${APP_NAME} || true

# 3. 部署新版本
echo "📂 部署新版本..."
sudo rm -rf ${DEPLOY_DIR}/old
sudo mv ${DEPLOY_DIR} ${DEPLOY_DIR}_old || true
sudo mkdir -p ${DEPLOY_DIR}
sudo cp -r ${BUILD_DIR}/* ${DEPLOY_DIR}/
sudo cp package.json ${DEPLOY_DIR}/
sudo cp ecosystem.config.js ${DEPLOY_DIR}/

# 4. 安装依赖
echo "📥 安装生产依赖..."
cd ${DEPLOY_DIR}
sudo npm ci --production

# 5. 启动应用
echo "🚀 启动应用服务..."
sudo pm2 start ecosystem.config.js --env production

# 6. 健康检查
echo "🏥 健康检查..."
sleep 10
for i in {1..30}; do
    if curl -f http://localhost:3000/health; then
        echo "✅ 应用启动成功"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "❌ 应用启动失败，开始回滚..."
        sudo pm2 stop ${APP_NAME}
        sudo rm -rf ${DEPLOY_DIR}
        sudo mv ${DEPLOY_DIR}_old ${DEPLOY_DIR}
        sudo pm2 start ecosystem.config.js --env production
        exit 1
    fi
    sleep 2
done

# 7. 清理旧版本
echo "🧹 清理旧版本..."
sudo rm -rf ${DEPLOY_DIR}_old

echo "✅ 部署完成！"
```

---

## 📊 监控运维配置

### 1. Prometheus监控配置

#### 应用指标采集
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

scrape_configs:
  # 应用服务监控
  - job_name: 'points-app'
    static_configs:
      - targets: ['10.0.1.10:3000', '10.0.1.11:3000', '10.0.1.12:3000']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  # 数据库监控
  - job_name: 'mysql'
    static_configs:
      - targets: ['10.0.2.10:9104']
    
  # Redis监控
  - job_name: 'redis'
    static_configs:
      - targets: ['10.0.3.10:9121']
    
  # 服务器监控
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['10.0.1.10:9100', '10.0.1.11:9100', '10.0.1.12:9100']

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']
```

#### 告警规则配置
```yaml
# rules/app-alerts.yml
groups:
  - name: points-app-alerts
    rules:
      # 应用服务告警
      - alert: AppDown
        expr: up{job="points-app"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "应用服务下线"
          description: "应用服务 {{ $labels.instance }} 已下线超过1分钟"
      
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "错误率过高"
          description: "应用错误率超过10%，当前值: {{ $value }}"
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "响应时间过长"
          description: "95%请求响应时间超过1秒，当前值: {{ $value }}s"
      
      # 数据库告警
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL数据库下线"
          description: "MySQL数据库 {{ $labels.instance }} 连接失败"
      
      - alert: MySQLSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL慢查询过多"
          description: "慢查询频率: {{ $value }}/秒"
      
      # Redis告警
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis缓存下线"
          description: "Redis实例 {{ $labels.instance }} 连接失败"
      
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis内存使用率过高"
          description: "内存使用率: {{ $value | humanizePercentage }}"
```

### 2. Grafana仪表板

#### 应用监控仪表板
```json
{
  "dashboard": {
    "title": "积分小程序监控仪表板",
    "panels": [
      {
        "title": "QPS (每秒请求数)",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[1m]))",
            "legendFormat": "总QPS"
          }
        ]
      },
      {
        "title": "响应时间分布",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "错误率",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "错误率"
          }
        ]
      },
      {
        "title": "支付成功率",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(payment_success_total[5m]) / rate(payment_total[5m])",
            "legendFormat": "支付成功率"
          }
        ]
      },
      {
        "title": "积分发放成功率",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(points_award_success_total[5m]) / rate(points_award_total[5m])",
            "legendFormat": "积分发放成功率"
          }
        ]
      }
    ]
  }
}
```

---

## 🔒 安全配置

### 1. SSL/TLS配置

#### 证书获取和配置
```bash
# 使用Let's Encrypt免费证书
sudo yum install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d api.example.com

# 自动续期配置
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 2. 防火墙配置
```bash
# 配置iptables规则
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT    # SSH
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # HTTP
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # HTTPS
sudo iptables -A INPUT -p tcp --dport 3000 -j DROP    # 阻止直接访问应用端口
sudo iptables -A INPUT -j DROP                        # 默认拒绝

# 保存规则
sudo service iptables save
```

### 3. 日志审计配置
```bash
# 配置rsyslog集中日志
echo "*.* @@log-server.internal:514" | sudo tee -a /etc/rsyslog.conf

# 配置日志轮转
cat > /etc/logrotate.d/points-app << EOF
/var/log/points-app/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 points-app points-app
    postrotate
        sudo pm2 reloadLogs
    endscript
}
EOF
```

---

## 📋 部署检查清单

### 上线前检查项
```markdown
基础环境检查:
- [ ] 服务器硬件配置符合要求
- [ ] 操作系统版本和补丁最新
- [ ] 网络连通性测试通过
- [ ] 域名解析配置正确
- [ ] SSL证书有效且正确配置

应用部署检查:
- [ ] 应用代码版本正确
- [ ] 配置文件环境变量正确
- [ ] 数据库连接正常
- [ ] Redis缓存连接正常
- [ ] 微信支付配置正确

功能验证检查:
- [ ] 健康检查接口正常
- [ ] 用户注册登录功能正常
- [ ] 支付流程完整可用
- [ ] 积分发放准确无误
- [ ] 监控告警系统正常

安全配置检查:
- [ ] 防火墙规则配置正确
- [ ] SSL/TLS配置安全
- [ ] 敏感信息加密存储
- [ ] 访问权限控制正确
- [ ] 日志审计配置完整

性能优化检查:
- [ ] 应用启动时间 < 30秒
- [ ] 接口响应时间 < 200ms
- [ ] 数据库查询优化
- [ ] 缓存命中率 > 90%
- [ ] CDN配置生效
```

---

## 🚨 应急预案

### 1. 故障分级
```yaml
P0故障 (Critical):
  定义: 核心功能完全不可用
  响应时间: 15分钟内
  处理时间: 1小时内恢复
  例子: 支付功能完全中断

P1故障 (High):
  定义: 重要功能部分不可用
  响应时间: 30分钟内
  处理时间: 4小时内恢复
  例子: 积分发放延迟

P2故障 (Medium):
  定义: 非核心功能异常
  响应时间: 2小时内
  处理时间: 24小时内恢复
  例子: 统计数据显示异常

P3故障 (Low):
  定义: 轻微问题不影响使用
  响应时间: 1工作日内
  处理时间: 1周内修复
  例子: 页面样式问题
```

### 2. 快速回滚方案
```bash
#!/bin/bash
# rollback.sh - 快速回滚脚本

BACKUP_DIR="/opt/backups/points-app"
DEPLOY_DIR="/opt/points-app"

echo "🔄 开始执行回滚..."

# 1. 获取最近的备份
LATEST_BACKUP=$(ls -t ${BACKUP_DIR}/backup-*.tar.gz | head -1)

if [ -z "$LATEST_BACKUP" ]; then
    echo "❌ 未找到可用备份文件"
    exit 1
fi

echo "📦 使用备份文件: $LATEST_BACKUP"

# 2. 停止当前服务
sudo pm2 stop points-app

# 3. 恢复备份
sudo rm -rf ${DEPLOY_DIR}_current
sudo mv ${DEPLOY_DIR} ${DEPLOY_DIR}_current
sudo mkdir -p ${DEPLOY_DIR}
sudo tar -xzf ${LATEST_BACKUP} -C ${DEPLOY_DIR}

# 4. 启动服务
sudo pm2 start ecosystem.config.js --env production

# 5. 健康检查
sleep 10
if curl -f http://localhost:3000/health; then
    echo "✅ 回滚成功"
    sudo rm -rf ${DEPLOY_DIR}_current
else
    echo "❌ 回滚失败，尝试恢复当前版本"
    sudo pm2 stop points-app
    sudo rm -rf ${DEPLOY_DIR}
    sudo mv ${DEPLOY_DIR}_current ${DEPLOY_DIR}
    sudo pm2 start ecosystem.config.js --env production
    exit 1
fi
```

---

## 📈 性能优化配置

### 1. 应用性能优化
```javascript
// 应用性能配置
const express = require('express')
const compression = require('compression')
const helmet = require('helmet')

const app = express()

// 启用gzip压缩
app.use(compression())

// 安全头配置
app.use(helmet({
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}))

// 静态资源缓存
app.use(express.static('public', {
  maxAge: '1y',
  etag: true,
  lastModified: true
}))

// 请求限流
const rateLimit = require('express-rate-limit')
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 1000, // 限制每个IP 1000次请求
  message: '请求过于频繁，请稍后再试'
})
app.use('/api/', limiter)
```

### 2. 数据库性能优化
```sql
-- 创建必要索引
CREATE INDEX idx_payment_orders_user_id ON payment_orders(user_id);
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
CREATE INDEX idx_payment_orders_created_at ON payment_orders(created_at);
CREATE INDEX idx_points_records_user_id ON points_records(user_id);
CREATE INDEX idx_points_records_created_at ON points_records(created_at);

-- 分区表配置（按月分区）
ALTER TABLE points_records PARTITION BY RANGE (YEAR(created_at)*100 + MONTH(created_at))
(
    PARTITION p202412 VALUES LESS THAN (202501),
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503)
);
```

---

**文档状态**：待运维评审  
**下一步行动**：环境搭建和部署测试  
**责任人**：运维负责人  
**评审时间**：待定
