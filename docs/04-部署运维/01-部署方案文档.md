# 01-éƒ¨ç½²æ–¹æ¡ˆæ–‡æ¡£

## ğŸ“– æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ
- **è¿ç»´è´Ÿè´£äºº**ï¼š[å§“å]
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼š[å§“å]
- **è¯„å®¡çŠ¶æ€**ï¼šå¾…è¯„å®¡

---

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°ç§¯åˆ†èµ é€å°ç¨‹åºçš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ç¯å¢ƒæ­å»ºã€æœåŠ¡å™¨é…ç½®ã€å°ç¨‹åºå‘å¸ƒã€ç›‘æ§è¿ç»´ç­‰å…¨æµç¨‹ã€‚

### éƒ¨ç½²ç›®æ ‡
1. **ç¨³å®šå¯é **ï¼šç¡®ä¿ç”Ÿäº§ç¯å¢ƒ7Ã—24å°æ—¶ç¨³å®šè¿è¡Œ
2. **å®‰å…¨åˆè§„**ï¼šæ»¡è¶³å¾®ä¿¡å¹³å°å’Œæ”¯ä»˜å®‰å…¨è¦æ±‚
3. **é«˜å¯ç”¨**ï¼šæ”¯æŒé«˜å¹¶å‘è®¿é—®å’Œæ•…éšœå¿«é€Ÿæ¢å¤
4. **å¯ç›‘æ§**ï¼šå®Œæ•´çš„ç›‘æ§å‘Šè­¦å’Œæ—¥å¿—ç³»ç»Ÿ

---

## ğŸ— æ•´ä½“æ¶æ„éƒ¨ç½²å›¾

### ç”Ÿäº§ç¯å¢ƒæ¶æ„
```
ç”¨æˆ·ç«¯å°ç¨‹åº
     â†“
   CDNåŠ é€Ÿ
     â†“
   è´Ÿè½½å‡è¡¡
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡å™¨1  â”‚  åº”ç”¨æœåŠ¡å™¨2  â”‚  åº”ç”¨æœåŠ¡å™¨3  â”‚
â”‚   Node.js   â”‚   Node.js   â”‚   Node.js   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Redis é›†ç¾¤                   â”‚
â”‚        (ç¼“å­˜ + Sessionå­˜å‚¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQL ä¸»ä»é›†ç¾¤                  â”‚
â”‚      ä¸»åº“(å†™) + ä»åº“(è¯»)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç›‘æ§å‘Šè­¦ç³»ç»Ÿ                  â”‚
â”‚   Prometheus + Grafana + AlertManager   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ ç¯å¢ƒé…ç½®è§„åˆ’

### ç¯å¢ƒåˆ†å±‚è®¾è®¡

#### 1. å¼€å‘ç¯å¢ƒ (DEV)
```yaml
ç¯å¢ƒç”¨é€”: å¼€å‘è°ƒè¯•
é…ç½®è§„æ ¼:
  åº”ç”¨æœåŠ¡å™¨: 2æ ¸4Gå†…å­˜ Ã— 1å°
  æ•°æ®åº“: MySQL 8.0 å•å®ä¾‹
  ç¼“å­˜: Redis 6.0 å•å®ä¾‹
åŸŸåé…ç½®: dev-api.example.com
æ•°æ®ç‰¹ç‚¹: æµ‹è¯•æ•°æ®ï¼Œå¯éšæ—¶é‡ç½®
è®¿é—®æ§åˆ¶: å†…ç½‘è®¿é—®ï¼ŒIPç™½åå•
```

#### 2. æµ‹è¯•ç¯å¢ƒ (TEST)
```yaml
ç¯å¢ƒç”¨é€”: åŠŸèƒ½æµ‹è¯•ã€é›†æˆæµ‹è¯•
é…ç½®è§„æ ¼:
  åº”ç”¨æœåŠ¡å™¨: 4æ ¸8Gå†…å­˜ Ã— 2å°
  æ•°æ®åº“: MySQL 8.0 ä¸»ä»é…ç½®
  ç¼“å­˜: Redis 6.0 å“¨å…µæ¨¡å¼
åŸŸåé…ç½®: test-api.example.com
æ•°æ®ç‰¹ç‚¹: æ¨¡æ‹Ÿç”Ÿäº§æ•°æ®ç»“æ„
è®¿é—®æ§åˆ¶: VPNè®¿é—®ï¼Œå›¢é˜Ÿæˆå‘˜å¯è®¿é—®
```

#### 3. é¢„ç”Ÿäº§ç¯å¢ƒ (STAGING)
```yaml
ç¯å¢ƒç”¨é€”: ä¸Šçº¿å‰æœ€ç»ˆéªŒè¯
é…ç½®è§„æ ¼:
  åº”ç”¨æœåŠ¡å™¨: 8æ ¸16Gå†…å­˜ Ã— 2å°
  æ•°æ®åº“: MySQL 8.0 ä¸»ä»é…ç½®
  ç¼“å­˜: Redis 6.0 é›†ç¾¤æ¨¡å¼
åŸŸåé…ç½®: staging-api.example.com
æ•°æ®ç‰¹ç‚¹: è„±æ•çš„ç”Ÿäº§æ•°æ®
è®¿é—®æ§åˆ¶: ä¸¥æ ¼è®¿é—®æ§åˆ¶ï¼Œä»…æ ¸å¿ƒå›¢é˜Ÿ
```

#### 4. ç”Ÿäº§ç¯å¢ƒ (PROD)
```yaml
ç¯å¢ƒç”¨é€”: æ­£å¼æœåŠ¡ç”¨æˆ·
é…ç½®è§„æ ¼:
  åº”ç”¨æœåŠ¡å™¨: 16æ ¸32Gå†…å­˜ Ã— 3å°
  æ•°æ®åº“: MySQL 8.0 é«˜å¯ç”¨é›†ç¾¤
  ç¼“å­˜: Redis 6.0 é›†ç¾¤ + å“¨å…µ
åŸŸåé…ç½®: api.example.com
æ•°æ®ç‰¹ç‚¹: çœŸå®ç”¨æˆ·æ•°æ®
è®¿é—®æ§åˆ¶: æœ€é«˜çº§åˆ«å®‰å…¨é˜²æŠ¤
```

---

## ğŸ”§ æœåŠ¡å™¨é…ç½®è¯¦è§£

### 1. åº”ç”¨æœåŠ¡å™¨é…ç½®

#### åŸºç¡€ç¯å¢ƒå®‰è£…
```bash
# 1. ç³»ç»Ÿæ›´æ–°
sudo yum update -y

# 2. å®‰è£…Node.js 18.x LTS
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 3. å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
sudo npm install -g pm2

# 4. å®‰è£…Nginx
sudo yum install -y nginx

# 5. å®‰è£…å¸¸ç”¨å·¥å…·
sudo yum install -y git vim wget curl htop
```

#### åº”ç”¨éƒ¨ç½²é…ç½®
```javascript
// ecosystem.config.js - PM2é…ç½®æ–‡ä»¶
module.exports = {
  apps: [
    {
      name: 'points-app',
      script: 'dist/app.js',
      instances: 'max', // å¯åŠ¨CPUæ ¸å¿ƒæ•°ä¸ªå®ä¾‹
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      env_production: {
        NODE_ENV: 'production',
        PORT: 3000,
        DB_HOST: 'mysql-cluster.internal',
        REDIS_HOST: 'redis-cluster.internal'
      },
      log_date_format: 'YYYY-MM-DD HH:mm Z',
      error_file: '/var/log/points-app/error.log',
      out_file: '/var/log/points-app/out.log',
      log_file: '/var/log/points-app/combined.log',
      time: true,
      max_memory_restart: '1G',
      watch: false,
      ignore_watch: ['node_modules', 'logs'],
      restart_delay: 4000
    }
  ]
}
```

#### Nginxåå‘ä»£ç†é…ç½®
```nginx
# /etc/nginx/conf.d/points-app.conf
upstream points_backend {
    server 127.0.0.1:3000 weight=3;
    server 127.0.0.1:3001 weight=2;
    server 127.0.0.1:3002 weight=1;
    keepalive 32;
}

server {
    listen 80;
    server_name api.example.com;
    
    # å¼ºåˆ¶HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/api.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/api.example.com.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # å®‰å…¨å¤´é…ç½®
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/points-app-access.log;
    error_log /var/log/nginx/points-app-error.log;
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://points_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 30;
        proxy_send_timeout 30;
        proxy_read_timeout 30;
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 2. æ•°æ®åº“é…ç½®

#### MySQLä¸»ä»å¤åˆ¶é…ç½®
```ini
# ä¸»åº“é…ç½® /etc/my.cnf
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1

# æ€§èƒ½ä¼˜åŒ–
innodb_buffer_pool_size = 16G
innodb_log_file_size = 1G
innodb_log_buffer_size = 256M
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1

# è¿æ¥é…ç½®
max_connections = 1000
max_connect_errors = 10000
wait_timeout = 28800
interactive_timeout = 28800

# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

```ini
# ä»åº“é…ç½® /etc/my.cnf
[mysqld]
server-id = 2
log-bin = mysql-bin
binlog-format = ROW
relay-log = relay-bin
read_only = 1
super_read_only = 1

# å…¶ä»–é…ç½®ä¸ä¸»åº“ç›¸åŒ...
```

#### æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
```sql
-- åˆ›å»ºåº”ç”¨æ•°æ®åº“
CREATE DATABASE points_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER 'points_app'@'%' IDENTIFIED BY 'StrongPassword123!';
GRANT SELECT, INSERT, UPDATE, DELETE ON points_app.* TO 'points_app'@'%';
FLUSH PRIVILEGES;

-- åˆ›å»ºåªè¯»ç”¨æˆ·ï¼ˆç”¨äºä»åº“ï¼‰
CREATE USER 'points_readonly'@'%' IDENTIFIED BY 'ReadOnlyPassword123!';
GRANT SELECT ON points_app.* TO 'points_readonly'@'%';
FLUSH PRIVILEGES;
```

### 3. Redisé…ç½®

#### Redisé›†ç¾¤é…ç½®
```conf
# redis.conf
port 6379
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip 10.0.1.100
cluster-announce-port 6379
cluster-announce-bus-port 16379

# å†…å­˜é…ç½®
maxmemory 8gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes

# å®‰å…¨é…ç½®
requirepass RedisPassword123!
masterauth RedisPassword123!

# æ—¥å¿—é…ç½®
logfile /var/log/redis/redis.log
loglevel notice
```

---

## ğŸ“± å°ç¨‹åºå‘å¸ƒæµç¨‹

### 1. å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®

#### åŸºç¡€ä¿¡æ¯é…ç½®
```yaml
å°ç¨‹åºåŸºæœ¬ä¿¡æ¯:
  åç§°: "XXç§¯åˆ†åŠ©æ‰‹"
  AppID: "wx1234567890abcdef"
  ç±»ç›®: "å·¥å…·-æ•ˆç‡"
  ç®€ä»‹: "ä¸ºå•†æˆ·å’Œç”¨æˆ·æä¾›ä¾¿æ·çš„ç§¯åˆ†å¥–åŠ±æœåŠ¡"

å¼€å‘è®¾ç½®:
  æœåŠ¡å™¨åŸŸå:
    requeståˆæ³•åŸŸå: "https://api.example.com"
    socketåˆæ³•åŸŸå: "wss://api.example.com"
    uploadFileåˆæ³•åŸŸå: "https://upload.example.com"
    downloadFileåˆæ³•åŸŸå: "https://download.example.com"
  
  ä¸šåŠ¡åŸŸå:
    - "https://www.example.com"
    - "https://help.example.com"
```

#### å¾®ä¿¡æ”¯ä»˜é…ç½®
```yaml
æ”¯ä»˜é…ç½®:
  å•†æˆ·å·: "1234567890"
  APIå¯†é’¥: "32ä½éšæœºå­—ç¬¦ä¸²"
  è¯ä¹¦é…ç½®:
    - apiclient_cert.pem
    - apiclient_key.pem
    - WXCertUtil.crt
  
  å›è°ƒåœ°å€:
    æ”¯ä»˜å›è°ƒ: "https://api.example.com/api/payment/callback"
    é€€æ¬¾å›è°ƒ: "https://api.example.com/api/refund/callback"
```

### 2. å°ç¨‹åºä»£ç å‘å¸ƒ

#### å‘å¸ƒå‰æ£€æŸ¥æ¸…å•
```markdown
ä»£ç è´¨é‡æ£€æŸ¥:
- [ ] æ‰€æœ‰åŠŸèƒ½æ¨¡å—å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡ â‰¥ 80%
- [ ] ESLintä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡
- [ ] ä»£ç åŒ…å¤§å° â‰¤ 2MB

åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥:
- [ ] ç”¨æˆ·æ³¨å†Œç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æ‰«ç æ”¯ä»˜æµç¨‹å®Œæ•´
- [ ] ç§¯åˆ†å‘æ”¾å‡†ç¡®æ— è¯¯
- [ ] ç§¯åˆ†æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸
- [ ] å•†æˆ·ç®¡ç†åŠŸèƒ½å®Œæ•´

åˆè§„æ€§æ£€æŸ¥:
- [ ] ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–å®Œæ•´
- [ ] å®¢æœè”ç³»æ–¹å¼æœ‰æ•ˆ
- [ ] æ‰€æœ‰æ¥å£ä½¿ç”¨HTTPS
- [ ] æ•æ„Ÿæ•°æ®å·²åŠ å¯†
- [ ] å®¡æ ¸ææ–™å‡†å¤‡å®Œæ•´
```

#### å‘å¸ƒæ“ä½œæµç¨‹
```bash
# 1. ç”Ÿäº§ç¯å¢ƒæ„å»º
npm run build:prod

# 2. ä»£ç åŒ…å¤§å°æ£€æŸ¥
du -sh dist/
# ç¡®ä¿ < 2MB

# 3. å¼€å‘è€…å·¥å…·ä¸Šä¼ 
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­:
# - ç‚¹å‡»"ä¸Šä¼ "æŒ‰é’®
# - å¡«å†™ç‰ˆæœ¬å·å’Œå¤‡æ³¨
# - ç¡®è®¤ä¸Šä¼ 

# 4. å¾®ä¿¡å…¬ä¼—å¹³å°æäº¤å®¡æ ¸
# ç™»å½• https://mp.weixin.qq.com
# - è¿›å…¥"ç‰ˆæœ¬ç®¡ç†"
# - é€‰æ‹©ä¸Šä¼ çš„ç‰ˆæœ¬
# - å¡«å†™åŠŸèƒ½æè¿°
# - æäº¤å®¡æ ¸

# 5. å®¡æ ¸é€šè¿‡åå‘å¸ƒ
# - å®¡æ ¸é€šè¿‡é€šçŸ¥
# - ç‚¹å‡»"å‘å¸ƒ"æŒ‰é’®
# - å°ç¨‹åºæ­£å¼ä¸Šçº¿
```

---

## ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²æ–¹æ¡ˆ

### 1. CI/CDæµæ°´çº¿è®¾è®¡

#### Jenkinsæµæ°´çº¿é…ç½®
```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18.17.0'
        APP_NAME = 'points-app'
        DEPLOY_ENV = 'production'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git submodule update --init --recursive'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'nvm use ${NODE_VERSION}'
                sh 'npm ci --production=false'
            }
        }
        
        stage('Code Quality') {
            parallel {
                stage('Lint') {
                    steps {
                        sh 'npm run lint'
                    }
                }
                stage('Test') {
                    steps {
                        sh 'npm run test:coverage'
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'coverage',
                            reportFiles: 'index.html',
                            reportName: 'Coverage Report'
                        ])
                    }
                }
                stage('Security Scan') {
                    steps {
                        sh 'npm audit --audit-level moderate'
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm run build:${DEPLOY_ENV}'
                archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                sh './scripts/deploy-staging.sh'
            }
        }
        
        stage('Integration Tests') {
            when {
                branch 'develop'
            }
            steps {
                sh 'npm run test:integration'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'master'
            }
            steps {
                script {
                    def userInput = input(
                        id: 'DeployToProd',
                        message: 'Deploy to Production?',
                        parameters: [
                            choice(
                                choices: ['Deploy', 'Abort'],
                                description: 'Choose action',
                                name: 'action'
                            )
                        ]
                    )
                    if (userInput == 'Deploy') {
                        sh './scripts/deploy-production.sh'
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                branch 'master'
            }
            steps {
                sh 'npm run test:smoke'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            dingtalk(
                robot: 'deployment-robot',
                type: 'MARKDOWN',
                title: 'éƒ¨ç½²æˆåŠŸ',
                text: "### ğŸ‰ ${APP_NAME} éƒ¨ç½²æˆåŠŸ\n- åˆ†æ”¯: ${env.BRANCH_NAME}\n- æ„å»º: ${env.BUILD_NUMBER}\n- æ—¶é—´: ${new Date()}"
            )
        }
        failure {
            dingtalk(
                robot: 'deployment-robot',
                type: 'MARKDOWN',
                title: 'éƒ¨ç½²å¤±è´¥',
                text: "### âŒ ${APP_NAME} éƒ¨ç½²å¤±è´¥\n- åˆ†æ”¯: ${env.BRANCH_NAME}\n- æ„å»º: ${env.BUILD_NUMBER}\n- æ—¶é—´: ${new Date()}"
            )
        }
    }
}
```

### 2. éƒ¨ç½²è„šæœ¬

#### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy-production.sh

set -e

APP_NAME="points-app"
DEPLOY_DIR="/opt/${APP_NAME}"
BACKUP_DIR="/opt/backups/${APP_NAME}"
BUILD_DIR="./dist"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."

# 1. åˆ›å»ºå¤‡ä»½
echo "ğŸ“¦ åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½..."
sudo mkdir -p ${BACKUP_DIR}
sudo tar -czf ${BACKUP_DIR}/backup-$(date +%Y%m%d_%H%M%S).tar.gz -C ${DEPLOY_DIR} .

# 2. åœæ­¢åº”ç”¨
echo "ğŸ›‘ åœæ­¢åº”ç”¨æœåŠ¡..."
sudo pm2 stop ${APP_NAME} || true

# 3. éƒ¨ç½²æ–°ç‰ˆæœ¬
echo "ğŸ“‚ éƒ¨ç½²æ–°ç‰ˆæœ¬..."
sudo rm -rf ${DEPLOY_DIR}/old
sudo mv ${DEPLOY_DIR} ${DEPLOY_DIR}_old || true
sudo mkdir -p ${DEPLOY_DIR}
sudo cp -r ${BUILD_DIR}/* ${DEPLOY_DIR}/
sudo cp package.json ${DEPLOY_DIR}/
sudo cp ecosystem.config.js ${DEPLOY_DIR}/

# 4. å®‰è£…ä¾èµ–
echo "ğŸ“¥ å®‰è£…ç”Ÿäº§ä¾èµ–..."
cd ${DEPLOY_DIR}
sudo npm ci --production

# 5. å¯åŠ¨åº”ç”¨
echo "ğŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡..."
sudo pm2 start ecosystem.config.js --env production

# 6. å¥åº·æ£€æŸ¥
echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
sleep 10
for i in {1..30}; do
    if curl -f http://localhost:3000/health; then
        echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
        sudo pm2 stop ${APP_NAME}
        sudo rm -rf ${DEPLOY_DIR}
        sudo mv ${DEPLOY_DIR}_old ${DEPLOY_DIR}
        sudo pm2 start ecosystem.config.js --env production
        exit 1
    fi
    sleep 2
done

# 7. æ¸…ç†æ—§ç‰ˆæœ¬
echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
sudo rm -rf ${DEPLOY_DIR}_old

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ“Š ç›‘æ§è¿ç»´é…ç½®

### 1. Prometheusç›‘æ§é…ç½®

#### åº”ç”¨æŒ‡æ ‡é‡‡é›†
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

scrape_configs:
  # åº”ç”¨æœåŠ¡ç›‘æ§
  - job_name: 'points-app'
    static_configs:
      - targets: ['10.0.1.10:3000', '10.0.1.11:3000', '10.0.1.12:3000']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  # æ•°æ®åº“ç›‘æ§
  - job_name: 'mysql'
    static_configs:
      - targets: ['10.0.2.10:9104']
    
  # Redisç›‘æ§
  - job_name: 'redis'
    static_configs:
      - targets: ['10.0.3.10:9121']
    
  # æœåŠ¡å™¨ç›‘æ§
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['10.0.1.10:9100', '10.0.1.11:9100', '10.0.1.12:9100']

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']
```

#### å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# rules/app-alerts.yml
groups:
  - name: points-app-alerts
    rules:
      # åº”ç”¨æœåŠ¡å‘Šè­¦
      - alert: AppDown
        expr: up{job="points-app"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "åº”ç”¨æœåŠ¡ä¸‹çº¿"
          description: "åº”ç”¨æœåŠ¡ {{ $labels.instance }} å·²ä¸‹çº¿è¶…è¿‡1åˆ†é’Ÿ"
      
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "é”™è¯¯ç‡è¿‡é«˜"
          description: "åº”ç”¨é”™è¯¯ç‡è¶…è¿‡10%ï¼Œå½“å‰å€¼: {{ $value }}"
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡1ç§’ï¼Œå½“å‰å€¼: {{ $value }}s"
      
      # æ•°æ®åº“å‘Šè­¦
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQLæ•°æ®åº“ä¸‹çº¿"
          description: "MySQLæ•°æ®åº“ {{ $labels.instance }} è¿æ¥å¤±è´¥"
      
      - alert: MySQLSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQLæ…¢æŸ¥è¯¢è¿‡å¤š"
          description: "æ…¢æŸ¥è¯¢é¢‘ç‡: {{ $value }}/ç§’"
      
      # Rediså‘Šè­¦
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redisç¼“å­˜ä¸‹çº¿"
          description: "Rediså®ä¾‹ {{ $labels.instance }} è¿æ¥å¤±è´¥"
      
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
```

### 2. Grafanaä»ªè¡¨æ¿

#### åº”ç”¨ç›‘æ§ä»ªè¡¨æ¿
```json
{
  "dashboard": {
    "title": "ç§¯åˆ†å°ç¨‹åºç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "QPS (æ¯ç§’è¯·æ±‚æ•°)",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[1m]))",
            "legendFormat": "æ€»QPS"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´åˆ†å¸ƒ",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "é”™è¯¯ç‡"
          }
        ]
      },
      {
        "title": "æ”¯ä»˜æˆåŠŸç‡",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(payment_success_total[5m]) / rate(payment_total[5m])",
            "legendFormat": "æ”¯ä»˜æˆåŠŸç‡"
          }
        ]
      },
      {
        "title": "ç§¯åˆ†å‘æ”¾æˆåŠŸç‡",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(points_award_success_total[5m]) / rate(points_award_total[5m])",
            "legendFormat": "ç§¯åˆ†å‘æ”¾æˆåŠŸç‡"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. SSL/TLSé…ç½®

#### è¯ä¹¦è·å–å’Œé…ç½®
```bash
# ä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦
sudo yum install -y certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d api.example.com

# è‡ªåŠ¨ç»­æœŸé…ç½®
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 2. é˜²ç«å¢™é…ç½®
```bash
# é…ç½®iptablesè§„åˆ™
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT    # SSH
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # HTTP
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # HTTPS
sudo iptables -A INPUT -p tcp --dport 3000 -j DROP    # é˜»æ­¢ç›´æ¥è®¿é—®åº”ç”¨ç«¯å£
sudo iptables -A INPUT -j DROP                        # é»˜è®¤æ‹’ç»

# ä¿å­˜è§„åˆ™
sudo service iptables save
```

### 3. æ—¥å¿—å®¡è®¡é…ç½®
```bash
# é…ç½®rsyslogé›†ä¸­æ—¥å¿—
echo "*.* @@log-server.internal:514" | sudo tee -a /etc/rsyslog.conf

# é…ç½®æ—¥å¿—è½®è½¬
cat > /etc/logrotate.d/points-app << EOF
/var/log/points-app/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 points-app points-app
    postrotate
        sudo pm2 reloadLogs
    endscript
}
EOF
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ä¸Šçº¿å‰æ£€æŸ¥é¡¹
```markdown
åŸºç¡€ç¯å¢ƒæ£€æŸ¥:
- [ ] æœåŠ¡å™¨ç¡¬ä»¶é…ç½®ç¬¦åˆè¦æ±‚
- [ ] æ“ä½œç³»ç»Ÿç‰ˆæœ¬å’Œè¡¥ä¸æœ€æ–°
- [ ] ç½‘ç»œè¿é€šæ€§æµ‹è¯•é€šè¿‡
- [ ] åŸŸåè§£æé…ç½®æ­£ç¡®
- [ ] SSLè¯ä¹¦æœ‰æ•ˆä¸”æ­£ç¡®é…ç½®

åº”ç”¨éƒ¨ç½²æ£€æŸ¥:
- [ ] åº”ç”¨ä»£ç ç‰ˆæœ¬æ­£ç¡®
- [ ] é…ç½®æ–‡ä»¶ç¯å¢ƒå˜é‡æ­£ç¡®
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Redisç¼“å­˜è¿æ¥æ­£å¸¸
- [ ] å¾®ä¿¡æ”¯ä»˜é…ç½®æ­£ç¡®

åŠŸèƒ½éªŒè¯æ£€æŸ¥:
- [ ] å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸
- [ ] ç”¨æˆ·æ³¨å†Œç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æ”¯ä»˜æµç¨‹å®Œæ•´å¯ç”¨
- [ ] ç§¯åˆ†å‘æ”¾å‡†ç¡®æ— è¯¯
- [ ] ç›‘æ§å‘Šè­¦ç³»ç»Ÿæ­£å¸¸

å®‰å…¨é…ç½®æ£€æŸ¥:
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®æ­£ç¡®
- [ ] SSL/TLSé…ç½®å®‰å…¨
- [ ] æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- [ ] è®¿é—®æƒé™æ§åˆ¶æ­£ç¡®
- [ ] æ—¥å¿—å®¡è®¡é…ç½®å®Œæ•´

æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥:
- [ ] åº”ç”¨å¯åŠ¨æ—¶é—´ < 30ç§’
- [ ] æ¥å£å“åº”æ—¶é—´ < 200ms
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 90%
- [ ] CDNé…ç½®ç”Ÿæ•ˆ
```

---

## ğŸš¨ åº”æ€¥é¢„æ¡ˆ

### 1. æ•…éšœåˆ†çº§
```yaml
P0æ•…éšœ (Critical):
  å®šä¹‰: æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
  å“åº”æ—¶é—´: 15åˆ†é’Ÿå†…
  å¤„ç†æ—¶é—´: 1å°æ—¶å†…æ¢å¤
  ä¾‹å­: æ”¯ä»˜åŠŸèƒ½å®Œå…¨ä¸­æ–­

P1æ•…éšœ (High):
  å®šä¹‰: é‡è¦åŠŸèƒ½éƒ¨åˆ†ä¸å¯ç”¨
  å“åº”æ—¶é—´: 30åˆ†é’Ÿå†…
  å¤„ç†æ—¶é—´: 4å°æ—¶å†…æ¢å¤
  ä¾‹å­: ç§¯åˆ†å‘æ”¾å»¶è¿Ÿ

P2æ•…éšœ (Medium):
  å®šä¹‰: éæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸
  å“åº”æ—¶é—´: 2å°æ—¶å†…
  å¤„ç†æ—¶é—´: 24å°æ—¶å†…æ¢å¤
  ä¾‹å­: ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºå¼‚å¸¸

P3æ•…éšœ (Low):
  å®šä¹‰: è½»å¾®é—®é¢˜ä¸å½±å“ä½¿ç”¨
  å“åº”æ—¶é—´: 1å·¥ä½œæ—¥å†…
  å¤„ç†æ—¶é—´: 1å‘¨å†…ä¿®å¤
  ä¾‹å­: é¡µé¢æ ·å¼é—®é¢˜
```

### 2. å¿«é€Ÿå›æ»šæ–¹æ¡ˆ
```bash
#!/bin/bash
# rollback.sh - å¿«é€Ÿå›æ»šè„šæœ¬

BACKUP_DIR="/opt/backups/points-app"
DEPLOY_DIR="/opt/points-app"

echo "ğŸ”„ å¼€å§‹æ‰§è¡Œå›æ»š..."

# 1. è·å–æœ€è¿‘çš„å¤‡ä»½
LATEST_BACKUP=$(ls -t ${BACKUP_DIR}/backup-*.tar.gz | head -1)

if [ -z "$LATEST_BACKUP" ]; then
    echo "âŒ æœªæ‰¾åˆ°å¯ç”¨å¤‡ä»½æ–‡ä»¶"
    exit 1
fi

echo "ğŸ“¦ ä½¿ç”¨å¤‡ä»½æ–‡ä»¶: $LATEST_BACKUP"

# 2. åœæ­¢å½“å‰æœåŠ¡
sudo pm2 stop points-app

# 3. æ¢å¤å¤‡ä»½
sudo rm -rf ${DEPLOY_DIR}_current
sudo mv ${DEPLOY_DIR} ${DEPLOY_DIR}_current
sudo mkdir -p ${DEPLOY_DIR}
sudo tar -xzf ${LATEST_BACKUP} -C ${DEPLOY_DIR}

# 4. å¯åŠ¨æœåŠ¡
sudo pm2 start ecosystem.config.js --env production

# 5. å¥åº·æ£€æŸ¥
sleep 10
if curl -f http://localhost:3000/health; then
    echo "âœ… å›æ»šæˆåŠŸ"
    sudo rm -rf ${DEPLOY_DIR}_current
else
    echo "âŒ å›æ»šå¤±è´¥ï¼Œå°è¯•æ¢å¤å½“å‰ç‰ˆæœ¬"
    sudo pm2 stop points-app
    sudo rm -rf ${DEPLOY_DIR}
    sudo mv ${DEPLOY_DIR}_current ${DEPLOY_DIR}
    sudo pm2 start ecosystem.config.js --env production
    exit 1
fi
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–é…ç½®

### 1. åº”ç”¨æ€§èƒ½ä¼˜åŒ–
```javascript
// åº”ç”¨æ€§èƒ½é…ç½®
const express = require('express')
const compression = require('compression')
const helmet = require('helmet')

const app = express()

// å¯ç”¨gzipå‹ç¼©
app.use(compression())

// å®‰å…¨å¤´é…ç½®
app.use(helmet({
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}))

// é™æ€èµ„æºç¼“å­˜
app.use(express.static('public', {
  maxAge: '1y',
  etag: true,
  lastModified: true
}))

// è¯·æ±‚é™æµ
const rateLimit = require('express-rate-limit')
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 1000, // é™åˆ¶æ¯ä¸ªIP 1000æ¬¡è¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
})
app.use('/api/', limiter)
```

### 2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
```sql
-- åˆ›å»ºå¿…è¦ç´¢å¼•
CREATE INDEX idx_payment_orders_user_id ON payment_orders(user_id);
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
CREATE INDEX idx_payment_orders_created_at ON payment_orders(created_at);
CREATE INDEX idx_points_records_user_id ON points_records(user_id);
CREATE INDEX idx_points_records_created_at ON points_records(created_at);

-- åˆ†åŒºè¡¨é…ç½®ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
ALTER TABLE points_records PARTITION BY RANGE (YEAR(created_at)*100 + MONTH(created_at))
(
    PARTITION p202412 VALUES LESS THAN (202501),
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503)
);
```

---

**æ–‡æ¡£çŠ¶æ€**ï¼šå¾…è¿ç»´è¯„å®¡  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šç¯å¢ƒæ­å»ºå’Œéƒ¨ç½²æµ‹è¯•  
**è´£ä»»äºº**ï¼šè¿ç»´è´Ÿè´£äºº  
**è¯„å®¡æ—¶é—´**ï¼šå¾…å®š
