# 微信支付积分系统开发规划（实际版）

## 📖 项目状态
- **当前版本**：V1.0（基础功能已完成）
- **更新时间**：2024年12月
- **开发状态**：准备上线

---

## 🎯 项目目标

### 核心功能（已实现）
1. **微信支付** - 用户通过商户二维码支付
2. **积分发放** - 支付成功自动发放1:1积分
3. **商户管理** - 基础的商户信息管理
4. **管理后台** - Web端管理界面

### 业务模式（现实版）
- **积分系统**：完全属于平台方
- **商户合作**：提供收款二维码，用户获得平台积分
- **数据同步**：手动录入微信商户信息（API限制）

---

## 📊 当前实现状态

### ✅ 已完成功能

#### 1. 后端服务
- **商户管理**：基础CRUD（9个字段）
- **微信API**：使用真实商户数据的Mock服务
- **积分系统**：支付后自动发放积分
- **用户认证**：JWT登录系统

#### 2. 前端界面
- **管理后台**：React + Antd简化版
- **商户列表**：显示5个真实商户数据
- **基础统计**：商户数量、订单统计

#### 3. 数据库设计
```sql
-- 商户表（当前字段）
merchants (
  id, merchant_name, merchant_no, contact_person, 
  contact_phone, business_license, status, qr_code, 
  sub_mch_id, total_amount, total_orders, 
  created_at, updated_at
)
```

### 🔄 运行中的功能
- **模拟API**：返回5个真实商户数据
- **管理界面**：可查看商户列表
- **基础统计**：显示关键指标

---

## 🚀 快速上线计划

### Phase 1：现状优化（1周内上线）
**目标**：基于现有功能快速上线

#### 立即可做的优化：
1. **商户信息补全**
   - 添加`applyment_id`字段到商户表
   - 手动录入5个商户的完整信息
   - 确保数据与微信平台一致

2. **二维码生成功能**
   - 为有`sub_mch_id`的商户生成收款码
   - 先用固定模板，后续优化

3. **基础验证**
   - 商户状态检查
   - 必填字段验证

#### 实施步骤：
```sql
-- 1. 扩展商户表
ALTER TABLE merchants ADD COLUMN applyment_id VARCHAR(64);

-- 2. 更新真实数据
UPDATE merchants SET 
  applyment_id = '2000002691156098',
  sub_mch_id = '1728001633'
WHERE merchant_name = '仁寿县怀仁街道云锦汇会所（个体工商户）';

-- 3. 其他4个商户类似更新...
```

### Phase 2：功能完善（2-3周）
**目标**：增强系统稳定性

1. **商户管理增强**
   - 完整的CRUD操作
   - 状态管理流程
   - 文件上传功能

2. **积分系统优化**
   - 积分记录详情
   - 用户积分查询
   - 过期机制

3. **管理后台完善**
   - 更多统计图表
   - 操作日志
   - 权限控制

---

## 🗄️ 数据库优化计划

### 当前表结构（保持）
```sql
-- 不动现有表结构，只补充必要字段
ALTER TABLE merchants ADD COLUMN IF NOT EXISTS applyment_id VARCHAR(64);
ALTER TABLE merchants ADD COLUMN IF NOT EXISTS merchant_type VARCHAR(32) DEFAULT 'INDIVIDUAL';
ALTER TABLE merchants ADD COLUMN IF NOT EXISTS contact_email VARCHAR(128);
```

### 新增表（最少必要）
```sql
-- 商户文件表（如需要）
CREATE TABLE merchant_files (
  id VARCHAR(50) PRIMARY KEY,
  merchant_id VARCHAR(50),
  file_type VARCHAR(32),
  file_url VARCHAR(512),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 💡 技术架构（当前）

### 后端（已有）
- **Express.js** + TypeScript
- **MySQL** 数据库
- **JWT** 认证
- **微信支付API**（基础调用）

### 前端（已有）
- **React 18** + TypeScript
- **Ant Design** UI组件
- **简化状态管理**（useState）

### 部署（已配置）
- **阿里云ECS**
- **PM2** 进程管理
- **Nginx** 反向代理

---

## ⚠️ 实际约束和解决方案

### 1. 微信API限制
**问题**：无法通过API获取商户列表
**解决**：
- 使用MockWechatApiService返回真实数据
- 手动录入商户信息
- 保持数据结构与微信API一致

### 2. 二维码生成
**问题**：需要有效的sub_mch_id
**解决**：
- 先手动配置5个商户的sub_mch_id
- 实现二维码生成基础功能
- 后续可扩展

### 3. 权限系统
**问题**：当前无复杂权限控制
**解决**：
- Phase 1：简单的管理员登录
- Phase 2：角色权限系统

---

## 📋 上线检查清单

### Phase 1 上线前检查
- [ ] 商户表字段补充完成
- [ ] 5个商户数据录入完整
- [ ] 管理后台显示正常
- [ ] 基础二维码生成功能
- [ ] 数据库备份完成
- [ ] 服务器环境确认

### 验收标准
- [ ] 管理后台可正常访问
- [ ] 商户列表显示5个真实商户
- [ ] 有sub_mch_id的商户可生成二维码
- [ ] 基础统计数据正确

---

## 🔄 迭代计划

### 版本规划
- **V1.0**：基础功能上线（当前目标）
- **V1.1**：功能完善，稳定性提升
- **V1.2**：用户体验优化
- **V2.0**：高级功能扩展

### 优先级原则
1. **先上线，再优化**
2. **基础功能优先**
3. **稳定性第一**
4. **渐进式改进**

---

**文档状态**：与实际功能匹配  
**下一步**：执行Phase 1上线计划  
**负责人**：开发团队