# 03-微信小程序开发规则总结

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月
- **编写人**：技术团队
- **审核人**：[姓名]
- **更新说明**：基于最新微信官方文档整理

---

## 🎯 核心开发规则概览

本文档汇总了微信小程序开发的核心规则和最佳实践，确保开发过程符合微信平台要求，提高审核通过率。

### 关键限制一览表
| 限制项 | 具体要求 | 影响范围 | 应对策略 |
|--------|----------|----------|----------|
| 代码包大小 | 主包≤2MB，总包≤20MB | 功能拆分 | 分包加载、代码压缩 |
| 请求并发 | 同时≤10个 | 网络请求 | 请求队列、合并请求 |
| 本地存储 | 单key≤1MB，总量≤10MB | 数据缓存 | 定期清理、云端存储 |
| 文件上传 | 单文件≤10MB | 图片视频 | 压缩上传、分片传输 |

---

## 📏 技术规范详解

### 1. 代码包管理规范

#### 代码包类型和限制
```javascript
// 代码包结构
const packageStructure = {
  mainPackage: {
    maxSize: '2MB',
    content: '核心功能、启动页面、公共资源',
    required: true
  },
  subPackages: {
    maxSize: '2MB/个',
    maxCount: 20,
    totalMaxSize: '20MB',
    lazyLoad: true
  }
}

// 最佳实践
const optimizationStrategies = {
  imageOptimization: {
    format: 'WebP优先',
    maxSize: '单张<200KB',
    lazyLoad: true,
    CDN: '大图使用CDN'
  },
  codeOptimization: {
    treeShaking: true,
    minify: true,
    removeConsole: true,
    splitChunks: true
  }
}
```

#### 分包配置示例
```json
// app.json
{
  "pages": [
    "pages/index/index",
    "pages/login/login"
  ],
  "subpackages": [
    {
      "root": "packagePayment",
      "name": "payment",
      "pages": [
        "pages/confirm/index",
        "pages/result/index"
      ],
      "independent": false
    },
    {
      "root": "packagePoints",
      "name": "points",
      "pages": [
        "pages/balance/index",
        "pages/history/index"
      ]
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["payment"]
    }
  }
}
```

### 2. 网络请求规范

#### 请求限制和最佳实践
```javascript
// 网络请求限制
const networkLimits = {
  concurrent: 10,          // 最大并发数
  timeout: 60000,         // 超时时间(ms)
  maxUploadSize: '10MB',  // 单次上传大小
  maxDownloadSize: '50MB' // 单次下载大小
}

// 请求封装示例
class RequestManager {
  constructor() {
    this.queue = []
    this.running = 0
    this.maxConcurrent = 10
  }
  
  async request(options) {
    // 队列管理
    if (this.running >= this.maxConcurrent) {
      await this.waitForSlot()
    }
    
    this.running++
    
    try {
      // 添加通用配置
      const config = {
        ...options,
        header: {
          'content-type': 'application/json',
          'Authorization': `Bearer ${getToken()}`,
          ...options.header
        },
        timeout: 30000,
        dataType: 'json'
      }
      
      // 发起请求
      const res = await wx.request(config)
      
      // 统一错误处理
      if (res.statusCode !== 200) {
        throw new Error(`请求失败: ${res.statusCode}`)
      }
      
      return res.data
      
    } finally {
      this.running--
      this.processQueue()
    }
  }
}
```

### 3. 数据存储规范

#### 本地存储管理
```javascript
// 存储限制
const storageLimits = {
  singleKey: '1MB',
  totalSize: '10MB',
  keyLength: 1024  // key最大长度
}

// 存储管理器
class StorageManager {
  // 带过期时间的存储
  static setWithExpiry(key, value, ttl) {
    const now = new Date()
    const item = {
      value: value,
      expiry: now.getTime() + ttl
    }
    wx.setStorageSync(key, JSON.stringify(item))
  }
  
  // 获取并检查过期
  static getWithExpiry(key) {
    const itemStr = wx.getStorageSync(key)
    if (!itemStr) return null
    
    const item = JSON.parse(itemStr)
    const now = new Date()
    
    if (now.getTime() > item.expiry) {
      wx.removeStorageSync(key)
      return null
    }
    
    return item.value
  }
  
  // 存储空间管理
  static async checkStorageSize() {
    const info = await wx.getStorageInfo()
    const usage = info.currentSize / info.limitSize
    
    if (usage > 0.8) {
      // 清理过期数据
      this.cleanExpiredData()
    }
    
    return {
      used: info.currentSize,
      limit: info.limitSize,
      usage: `${(usage * 100).toFixed(2)}%`
    }
  }
}
```

### 4. 支付接口规范

#### 微信支付流程
```javascript
// 支付参数结构
interface PaymentParams {
  // 统一下单参数
  unifiedOrder: {
    appid: string         // 小程序ID
    mch_id: string        // 商户号
    nonce_str: string     // 随机字符串
    sign: string          // 签名
    body: string          // 商品描述
    out_trade_no: string  // 商户订单号
    total_fee: number     // 总金额(分)
    spbill_create_ip: string // 终端IP
    notify_url: string    // 通知地址
    trade_type: 'JSAPI'   // 交易类型
    openid: string        // 用户openid
  }
  
  // 小程序调起支付参数
  requestPayment: {
    timeStamp: string     // 时间戳
    nonceStr: string      // 随机串
    package: string       // 统一下单接口返回的 prepay_id 参数值
    signType: 'MD5' | 'HMAC-SHA256'
    paySign: string       // 签名
  }
}

// 支付实现示例
async function initiatePayment(orderInfo) {
  try {
    // 1. 调用后端创建订单
    const order = await createOrder({
      amount: orderInfo.amount,
      merchantId: orderInfo.merchantId,
      userId: getUserId()
    })
    
    // 2. 获取支付参数
    const paymentParams = await getPaymentParams(order.orderId)
    
    // 3. 调起微信支付
    const payResult = await wx.requestPayment({
      timeStamp: paymentParams.timeStamp,
      nonceStr: paymentParams.nonceStr,
      package: paymentParams.package,
      signType: paymentParams.signType,
      paySign: paymentParams.paySign
    })
    
    // 4. 支付成功处理
    if (payResult.errMsg === 'requestPayment:ok') {
      // 查询支付结果
      const result = await verifyPayment(order.orderId)
      return result
    }
    
  } catch (error) {
    // 支付失败处理
    if (error.errMsg === 'requestPayment:fail cancel') {
      throw new Error('用户取消支付')
    }
    throw error
  }
}
```

---

## 🛡 安全规范

### 1. 数据安全要求

#### 敏感数据处理
```javascript
// 敏感数据类型
const sensitiveDataTypes = [
  '手机号码',
  '身份证号',
  '银行卡号',
  '密码',
  '支付信息',
  '位置信息'
]

// 数据加密示例
class SecurityManager {
  // 敏感数据加密传输
  static encryptSensitiveData(data) {
    // 使用小程序提供的加密方法
    return wx.getStorageSync('encryptKey') 
      ? this.aesEncrypt(data)
      : data
  }
  
  // 数据脱敏显示
  static maskSensitiveInfo(type, value) {
    switch(type) {
      case 'phone':
        return value.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
      case 'idCard':
        return value.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2')
      case 'bankCard':
        return value.replace(/(\d{4})\d+(\d{4})/, '$1 **** **** $2')
      default:
        return value
    }
  }
  
  // HTTPS强制检查
  static checkHttps(url) {
    if (!url.startsWith('https://')) {
      throw new Error('必须使用HTTPS协议')
    }
    return true
  }
}
```

### 2. 用户授权规范

#### 授权流程管理
```javascript
// 授权类型
const authScopes = {
  'scope.userInfo': '用户信息',
  'scope.userLocation': '地理位置',
  'scope.userLocationBackground': '后台定位',
  'scope.werun': '微信运动步数',
  'scope.record': '录音功能',
  'scope.writePhotosAlbum': '保存到相册',
  'scope.camera': '摄像头'
}

// 授权管理器
class AuthManager {
  // 检查并请求授权
  static async requireAuth(scope) {
    const authSetting = await wx.getSetting()
    
    if (authSetting.authSetting[scope] === false) {
      // 已拒绝，引导打开设置
      const modal = await wx.showModal({
        title: '授权提示',
        content: `需要您的${authScopes[scope]}授权才能使用此功能`,
        confirmText: '去设置'
      })
      
      if (modal.confirm) {
        const setting = await wx.openSetting()
        return setting.authSetting[scope]
      }
      return false
    }
    
    // 请求授权
    try {
      await wx.authorize({ scope })
      return true
    } catch (error) {
      return false
    }
  }
  
  // 获取用户信息最佳实践
  static async getUserProfile() {
    // 必须通过点击事件触发
    const result = await wx.getUserProfile({
      desc: '用于完善用户资料'
    })
    
    // 加密存储
    this.saveUserInfo(result.userInfo)
    return result.userInfo
  }
}
```

---

## 📱 UI/UX规范

### 1. 界面设计规范

#### 尺寸和适配
```css
/* 设计稿基准：iPhone 6 (375 x 667) */
/* 使用rpx作为尺寸单位，自动适配不同屏幕 */

/* 常用组件尺寸规范 */
.button-primary {
  height: 88rpx;
  font-size: 32rpx;
  border-radius: 8rpx;
}

.list-item {
  height: 100rpx;
  padding: 0 30rpx;
  font-size: 30rpx;
}

.input-field {
  height: 80rpx;
  padding: 0 20rpx;
  font-size: 28rpx;
}

/* 安全区域适配 */
.safe-area-bottom {
  padding-bottom: constant(safe-area-inset-bottom);
  padding-bottom: env(safe-area-inset-bottom);
}
```

#### 交互响应规范
```javascript
// 操作反馈时效
const interactionTiming = {
  tapFeedback: 100,      // 点击反馈 < 100ms
  pageTransition: 300,   // 页面切换 < 300ms
  loadingDisplay: 500,   // 超过500ms显示loading
  toastDuration: 1500    // toast显示时长
}

// Loading管理
class LoadingManager {
  static show(title = '加载中...') {
    wx.showLoading({
      title,
      mask: true  // 防止操作穿透
    })
  }
  
  static hide() {
    wx.hideLoading()
  }
  
  // 自动loading装饰器
  static withLoading(fn, title) {
    return async function(...args) {
      LoadingManager.show(title)
      try {
        return await fn.apply(this, args)
      } finally {
        LoadingManager.hide()
      }
    }
  }
}
```

### 2. 性能优化规范

#### 启动性能优化
```javascript
// 启动优化策略
const launchOptimization = {
  // 1. 减少同步操作
  async onLaunch() {
    // 异步操作不阻塞启动
    this.initializeAsync()
    
    // 必要的同步操作
    this.checkAuth()
  },
  
  // 2. 延迟加载
  async initializeAsync() {
    // 延迟初始化非关键服务
    setTimeout(() => {
      this.initAnalytics()
      this.preloadResources()
    }, 3000)
  },
  
  // 3. 预加载关键数据
  preloadCriticalData() {
    // 预加载首页数据
    const homeData = wx.getStorageSync('homeCache')
    if (homeData) {
      this.globalData.homeData = homeData
    }
  }
}

// 渲染性能优化
const renderOptimization = {
  // 1. 长列表优化
  listOptimization: {
    useVirtualList: true,
    pageSize: 20,
    recycleView: true
  },
  
  // 2. 图片优化
  imageOptimization: {
    lazyLoad: true,
    showMenuByLongpress: false,
    webp: true
  },
  
  // 3. setData优化
  setDataOptimization(data) {
    // 只更新变化的数据
    const changedData = {}
    for (const key in data) {
      if (this.data[key] !== data[key]) {
        changedData[key] = data[key]
      }
    }
    
    // 分批更新大数据
    if (Object.keys(changedData).length > 10) {
      this.setDataInBatches(changedData)
    } else {
      this.setData(changedData)
    }
  }
}
```

---

## 🚫 审核注意事项

### 1. 常见审核拒绝原因

#### 功能完整性
```markdown
❌ 常见问题：
1. 功能未完成或存在明显bug
2. 页面无法正常加载
3. 按钮点击无响应
4. 支付流程无法完成

✅ 解决方案：
1. 完整测试所有功能流程
2. 提供测试账号和详细说明
3. 确保所有页面可访问
4. 异常情况有友好提示
```

#### 内容合规性
```markdown
❌ 违规内容类型：
1. 诱导分享、诱导关注
2. 虚假宣传、夸大功能
3. 违法违规内容
4. 侵犯他人权益

✅ 内容规范：
1. 功能描述真实准确
2. 不使用绝对化用语
3. 遵守广告法规定
4. 尊重知识产权
```

#### 用户体验
```markdown
❌ 体验问题：
1. 强制登录才能使用
2. 过度收集用户信息
3. 广告过多影响使用
4. 操作流程过于复杂

✅ 体验优化：
1. 核心功能免登录
2. 按需获取用户授权
3. 广告展示克制合理
4. 操作流程简洁明了
```

### 2. 审核材料准备

#### 必备材料清单
```markdown
基础材料：
- [ ] 营业执照
- [ ] 法人身份证明
- [ ] 商标注册证（如涉及）
- [ ] 软件著作权证书（如涉及）

特殊资质：
- [ ] 支付业务许可证
- [ ] 金融业务资质
- [ ] 医疗相关资质
- [ ] 教育相关资质

测试材料：
- [ ] 测试账号密码
- [ ] 测试流程说明
- [ ] 功能演示视频
- [ ] 特殊说明文档
```

---

## 📊 监控和分析

### 1. 小程序数据分析

#### 关键指标监控
```javascript
// 自定义事件上报
class Analytics {
  // 页面访问统计
  static trackPageView(pagePath, options = {}) {
    wx.reportAnalytics('page_view', {
      page_path: pagePath,
      page_title: options.title || '',
      user_id: getUserId(),
      timestamp: Date.now()
    })
  }
  
  // 事件追踪
  static trackEvent(eventName, params = {}) {
    wx.reportAnalytics(eventName, {
      ...params,
      user_id: getUserId(),
      timestamp: Date.now(),
      app_version: getAppVersion()
    })
  }
  
  // 性能监控
  static trackPerformance() {
    const performance = wx.getPerformance()
    const metrics = {
      launch_time: performance.launchTime,
      first_paint: performance.firstPaint,
      first_contentful_paint: performance.firstContentfulPaint,
      dom_ready: performance.domReady
    }
    
    this.trackEvent('performance_metrics', metrics)
  }
}
```

### 2. 错误监控

#### 异常捕获和上报
```javascript
// 全局错误处理
App({
  onError(error) {
    // 错误上报
    this.reportError({
      type: 'jsError',
      error: error.toString(),
      stack: error.stack,
      page: getCurrentPages().pop()?.route,
      userInfo: this.globalData.userInfo
    })
  },
  
  onPageNotFound(res) {
    // 404处理
    this.reportError({
      type: 'pageNotFound',
      path: res.path,
      query: res.query
    })
    
    // 重定向到首页
    wx.switchTab({
      url: '/pages/index/index'
    })
  },
  
  // 统一错误上报
  reportError(errorInfo) {
    // 收集环境信息
    const systemInfo = wx.getSystemInfoSync()
    const networkType = wx.getNetworkType()
    
    const report = {
      ...errorInfo,
      app_version: this.version,
      system_info: systemInfo,
      network_type: networkType,
      timestamp: Date.now()
    }
    
    // 上报到监控平台
    wx.request({
      url: 'https://api.example.com/error/report',
      method: 'POST',
      data: report
    })
  }
})
```

---

## 🔧 开发工具和调试

### 1. 开发者工具设置

#### 推荐配置
```json
// project.config.json
{
  "setting": {
    "urlCheck": true,         // 域名校验
    "es6": true,             // ES6转ES5
    "enhance": true,         // 增强编译
    "postcss": true,         // 样式补全
    "preloadBackgroundData": false,
    "minified": true,        // 压缩代码
    "newFeature": true,
    "coverView": true,
    "nodeModules": true,
    "autoAudits": true,      // 自动体验评分
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": true,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    }
  }
}
```

### 2. 真机调试技巧

#### 调试方法集合
```javascript
// 条件编译
const DEBUG = __wxConfig.envVersion === 'develop'

// 调试工具类
class DebugHelper {
  // vconsole集成
  static enableVConsole() {
    if (DEBUG) {
      wx.setEnableDebug({
        enableDebug: true
      })
    }
  }
  
  // 性能面板
  static showPerformancePanel() {
    if (DEBUG) {
      wx.showPerformancePanel({
        enable: true
      })
    }
  }
  
  // 日志管理
  static log(...args) {
    if (DEBUG) {
      console.log('[DEBUG]', ...args)
      // 保存到日志文件
      this.saveToLogFile(args)
    }
  }
  
  // 网络请求监控
  static monitorNetwork() {
    const originalRequest = wx.request
    wx.request = function(options) {
      const startTime = Date.now()
      const originalSuccess = options.success
      const originalFail = options.fail
      
      options.success = function(res) {
        const duration = Date.now() - startTime
        DebugHelper.log('Request Success', {
          url: options.url,
          duration,
          status: res.statusCode
        })
        originalSuccess && originalSuccess(res)
      }
      
      options.fail = function(err) {
        DebugHelper.log('Request Fail', {
          url: options.url,
          error: err
        })
        originalFail && originalFail(err)
      }
      
      return originalRequest(options)
    }
  }
}
```

---

## 📝 最佳实践总结

### 开发流程建议
1. **架构设计阶段**
   - 充分考虑小程序限制
   - 合理规划分包结构
   - 设计缓存策略

2. **开发实施阶段**
   - 遵循官方规范
   - 注重性能优化
   - 做好错误处理

3. **测试发布阶段**
   - 完整功能测试
   - 多机型兼容测试
   - 准备充分的审核材料

4. **运营维护阶段**
   - 持续监控性能
   - 收集用户反馈
   - 及时修复问题

### 资源链接
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [小程序设计规范](https://developers.weixin.qq.com/miniprogram/design/)
- [运营规范](https://developers.weixin.qq.com/miniprogram/product/)

---

**文档状态**：持续更新中  
**最后更新**：2024年12月  
**维护团队**：技术开发团队
