# 04-接口需求文档

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2025年9月
- **系统架构师**：[姓名]
- **后端负责人**：[姓名]
- **评审状态**：待评审

---

## 🎯 文档概述

本文档定义积分赠送小程序所需的所有API接口，包括接口规范、数据格式、错误处理、安全认证等技术要求。

### 设计原则
1. **RESTful设计**：遵循REST架构风格
2. **统一规范**：所有接口遵循统一的设计规范
3. **安全第一**：所有接口都有安全认证和授权
4. **版本控制**：支持API版本管理和向后兼容
5. **文档驱动**：接口优先设计，文档与代码同步

---

## 🌐 接口总览

### 接口分类
```
API接口分类：
├── 用户管理接口（/api/v1/users）
│   ├── 用户注册登录
│   ├── 用户信息管理
│   └── 用户状态控制
├── 支付管理接口（/api/v1/payments）
│   ├── 支付订单管理
│   ├── 支付状态查询
│   └── 支付回调处理
├── 积分管理接口（/api/v1/points）
│   ├── 积分发放管理
│   ├── 积分查询统计
│   └── 积分规则配置
├── 商户管理接口（/api/v1/merchants）
│   ├── 商户信息管理
│   ├── 收款码管理
│   └── 交易数据查询
└── 系统管理接口（/api/v1/system）
    ├── 配置参数管理
    ├── 监控数据接口
    └── 日志查询接口
```

### 接口版本策略
```typescript
// 版本控制策略
const APIVersioning = {
  currentVersion: 'v1',
  versionHeader: 'API-Version',
  supportedVersions: ['v1'],
  deprecationPolicy: {
    noticeTime: '6个月',
    supportTime: '12个月',
    migrationGuide: '提供迁移指南'
  }
}
```

---

## 🔐 认证和授权

### 认证机制

#### JWT Token认证
```typescript
// JWT Token结构
interface JWTPayload {
  sub: string              // 用户ID
  iat: number             // 签发时间
  exp: number             // 过期时间
  aud: string             // 接收方
  iss: string             // 签发方
  roles: string[]         // 用户角色
  permissions: string[]   // 权限列表
}

// Token使用方式
const authHeader = {
  'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
}
```

#### API签名验证
```typescript
// 请求签名参数
interface RequestSignature {
  timestamp: number       // 请求时间戳
  nonce: string          // 随机字符串
  signature: string      // 签名值
}

// 签名算法
const generateSignature = (method: string, url: string, body: string, timestamp: number, nonce: string, secretKey: string) => {
  const message = `${method}\n${url}\n${body}\n${timestamp}\n${nonce}`
  return HMAC_SHA256(message, secretKey)
}
```

### 权限控制
```typescript
// 角色权限定义
enum UserRole {
  CUSTOMER = 'customer',      // 普通用户
  MERCHANT = 'merchant',      // 商户
  ADMIN = 'admin',           // 管理员
  SUPER_ADMIN = 'super_admin' // 超级管理员
}

// 权限检查中间件
const requirePermission = (permission: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (!req.user.permissions.includes(permission)) {
      return res.status(403).json({
        success: false,
        code: 'PERMISSION_DENIED',
        message: '权限不足'
      })
    }
    next()
  }
}
```

---

## 👤 用户管理接口

### POST /api/v1/users/register
用户注册接口

#### 请求参数
```typescript
interface RegisterRequest {
  code: string              // 微信授权码
  encryptedData?: string    // 加密的用户信息
  iv?: string              // 初始化向量
  signature?: string       // 数据签名
  inviteCode?: string      // 邀请码
}
```

#### 响应数据
```typescript
interface RegisterResponse {
  success: boolean
  code: string
  message: string
  data: {
    userId: string
    token: string
    refreshToken: string
    userInfo: {
      id: string
      nickname: string
      avatar: string
      phone?: string
      pointsBalance: number
      level: number
      registeredAt: string
    }
  }
}
```

#### 示例
```bash
curl -X POST "https://api.example.com/api/v1/users/register" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "wx_auth_code_123456",
    "encryptedData": "encrypted_user_data",
    "iv": "iv_string"
  }'
```

### POST /api/v1/users/login
用户登录接口

#### 请求参数
```typescript
interface LoginRequest {
  code: string              // 微信授权码
  loginType: 'wechat' | 'phone' // 登录类型
  phone?: string           // 手机号（手机登录时必填）
  verifyCode?: string      // 验证码（手机登录时必填）
}
```

### GET /api/v1/users/:userId
获取用户信息

#### 权限要求
- 用户只能查询自己的信息
- 管理员可以查询任何用户信息

#### 响应数据
```typescript
interface UserInfoResponse {
  success: boolean
  code: string
  message: string
  data: {
    id: string
    nickname: string
    avatar: string
    phone?: string
    email?: string
    pointsBalance: number
    level: number
    totalSpent: number
    registeredAt: string
    lastLoginAt: string
    status: 'active' | 'inactive' | 'banned'
  }
}
```

### PUT /api/v1/users/:userId
更新用户信息

#### 请求参数
```typescript
interface UpdateUserRequest {
  nickname?: string        // 昵称
  avatar?: string         // 头像URL
  phone?: string          // 手机号
  email?: string          // 邮箱
  preferences?: {         // 用户偏好设置
    language: string
    theme: string
    notifications: boolean
  }
}
```

---

## 💰 支付管理接口

### POST /api/v1/payments
创建支付订单

#### 请求参数
```typescript
interface CreatePaymentRequest {
  merchantId: string       // 商户ID
  amount: number          // 支付金额（分）
  description?: string    // 商品描述
  qrCodeId?: string      // 收款码ID
  customerInfo?: {        // 客户信息
    name?: string
    phone?: string
  }
  metadata?: Record<string, any> // 扩展信息
}
```

#### 响应数据
```typescript
interface CreatePaymentResponse {
  success: boolean
  code: string
  message: string
  data: {
    orderId: string
    orderNo: string
    amount: number
    merchantInfo: {
      id: string
      name: string
      avatar: string
    }
    pointsToAward: number   // 预计获得积分
    paymentInfo: {
      appId: string
      timeStamp: string
      nonceStr: string
      package: string
      signType: string
      paySign: string
    }
    expiresAt: string      // 订单过期时间
  }
}
```

### GET /api/v1/payments/:orderId
查询支付订单状态

#### 响应数据
```typescript
interface PaymentStatusResponse {
  success: boolean
  code: string
  message: string
  data: {
    orderId: string
    orderNo: string
    status: 'pending' | 'paid' | 'cancelled' | 'expired' | 'refunded'
    amount: number
    pointsAwarded: number
    merchantInfo: {
      id: string
      name: string
    }
    paidAt?: string
    createdAt: string
    expiredAt: string
  }
}
```

### POST /api/v1/payments/callback
微信支付回调接口

#### 安全要求
- 验证微信签名
- 防重复处理
- 异步处理积分发放

#### 请求参数
```typescript
interface PaymentCallbackRequest {
  id: string              // 通知ID
  create_time: string     // 通知创建时间
  event_type: string      // 通知类型
  resource_type: string   // 通知数据类型
  resource: {
    original_type: string
    algorithm: string
    ciphertext: string
    associated_data: string
    nonce: string
  }
}
```

### GET /api/v1/payments/history
支付历史查询

#### 查询参数
```typescript
interface PaymentHistoryQuery {
  userId?: string         // 用户ID
  merchantId?: string     // 商户ID
  status?: string         // 支付状态
  startDate?: string      // 开始日期
  endDate?: string        // 结束日期
  page?: number          // 页码
  pageSize?: number      // 每页数量
}
```

---

## 🎁 积分管理接口

### POST /api/v1/points/award
发放积分

#### 权限要求
- 仅系统内部调用
- 需要管理员权限

#### 请求参数
```typescript
interface AwardPointsRequest {
  userId: string          // 用户ID
  amount: number          // 积分数量
  source: string          // 积分来源
  orderId?: string        // 关联订单ID
  description: string     // 描述信息
  expiresAt?: string     // 过期时间
}
```

### GET /api/v1/points/balance/:userId
查询积分余额

#### 响应数据
```typescript
interface PointsBalanceResponse {
  success: boolean
  code: string
  message: string
  data: {
    userId: string
    totalPoints: number     // 总积分
    availablePoints: number // 可用积分
    usedPoints: number     // 已使用积分
    expiredPoints: number  // 已过期积分
    expiringPoints: number // 即将过期积分（30天内）
    expiringAt?: string    // 最近过期时间
    lastUpdated: string    // 最后更新时间
  }
}
```

### GET /api/v1/points/history/:userId
积分明细查询

#### 查询参数
```typescript
interface PointsHistoryQuery {
  changeType?: 'award' | 'deduct' | 'expire' | 'adjust' // 变动类型
  source?: string        // 积分来源
  startDate?: string     // 开始日期
  endDate?: string       // 结束日期
  page: number          // 页码
  pageSize: number      // 每页数量
}
```

#### 响应数据
```typescript
interface PointsHistoryResponse {
  success: boolean
  code: string
  message: string
  data: {
    records: Array<{
      id: string
      pointsChange: number
      pointsBalance: number
      changeType: string
      source: string
      description: string
      orderId?: string
      merchantName?: string
      createdAt: string
      expiresAt?: string
    }>
    total: number
    page: number
    pageSize: number
    hasMore: boolean
  }
}
```

### GET /api/v1/points/statistics
积分统计数据

#### 查询参数
```typescript
interface PointsStatisticsQuery {
  userId?: string        // 用户ID（管理员可查询所有用户）
  merchantId?: string    // 商户ID
  period: 'day' | 'week' | 'month' | 'year' // 统计周期
  startDate?: string     // 开始日期
  endDate?: string       // 结束日期
}
```

---

## 🏪 商户管理接口

### GET /api/v1/merchants/:merchantId
获取商户信息

#### 响应数据
```typescript
interface MerchantInfoResponse {
  success: boolean
  code: string
  message: string
  data: {
    id: string
    merchantName: string
    contactName: string
    contactPhone: string
    businessLicense: string
    address: string
    avatar: string
    description: string
    status: 'active' | 'inactive' | 'suspended'
    settingsConfig: {
      pointsRatio: number
      dailyLimit: number
      enabledFeatures: string[]
    }
    businessHours: {
      openTime: string
      closeTime: string
      isOpen: boolean
    }
    statistics: {
      totalTransactions: number
      totalAmount: number
      totalPointsAwarded: number
      customerCount: number
    }
    createdAt: string
    updatedAt: string
  }
}
```

### POST /api/v1/merchants/:merchantId/qrcodes
生成收款码

#### 请求参数
```typescript
interface CreateQRCodeRequest {
  codeType: 'fixed_amount' | 'custom_amount' // 收款码类型
  amount?: number         // 固定金额（分）
  description?: string    // 商品描述
  maxUsage?: number      // 最大使用次数
  expiresAt?: string     // 过期时间
  style?: {              // 样式配置
    template: string
    backgroundColor: string
    logoUrl: string
  }
}
```

#### 响应数据
```typescript
interface CreateQRCodeResponse {
  success: boolean
  code: string
  message: string
  data: {
    qrCodeId: string
    qrCodeUrl: string      // 二维码图片URL
    qrCodeData: string     // 二维码内容
    downloadUrl: string    // 下载链接
    printUrl: string       // 打印页面URL
    expiresAt?: string
  }
}
```

### GET /api/v1/merchants/:merchantId/transactions
商户交易流水

#### 查询参数
```typescript
interface MerchantTransactionsQuery {
  status?: string        // 交易状态
  startDate?: string     // 开始日期
  endDate?: string       // 结束日期
  customerId?: string    // 客户ID
  minAmount?: number     // 最小金额
  maxAmount?: number     // 最大金额
  page: number          // 页码
  pageSize: number      // 每页数量
}
```

---

## ⚙️ 系统管理接口

### GET /api/v1/system/config
获取系统配置

#### 权限要求
- 管理员权限

#### 响应数据
```typescript
interface SystemConfigResponse {
  success: boolean
  code: string
  message: string
  data: {
    pointsConfig: {
      defaultRatio: number
      maxDailyPoints: number
      expirationDays: number
    }
    paymentConfig: {
      orderTimeout: number
      maxAmount: number
      minAmount: number
    }
    systemConfig: {
      maintenanceMode: boolean
      enabledFeatures: string[]
      rateLimit: number
    }
  }
}
```

### PUT /api/v1/system/config
更新系统配置

#### 权限要求
- 超级管理员权限

### GET /api/v1/system/health
系统健康检查

#### 响应数据
```typescript
interface HealthCheckResponse {
  success: boolean
  code: string
  message: string
  data: {
    status: 'healthy' | 'degraded' | 'unhealthy'
    timestamp: string
    uptime: number
    version: string
    services: {
      database: 'up' | 'down'
      redis: 'up' | 'down'
      wechatPay: 'up' | 'down'
    }
    metrics: {
      responseTime: number
      errorRate: number
      throughput: number
    }
  }
}
```

---

## 📊 通用规范

### 统一响应格式

#### 成功响应
```typescript
interface SuccessResponse<T> {
  success: true
  code: 'SUCCESS'
  message: string
  data: T
  timestamp: number
  requestId: string
}
```

#### 错误响应
```typescript
interface ErrorResponse {
  success: false
  code: string
  message: string
  details?: string
  timestamp: number
  requestId: string
  path?: string
}
```

### 错误码规范

#### 系统错误码（1000-1999）
```typescript
const SystemErrors = {
  'SYSTEM_ERROR': { code: 1000, message: '系统错误' },
  'DATABASE_ERROR': { code: 1001, message: '数据库错误' },
  'REDIS_ERROR': { code: 1002, message: '缓存错误' },
  'NETWORK_ERROR': { code: 1003, message: '网络错误' }
}
```

#### 认证错误码（2000-2999）
```typescript
const AuthErrors = {
  'UNAUTHORIZED': { code: 2000, message: '未授权' },
  'TOKEN_EXPIRED': { code: 2001, message: 'Token已过期' },
  'TOKEN_INVALID': { code: 2002, message: 'Token无效' },
  'PERMISSION_DENIED': { code: 2003, message: '权限不足' }
}
```

#### 业务错误码（3000-3999）
```typescript
const BusinessErrors = {
  'USER_NOT_FOUND': { code: 3000, message: '用户不存在' },
  'MERCHANT_NOT_FOUND': { code: 3001, message: '商户不存在' },
  'ORDER_NOT_FOUND': { code: 3002, message: '订单不存在' },
  'INSUFFICIENT_POINTS': { code: 3003, message: '积分不足' },
  'PAYMENT_FAILED': { code: 3004, message: '支付失败' }
}
```

### 分页规范
```typescript
interface PaginationRequest {
  page: number           // 页码，从1开始
  pageSize: number       // 每页数量，默认20，最大100
  sort?: string         // 排序字段
  order?: 'asc' | 'desc' // 排序方向
}

interface PaginationResponse<T> {
  data: T[]
  total: number
  page: number
  pageSize: number
  totalPages: number
  hasMore: boolean
}
```

### 限流规范
```typescript
const RateLimitRules = {
  // 默认限制
  default: {
    windowMs: 60 * 1000,   // 1分钟
    max: 60,               // 最多60次请求
    skipSuccessfulRequests: false
  },
  
  // 登录接口限制
  login: {
    windowMs: 15 * 60 * 1000, // 15分钟
    max: 5,                   // 最多5次登录尝试
    skipSuccessfulRequests: true
  },
  
  // 支付接口限制
  payment: {
    windowMs: 60 * 1000,   // 1分钟
    max: 10,               // 最多10次支付请求
    skipSuccessfulRequests: false
  }
}
```

---

## 🔧 开发规范

### 接口命名规范
```typescript
// RESTful风格命名
const NamingRules = {
  // 资源名称使用复数
  users: '/api/v1/users',
  merchants: '/api/v1/merchants',
  payments: '/api/v1/payments',
  
  // HTTP方法对应操作
  'GET /users': '获取用户列表',
  'GET /users/:id': '获取单个用户',
  'POST /users': '创建用户',
  'PUT /users/:id': '更新用户',
  'DELETE /users/:id': '删除用户',
  
  // 子资源命名
  'GET /users/:id/points': '获取用户积分',
  'POST /merchants/:id/qrcodes': '创建收款码'
}
```

### 接口文档规范
```typescript
// 接口文档必须包含的信息
interface APIDocumentation {
  summary: string          // 接口简介
  description: string      // 详细描述
  method: string          // HTTP方法
  path: string            // 接口路径
  parameters: Array<{     // 参数列表
    name: string
    type: string
    required: boolean
    description: string
    example: any
  }>
  responses: Array<{      // 响应示例
    status: number
    description: string
    example: any
  }>
  errors: Array<{         // 错误码
    code: string
    message: string
    scenario: string
  }>
  examples: Array<{       // 请求示例
    title: string
    request: any
    response: any
  }>
}
```

### 测试规范
```typescript
// 接口测试要求
const TestingRequirements = {
  unitTests: {
    coverage: '>= 80%',
    framework: 'Jest',
    focus: ['业务逻辑', '边界条件', '异常处理']
  },
  
  integrationTests: {
    coverage: '>= 70%',
    framework: 'Supertest',
    focus: ['接口流程', '数据库交互', '第三方服务']
  },
  
  e2eTests: {
    coverage: '核心流程',
    framework: 'Cypress',
    focus: ['用户注册', '支付流程', '积分发放']
  }
}
```

---

## 📝 接口变更日志

### v1.0.0 (2024-12-XX)
- [ ] 初始版本发布
- [ ] 用户管理接口
- [ ] 支付管理接口
- [ ] 积分管理接口
- [ ] 商户管理接口
- [ ] 系统管理接口

### v1.1.0 (计划中)
- [ ] 增加批量操作接口
- [ ] 优化分页查询性能
- [ ] 增加数据导出接口
- [ ] 完善错误处理机制

---

**文档状态**：待技术评审  
**下一步行动**：接口详细设计和开发  
**责任人**：系统架构师  
**评审时间**：待定
