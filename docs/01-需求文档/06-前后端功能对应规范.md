# å‰åç«¯åŠŸèƒ½å¯¹åº”è§„èŒƒæ–‡æ¡£

## ğŸ“– æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV2.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ26æ—¥
- **æ›´æ–°æ—¥æœŸ**ï¼šç”Ÿäº§ç¯å¢ƒæ”¹é€ 
- **è¯„å®¡çŠ¶æ€**ï¼šå·²è¯„å®¡

---

## ğŸ¯ æ–‡æ¡£ç›®æ ‡

**ç¡®ä¿å°ç¨‹åºå‰ç«¯ä¸åç«¯APIåŠŸèƒ½å®Œå…¨å¯¹åº”ï¼Œæ¶ˆé™¤æ‰€æœ‰æ¨¡æ‹Ÿæ•°æ®ï¼Œå®ç°çœŸå®æ•°æ®æµè½¬ã€‚**

---

## ğŸ“Š æ ¸å¿ƒä¸šåŠ¡æµç¨‹å¯¹åº”

### 1. ç”¨æˆ·ç™»å½•è®¤è¯æµç¨‹

#### å‰ç«¯å°ç¨‹åº (`app.js`, `services/auth.js`)
```javascript
// âŒ å½“å‰çŠ¶æ€ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
globalData: {
  token: 'demo-token-' + Date.now(),
  userInfo: {
    nickname: 'ç§¯åˆ†æµ‹è¯•ç”¨æˆ·',
    openid: 'demo-openid-123'
  }
}

// âœ… åº”è¯¥æ”¹ä¸ºï¼šçœŸå®å¾®ä¿¡ç™»å½•
async wechatLogin() {
  const { code } = await wx.login();
  const response = await wx.request({
    url: '/api/v1/auth/wechat-login',
    method: 'POST',
    data: { code }
  });
  return response.data;
}
```

#### åç«¯API (`/api/v1/auth/wechat-login`)
```typescript
// âœ… å·²å®ç°ï¼šçœŸå®å¾®ä¿¡ç™»å½•é€»è¾‘
export async function wechatLogin(req: Request, res: Response) {
  const { code } = req.body;
  
  // 1. è°ƒç”¨å¾®ä¿¡APIè·å–openid
  const wechatUser = await getWechatUserInfo(code);
  
  // 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
  let user = await UserModel.findByOpenId(wechatUser.openid);
  if (!user) {
    user = await UserModel.create({
      openid: wechatUser.openid,
      nickname: wechatUser.nickname,
      avatar: wechatUser.avatar
    });
  }
  
  // 3. ç”ŸæˆJWT Token
  const token = generateJWT(user.id);
  
  res.json({ success: true, data: { token, userInfo: user } });
}
```

### 2. ç§¯åˆ†æŸ¥è¯¢æµç¨‹

#### å‰ç«¯å°ç¨‹åº (`pages/points/index.js`)
```javascript
// âŒ å½“å‰çŠ¶æ€ï¼šç¡¬ç¼–ç æ¼”ç¤ºæ•°æ®
showErrorData() {
  this.setData({
    balanceInfo: {
      balance: 1288,           // ç¡¬ç¼–ç æ•°æ®
      totalEarned: 2000,       // ç¡¬ç¼–ç æ•°æ®
      totalSpent: 712,         // ç¡¬ç¼–ç æ•°æ®
    }
  });
}

// âœ… åº”è¯¥æ”¹ä¸ºï¼šè°ƒç”¨çœŸå®API
async loadRealPointsData() {
  const response = await wx.request({
    url: `${app.globalData.baseUrl}/points/balance`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${app.globalData.token}`
    }
  });
  
  if (response.data.success) {
    this.setData({
      balanceInfo: response.data.data
    });
  }
}
```

#### åç«¯API (`/api/v1/points/balance`)
```typescript
// âœ… å·²å®ç°ï¼šè¿æ¥çœŸå®æ•°æ®åº“
export async function getPointsBalance(req: Request, res: Response) {
  const userId = req.user.id;
  
  const userPoints = await UserPointsModel.findByPk(userId);
  const stats = await PointsService.getUserPointsBalance(userId);
  
  res.json({
    success: true,
    data: {
      balance: stats.balance,
      totalEarned: stats.totalEarned,
      totalSpent: stats.totalSpent,
      expiringPoints: stats.expiringPoints
    }
  });
}
```

### 3. æ”¯ä»˜æµç¨‹

#### å‰ç«¯å°ç¨‹åº (`pages/payment/index.js`)
```javascript
// âŒ å½“å‰çŠ¶æ€ï¼šæ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
async mockPayment() {
  // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
  setTimeout(() => {
    this.handlePaymentSuccess({
      orderId: 'MOCK_' + Date.now(),
      amount: this.data.amount,
      awardedPoints: this.data.expectedPoints
    });
  }, 2000);
}

// âœ… åº”è¯¥æ”¹ä¸ºï¼šçœŸå®å¾®ä¿¡æ”¯ä»˜
async realWechatPayment() {
  // 1. åˆ›å»ºæ”¯ä»˜è®¢å•
  const orderResponse = await wx.request({
    url: `${app.globalData.baseUrl}/payments/create`,
    method: 'POST',
    data: {
      merchantId: this.data.merchantId,
      amount: this.data.amount * 100  // è½¬æ¢ä¸ºåˆ†
    },
    header: {
      'Authorization': `Bearer ${app.globalData.token}`
    }
  });
  
  if (orderResponse.data.success) {
    // 2. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
    const payResult = await wx.requestPayment({
      timeStamp: orderResponse.data.data.timeStamp,
      nonceStr: orderResponse.data.data.nonceStr,
      package: orderResponse.data.data.packageStr,
      signType: 'RSA',
      paySign: orderResponse.data.data.paySign
    });
    
    // 3. æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨è·å¾—ç§¯åˆ†
    this.checkPaymentResult(orderResponse.data.data.orderId);
  }
}
```

#### åç«¯API (`/api/v1/payments/create`)
```typescript
// âœ… æ–°å¢ï¼šå®Œæ•´å¾®ä¿¡æ”¯ä»˜é›†æˆ
export async function createPayment(req: Request, res: Response) {
  const { merchantId, amount } = req.body;
  const userId = req.user.id;
  
  // 1. åˆ›å»ºæ”¯ä»˜è®¢å•
  const paymentResult = await WechatPayService.createPaymentOrder({
    userId,
    merchantId,
    amount,
    description: 'å•†æˆ·æ”¶æ¬¾'
  });
  
  res.json({
    success: true,
    data: paymentResult
  });
}

// æ”¯ä»˜å›è°ƒå¤„ç† - è‡ªåŠ¨å‘æ”¾ç§¯åˆ†
export async function paymentNotify(req: Request, res: Response) {
  const callbackData = req.body;
  
  // 1. éªŒè¯ç­¾å
  // 2. æ›´æ–°è®¢å•çŠ¶æ€
  // 3. è‡ªåŠ¨å‘æ”¾ç§¯åˆ†
  await WechatPayService.handlePaymentCallback(callbackData);
  
  res.send('<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>');
}
```

### 4. å•†æˆ·ä¿¡æ¯æŸ¥è¯¢

#### å‰ç«¯å°ç¨‹åº (`pages/payment/index.js`)
```javascript
// âŒ å½“å‰çŠ¶æ€ï¼šç¡¬ç¼–ç å•†æˆ·ä¿¡æ¯
const mockMerchants = {
  'merchant_demo_001': {
    name: 'æ•°è°·å¼‚è”ç§‘æŠ€',
    desc: 'ç§‘æŠ€æœåŠ¡ä¸“å®¶',
    avatar: '/images/merchants/shugu.png'
  }
};

// âœ… åº”è¯¥æ”¹ä¸ºï¼šè°ƒç”¨çœŸå®å•†æˆ·API
async loadMerchantInfo(merchantId) {
  const response = await wx.request({
    url: `${app.globalData.baseUrl}/merchants/${merchantId}`,
    method: 'GET'
  });
  
  if (response.data.success) {
    this.setData({
      merchantInfo: response.data.data
    });
  }
}
```

#### åç«¯API (`/api/v1/merchants/:id`)
```typescript
// âœ… å·²å®ç°ï¼šçœŸå®å•†æˆ·æ•°æ®æŸ¥è¯¢
export async function getMerchantDetail(req: Request, res: Response) {
  const { id } = req.params;
  
  const merchant = await MerchantModel.findById(id);
  
  if (!merchant) {
    return res.status(404).json({
      success: false,
      message: 'å•†æˆ·ä¸å­˜åœ¨'
    });
  }
  
  res.json({
    success: true,
    data: {
      id: merchant.id,
      name: merchant.merchantName,
      subMchId: merchant.subMchId,
      businessCategory: merchant.businessCategory,
      status: merchant.status
    }
  });
}
```

---

## ğŸ”„ æ•°æ®åŒæ­¥å¯¹åº”è¡¨

### ç”¨æˆ·æ•°æ®
| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®è¡¨ | è¯´æ˜ |
|---------|---------|-------|------|
| `userInfo.nickname` | `users.nickname` | `users` | ç”¨æˆ·æ˜µç§° |
| `userInfo.avatar` | `users.avatar` | `users` | ç”¨æˆ·å¤´åƒ |
| `userInfo.openid` | `users.wechat_id` | `users` | å¾®ä¿¡OpenID |
| `userInfo.phone` | `users.phone` | `users` | æ‰‹æœºå·ç  |

### ç§¯åˆ†æ•°æ®
| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®è¡¨ | è¯´æ˜ |
|---------|---------|-------|------|
| `balanceInfo.balance` | `user_points.available_points` | `user_points` | å¯ç”¨ç§¯åˆ†ä½™é¢ |
| `balanceInfo.totalEarned` | `SUM(points_change > 0)` | `points_records` | ç´¯è®¡è·å¾—ç§¯åˆ† |
| `balanceInfo.totalSpent` | `SUM(points_change < 0)` | `points_records` | ç´¯è®¡æ¶ˆè´¹ç§¯åˆ† |
| `balanceInfo.expiringPoints` | `SUM(expires_at <= DATE_ADD(NOW(), INTERVAL 30 DAY))` | `points_records` | å³å°†è¿‡æœŸç§¯åˆ† |

### å•†æˆ·æ•°æ®
| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®è¡¨ | è¯´æ˜ |
|---------|---------|-------|------|
| `merchantInfo.name` | `merchants.merchant_name` | `merchants` | å•†æˆ·åç§° |
| `merchantInfo.subMchId` | `merchants.sub_mch_id` | `merchants` | å¾®ä¿¡ç‰¹çº¦å•†æˆ·å· |
| `merchantInfo.businessCategory` | `merchants.business_category` | `merchants` | ç»è¥ç±»ç›® |
| `merchantInfo.status` | `merchants.status` | `merchants` | å•†æˆ·çŠ¶æ€ |

### æ”¯ä»˜è®¢å•æ•°æ®
| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | æ•°æ®è¡¨ | è¯´æ˜ |
|---------|---------|-------|------|
| `orderId` | `payment_orders.id` | `payment_orders` | è®¢å•ID |
| `amount` | `payment_orders.amount` | `payment_orders` | æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰ |
| `status` | `payment_orders.status` | `payment_orders` | è®¢å•çŠ¶æ€ |
| `paidAt` | `payment_orders.paid_at` | `payment_orders` | æ”¯ä»˜æ—¶é—´ |

---

## ğŸš€ æ”¹é€ å®æ–½æ­¥éª¤

### Step 1: ä¿®å¤å°ç¨‹åºè®¤è¯é€»è¾‘ âš ï¸ **ç´§æ€¥**
```javascript
// æ–‡ä»¶: frontend/miniprogram/app.js
// ç§»é™¤: autoLogin() æ¼”ç¤ºæ¨¡å¼
// æ·»åŠ : çœŸå®å¾®ä¿¡ç™»å½•é€»è¾‘

onLaunch() {
  console.log('ğŸš€ ç§¯åˆ†åŠ©æ‰‹å°ç¨‹åºå¯åŠ¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰')
  this.checkLoginStatus()  // æ£€æŸ¥ç™»å½•çŠ¶æ€
}

async checkLoginStatus() {
  const token = wx.getStorageSync('token')
  if (token) {
    this.globalData.token = token
    await this.validateToken()  // éªŒè¯tokenæœ‰æ•ˆæ€§
  } else {
    this.doWechatLogin()  // æ‰§è¡Œå¾®ä¿¡ç™»å½•
  }
}
```

### Step 2: ä¿®å¤ç§¯åˆ†é¡µé¢æ•°æ®åŠ è½½ âš ï¸ **ç´§æ€¥**
```javascript
// æ–‡ä»¶: frontend/miniprogram/pages/points/index.js
// ç§»é™¤: showErrorData() ç¡¬ç¼–ç æ•°æ®
// ä¿®å¤: loadData() è°ƒç”¨çœŸå®API

async loadData() {
  try {
    const [balanceRes, historyRes] = await Promise.all([
      this.requestAPI('/points/balance'),
      this.requestAPI('/points/history')
    ])
    
    this.setData({
      balanceInfo: balanceRes.data,
      records: historyRes.data.records
    })
  } catch (error) {
    wx.showToast({ title: 'æ•°æ®åŠ è½½å¤±è´¥', icon: 'error' })
  }
}
```

### Step 3: ä¿®å¤æ”¯ä»˜é¡µé¢é€»è¾‘ âš ï¸ **ç´§æ€¥**
```javascript
// æ–‡ä»¶: frontend/miniprogram/pages/payment/index.js
// ç§»é™¤: mockPayment() æ¨¡æ‹Ÿæ”¯ä»˜
// ä¿®å¤: handlePay() çœŸå®å¾®ä¿¡æ”¯ä»˜

async handlePay() {
  try {
    // 1. åˆ›å»ºæ”¯ä»˜è®¢å•
    const orderRes = await this.requestAPI('/payments/create', 'POST', {
      merchantId: this.data.merchantId,
      amount: this.data.amount * 100
    })
    
    // 2. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
    await wx.requestPayment({
      ...orderRes.data
    })
    
    // 3. æ”¯ä»˜æˆåŠŸï¼Œè·³è½¬ç§¯åˆ†é¡µé¢
    wx.redirectTo({
      url: '/pages/points/index?paymentSuccess=true'
    })
  } catch (error) {
    wx.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'error' })
  }
}
```

### Step 4: ç»Ÿä¸€ç½‘ç»œè¯·æ±‚å·¥å…· ğŸ”§
```javascript
// æ–‡ä»¶: frontend/miniprogram/utils/request.js
// åˆ›å»ºç»Ÿä¸€çš„ç½‘ç»œè¯·æ±‚å·¥å…·

export function requestAPI(url, method = 'GET', data = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${app.globalData.baseUrl}${url}`,
      method,
      data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${app.globalData.token}`
      },
      success: (res) => {
        if (res.data.success) {
          resolve(res.data)
        } else {
          reject(new Error(res.data.message))
        }
      },
      fail: reject
    })
  })
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å°ç¨‹åºå¯åŠ¨åè‡ªåŠ¨æ‰§è¡ŒçœŸå®å¾®ä¿¡ç™»å½•
- [ ] ç§¯åˆ†é¡µé¢æ˜¾ç¤ºæ¥è‡ªæ•°æ®åº“çš„çœŸå®æ•°æ®
- [ ] æ”¯ä»˜æµç¨‹è°ƒç”¨çœŸå®å¾®ä¿¡æ”¯ä»˜API
- [ ] æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å‘æ”¾ç§¯åˆ†åˆ°æ•°æ®åº“
- [ ] å•†æˆ·ä¿¡æ¯æ¥è‡ªçœŸå®æ•°æ®åº“æŸ¥è¯¢

### æ•°æ®éªŒæ”¶
- [ ] å‰ç«¯æ˜¾ç¤ºçš„ç”¨æˆ·ä¿¡æ¯ä¸æ•°æ®åº“`users`è¡¨ä¸€è‡´
- [ ] å‰ç«¯æ˜¾ç¤ºçš„ç§¯åˆ†ä½™é¢ä¸æ•°æ®åº“`user_points`è¡¨ä¸€è‡´
- [ ] å‰ç«¯æ˜¾ç¤ºçš„å•†æˆ·ä¿¡æ¯ä¸æ•°æ®åº“`merchants`è¡¨ä¸€è‡´
- [ ] å‰ç«¯æ”¯ä»˜è®¢å•ä¸æ•°æ®åº“`payment_orders`è¡¨ä¸€è‡´

### APIéªŒæ”¶
- [ ] `/api/v1/auth/wechat-login` è¿”å›çœŸå®ç”¨æˆ·æ•°æ®
- [ ] `/api/v1/points/balance` è¿”å›æ•°æ®åº“ç§¯åˆ†æ•°æ®
- [ ] `/api/v1/payments/create` åˆ›å»ºçœŸå®æ”¯ä»˜è®¢å•
- [ ] `/api/v1/merchants/:id` è¿”å›æ•°æ®åº“å•†æˆ·æ•°æ®

---

## ğŸ¯ å®Œæˆåæ•ˆæœ

**å‰ç«¯å°ç¨‹åºä¸åç«¯APIå®Œå…¨åŒæ­¥ï¼Œå®ç°ï¼š**

1. **çœŸå®ç”¨æˆ·è®¤è¯**ï¼šå¾®ä¿¡ç™»å½• â†’ JWT Token â†’ ç”¨æˆ·çŠ¶æ€æŒä¹…åŒ–
2. **çœŸå®ç§¯åˆ†ç³»ç»Ÿ**ï¼šæ•°æ®åº“ç§¯åˆ† â†’ å‰ç«¯æ˜¾ç¤º â†’ å®æ—¶åŒæ­¥
3. **çœŸå®æ”¯ä»˜æµç¨‹**ï¼šæ‰«ç  â†’ å¾®ä¿¡æ”¯ä»˜ â†’ è‡ªåŠ¨ç§¯åˆ†å‘æ”¾
4. **çœŸå®å•†æˆ·æ•°æ®**ï¼šæ•°æ®åº“å•†æˆ· â†’ APIæŸ¥è¯¢ â†’ å‰ç«¯å±•ç¤º
5. **ç«¯åˆ°ç«¯é—­ç¯**ï¼šæ‰«ç æ”¯ä»˜ â†’ ç§¯åˆ†è·å¾— â†’ ä½™é¢æ›´æ–°

**æ¶ˆé™¤æ‰€æœ‰ç¡¬ç¼–ç å’Œæ¨¡æ‹Ÿæ•°æ®ï¼Œå®ç°å®Œæ•´çš„ç”Ÿäº§çº§ä¸šåŠ¡æµç¨‹ï¼**

---

**æ–‡æ¡£çŠ¶æ€**ï¼šç”Ÿäº§æ”¹é€ æŒ‡å¯¼ - ç«‹å³æ‰§è¡Œ  
**è´£ä»»äºº**ï¼šå‰ç«¯å¼€å‘ + åç«¯å¼€å‘  
**å®Œæˆæ—¶é—´**ï¼š2å°æ—¶å†…å®Œæˆæ”¹é€ 
