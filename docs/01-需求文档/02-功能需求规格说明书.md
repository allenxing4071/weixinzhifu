# 02-功能需求规格说明书（FRD）

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月
- **需求分析师**：[姓名]
- **产品经理**：[姓名]
- **评审状态**：待评审

---

## 🎯 文档概述

本文档详细描述积分赠送小程序的功能需求规格，包括每个功能模块的详细业务逻辑、数据处理规则、异常处理机制等技术实现要求。

### 文档目的
1. 为开发团队提供详细的功能实现指导
2. 明确各功能模块的输入输出规范
3. 定义数据处理和业务规则
4. 确保功能实现的完整性和一致性

---

## 🏗 系统功能架构

### 功能模块结构
```
积分赠送小程序
├── 用户管理模块
│   ├── 用户注册登录
│   ├── 用户信息管理
│   └── 用户权限控制
├── 支付管理模块
│   ├── 扫码支付功能
│   ├── 支付状态管理
│   └── 支付记录查询
├── 积分管理模块
│   ├── 积分发放功能
│   ├── 积分查询功能
│   └── 积分统计分析
├── 商户管理模块
│   ├── 商户信息管理
│   ├── 收款码管理
│   └── 交易流水管理
└── 系统管理模块
    ├── 配置参数管理
    ├── 日志审计管理
    └── 监控告警管理
```

---

## 👤 用户管理模块

### FRD-001：用户注册登录功能

#### 功能描述
用户通过微信授权快速注册和登录系统，获得使用积分赠送功能的权限。

#### 业务规则
```typescript
interface UserRegistrationRules {
  // 注册条件
  registrationConditions: {
    wechatAuth: '必须通过微信授权',
    userInfo: '需要获取用户基本信息（昵称、头像）',
    phoneNumber: '可选获取手机号码',
    agreement: '必须同意用户协议和隐私政策'
  },
  
  // 用户唯一性
  uniqueness: {
    identifier: 'wechat_openid',
    duplicateHandling: '同一openid只能注册一次',
    mergeStrategy: '多端登录共享同一账户'
  },
  
  // 默认设置
  defaultSettings: {
    status: 'active',
    pointsBalance: 0,
    registrationSource: 'wechat_miniprogram',
    notificationEnabled: true
  }
}
```

#### 输入输出规范

**输入参数**：
```typescript
interface RegistrationInput {
  code: string              // 微信授权码
  encryptedData?: string    // 加密的用户信息
  iv?: string              // 初始化向量
  signature?: string       // 数据签名
}
```

**输出结果**：
```typescript
interface RegistrationOutput {
  success: boolean
  data?: {
    userId: string
    token: string
    userInfo: {
      id: string
      nickname: string
      avatar: string
      phone?: string
      pointsBalance: number
    }
  }
  error?: {
    code: string
    message: string
  }
}
```

#### 异常处理
```typescript
const RegistrationErrors = {
  'WECHAT_AUTH_FAILED': '微信授权失败',
  'INVALID_CODE': '授权码无效或已过期',
  'USER_INFO_INCOMPLETE': '用户信息不完整',
  'AGREEMENT_NOT_ACCEPTED': '未同意用户协议',
  'SYSTEM_ERROR': '系统错误，请稍后重试'
}
```

### FRD-002：用户信息管理功能

#### 功能描述
管理用户的基本信息、偏好设置、积分账户等数据。

#### 业务规则
```typescript
interface UserInfoManagementRules {
  // 信息更新规则
  updateRules: {
    nickname: '可更新，长度1-20字符',
    avatar: '可更新，支持微信头像和自定义头像',
    phone: '可绑定，需要验证码验证',
    preferences: '个性化设置可随时修改'
  },
  
  // 隐私保护
  privacyProtection: {
    phoneDisplay: '手机号脱敏显示',
    dataEncryption: '敏感信息加密存储',
    accessControl: '用户只能访问自己的信息'
  }
}
```

---

## 💰 支付管理模块

### FRD-003：扫码支付功能

#### 功能描述
用户通过小程序扫描商户二维码，完成支付并自动获得积分奖励。

#### 业务流程
```
1. 用户扫描二维码
   ├── 解析二维码内容
   ├── 验证商户信息
   ├── 获取支付参数
   └── 跳转支付确认页

2. 支付信息确认
   ├── 显示商户信息
   ├── 显示支付金额
   ├── 显示积分奖励
   └── 用户确认支付

3. 调用微信支付
   ├── 生成支付订单
   ├── 调用微信支付API
   ├── 用户完成支付
   └── 接收支付回调

4. 支付后处理
   ├── 更新订单状态
   ├── 发放积分奖励
   ├── 发送成功通知
   └── 记录交易日志
```

#### 数据模型
```typescript
interface PaymentOrder {
  id: string                    // 订单ID
  orderNo: string              // 订单号
  userId: string               // 用户ID
  merchantId: string           // 商户ID
  amount: number               // 支付金额（分）
  description?: string         // 商品描述
  status: PaymentStatus        // 支付状态
  paymentMethod: string        // 支付方式
  wechatTransactionId?: string // 微信交易号
  pointsAwarded: number        // 奖励积分
  createdAt: Date             // 创建时间
  paidAt?: Date               // 支付时间
  expiredAt: Date             // 过期时间
}

enum PaymentStatus {
  PENDING = 'pending',         // 待支付
  PAID = 'paid',              // 已支付
  CANCELLED = 'cancelled',     // 已取消
  EXPIRED = 'expired',        // 已过期
  REFUNDED = 'refunded'       // 已退款
}
```

#### 业务规则
```typescript
interface PaymentBusinessRules {
  // 支付金额限制
  amountLimits: {
    min: 1,              // 最小1分
    max: 500000,         // 最大5000元
    precision: 2         // 精确到分
  },
  
  // 积分发放规则
  pointsRules: {
    ratio: 1,           // 1元=1积分
    minAmount: 1,       // 最小发放金额1分
    maxDailyPoints: 10000, // 每日最大获得积分
    awardTiming: 'immediate' // 立即发放
  },
  
  // 订单有效期
  orderExpiry: {
    duration: 300,      // 5分钟
    cleanupInterval: 3600 // 1小时清理一次过期订单
  }
}
```

### FRD-004：支付状态管理功能

#### 功能描述
管理支付订单的状态流转，处理支付成功、失败、超时等各种情况。

#### 状态流转图
```
PENDING (待支付)
├── 用户支付成功 → PAID (已支付)
├── 用户取消支付 → CANCELLED (已取消)
├── 支付超时 → EXPIRED (已过期)
└── 系统退款 → REFUNDED (已退款)

PAID (已支付)
├── 申请退款 → REFUNDED (已退款)
└── 最终状态

CANCELLED/EXPIRED/REFUNDED
└── 最终状态
```

---

## 🎁 积分管理模块

### FRD-005：积分发放功能

#### 功能描述
根据用户支付金额自动计算和发放积分，记录积分变动历史。

#### 业务规则
```typescript
interface PointsAwardRules {
  // 发放条件
  awardConditions: {
    paymentSuccess: '支付成功后立即发放',
    minimumAmount: 1, // 最小支付金额1分
    userStatus: 'active', // 用户状态必须为active
    merchantStatus: 'active' // 商户状态必须为active
  },
  
  // 计算规则
  calculationRules: {
    baseRatio: 1, // 基础比例1:1
    roundingRule: 'down', // 向下取整
    maximumDaily: 10000, // 每日最大获得积分
    maximumSingle: 5000 // 单次最大获得积分
  },
  
  // 积分有效期
  expiration: {
    defaultDays: 365, // 默认1年有效期
    extensionPolicy: 'fixed', // 固定有效期
    expiredHandling: 'auto_cleanup' // 自动清理过期积分
  }
}
```

#### 积分记录模型
```typescript
interface PointsRecord {
  id: string
  userId: string
  orderId?: string           // 关联订单ID
  pointsChange: number       // 积分变动数量（正数为增加）
  pointsBalance: number      // 变动后余额
  changeType: PointsChangeType
  source: string            // 积分来源
  description: string       // 描述信息
  expiresAt?: Date         // 过期时间
  createdAt: Date          // 创建时间
}

enum PointsChangeType {
  AWARD = 'award',         // 奖励获得
  DEDUCT = 'deduct',       // 消费扣减
  EXPIRE = 'expire',       // 过期清理
  ADJUST = 'adjust'        // 管理员调整
}
```

### FRD-006：积分查询功能

#### 功能描述
提供用户积分余额查询、积分明细查询、积分统计分析等功能。

#### 查询接口规范

**积分余额查询**：
```typescript
interface PointsBalanceQuery {
  userId: string
}

interface PointsBalanceResponse {
  totalPoints: number       // 总积分
  availablePoints: number   // 可用积分
  usedPoints: number       // 已使用积分
  expiredPoints: number    // 已过期积分
  expiringPoints: number   // 即将过期积分（30天内）
  lastUpdated: Date        // 最后更新时间
}
```

**积分明细查询**：
```typescript
interface PointsHistoryQuery {
  userId: string
  changeType?: PointsChangeType
  dateRange?: {
    startDate: Date
    endDate: Date
  }
  pagination: {
    page: number
    pageSize: number
  }
}

interface PointsHistoryResponse {
  records: PointsRecord[]
  total: number
  page: number
  pageSize: number
  hasMore: boolean
}
```

---

## 🏪 商户管理模块

### FRD-007：商户信息管理功能

#### 功能描述
管理商户的基本信息、经营资质、状态控制等。

#### 商户数据模型
```typescript
interface Merchant {
  id: string
  merchantName: string      // 商户名称
  contactName: string       // 联系人姓名
  contactPhone: string      // 联系电话
  businessLicense: string   // 营业执照号
  businessScope: string     // 经营范围
  address: string          // 经营地址
  status: MerchantStatus   // 商户状态
  settingsConfig: {
    pointsRatio: number    // 积分比例（可自定义）
    dailyLimit: number     // 日交易限额
    enabledFeatures: string[] // 启用功能列表
  }
  createdAt: Date
  updatedAt: Date
}

enum MerchantStatus {
  PENDING = 'pending',     // 待审核
  ACTIVE = 'active',       // 正常营业
  SUSPENDED = 'suspended', // 暂停营业
  DISABLED = 'disabled'    // 已禁用
}
```

### FRD-008：收款码管理功能

#### 功能描述
为商户生成和管理专属的收款二维码，支持固定金额和自定义金额。

#### 收款码类型
```typescript
interface PaymentQRCode {
  id: string
  merchantId: string
  codeType: QRCodeType
  amount?: number          // 固定金额（分）
  description?: string     // 商品描述
  qrCodeUrl: string       // 二维码图片URL
  qrCodeData: string      // 二维码内容
  status: QRCodeStatus
  usageCount: number      // 使用次数
  maxUsage?: number       // 最大使用次数
  expiresAt?: Date        // 过期时间
  createdAt: Date
}

enum QRCodeType {
  FIXED_AMOUNT = 'fixed_amount',    // 固定金额
  CUSTOM_AMOUNT = 'custom_amount'   // 自定义金额
}

enum QRCodeStatus {
  ACTIVE = 'active',      // 活跃
  INACTIVE = 'inactive',  // 停用
  EXPIRED = 'expired'     // 已过期
}
```

---

## ⚙️ 系统管理模块

### FRD-009：配置参数管理功能

#### 功能描述
管理系统运行参数、业务规则配置、功能开关等。

#### 配置参数分类
```typescript
interface SystemConfig {
  // 积分相关配置
  pointsConfig: {
    defaultRatio: number        // 默认积分比例
    maxDailyPoints: number      // 每日最大积分
    expirationDays: number      // 积分有效期
    awardDelay: number          // 发放延迟（毫秒）
  },
  
  // 支付相关配置
  paymentConfig: {
    orderTimeout: number        // 订单超时时间（秒）
    maxAmount: number          // 最大支付金额（分）
    minAmount: number          // 最小支付金额（分）
    retryAttempts: number      // 重试次数
  },
  
  // 系统配置
  systemConfig: {
    maintenanceMode: boolean   // 维护模式
    enabledFeatures: string[]  // 启用功能列表
    rateLimit: number         // 接口限流
    logLevel: string          // 日志级别
  }
}
```

### FRD-010：监控告警管理功能

#### 功能描述
监控系统运行状态，设置告警规则，及时发现和处理异常。

#### 监控指标
```typescript
interface MonitoringMetrics {
  // 业务指标
  businessMetrics: {
    paymentSuccessRate: number  // 支付成功率
    pointsAwardRate: number     // 积分发放成功率
    userActiveCount: number     // 活跃用户数
    dailyTransactionAmount: number // 日交易金额
  },
  
  // 技术指标
  technicalMetrics: {
    responseTime: number        // 接口响应时间
    errorRate: number          // 错误率
    cpuUsage: number           // CPU使用率
    memoryUsage: number        // 内存使用率
    diskUsage: number          // 磁盘使用率
  },
  
  // 告警规则
  alertRules: {
    criticalThreshold: number  // 严重告警阈值
    warningThreshold: number   // 警告告警阈值
    alertChannels: string[]    // 告警通知渠道
    escalationRules: object    // 升级规则
  }
}
```

---

## 🔧 接口规范

### API接口设计原则

#### RESTful设计规范
```typescript
// URL设计规范
const APIEndpoints = {
  // 用户相关
  'POST /api/v1/users/register': '用户注册',
  'POST /api/v1/users/login': '用户登录',
  'GET /api/v1/users/:id': '获取用户信息',
  'PUT /api/v1/users/:id': '更新用户信息',
  
  // 支付相关
  'POST /api/v1/payments': '创建支付订单',
  'GET /api/v1/payments/:id': '查询支付状态',
  'POST /api/v1/payments/:id/callback': '支付回调',
  
  // 积分相关
  'GET /api/v1/points/balance/:userId': '查询积分余额',
  'GET /api/v1/points/history/:userId': '查询积分明细',
  'POST /api/v1/points/award': '发放积分',
  
  // 商户相关
  'GET /api/v1/merchants/:id': '获取商户信息',
  'POST /api/v1/merchants/:id/qrcodes': '生成收款码',
  'GET /api/v1/merchants/:id/transactions': '查询交易流水'
}
```

#### 统一响应格式
```typescript
interface APIResponse<T> {
  success: boolean
  code: string
  message: string
  data?: T
  timestamp: number
  requestId: string
}

// 成功响应示例
{
  "success": true,
  "code": "SUCCESS",
  "message": "操作成功",
  "data": {...},
  "timestamp": 1640995200000,
  "requestId": "req_1234567890"
}

// 错误响应示例
{
  "success": false,
  "code": "PAYMENT_FAILED",
  "message": "支付失败",
  "timestamp": 1640995200000,
  "requestId": "req_1234567890"
}
```

---

## ✅ 验收标准

### 功能验收标准

#### 用户注册登录
- [ ] 微信授权登录成功率 ≥ 95%
- [ ] 用户信息获取准确率 100%
- [ ] 登录响应时间 ≤ 2秒
- [ ] 重复登录处理正确

#### 支付功能
- [ ] 二维码识别成功率 ≥ 98%
- [ ] 支付成功率 ≥ 99%
- [ ] 支付响应时间 ≤ 500ms
- [ ] 支付异常处理完整

#### 积分功能
- [ ] 积分发放准确率 100%
- [ ] 积分发放及时性 ≤ 3秒
- [ ] 积分查询准确性 100%
- [ ] 积分明细完整性 100%

### 性能验收标准
- [ ] 系统并发用户数 ≥ 1000
- [ ] 接口响应时间 ≤ 200ms
- [ ] 系统可用性 ≥ 99.9%
- [ ] 数据一致性 100%

### 安全验收标准
- [ ] 数据传输加密 100%
- [ ] 用户隐私保护合规
- [ ] 接口安全验证通过
- [ ] 支付安全检查通过

---

**文档状态**：待开发评审  
**下一步行动**：接口详细设计  
**责任人**：需求分析师  
**评审时间**：待定
