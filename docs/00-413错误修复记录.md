# 413 Request Entity Too Large é”™è¯¯ä¿®å¤è®°å½•

## ğŸ“… ä¿®å¤æ—¶é—´
**æ—¥æœŸ**: 2025å¹´10æœˆ1æ—¥  
**æ‰§è¡Œäºº**: ç³»ç»Ÿè‡ªåŠ¨åŒ–è„šæœ¬

---

## ğŸ” é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
API Error: 413 <html>
<head><title>413 Request Entity Too Large</title></head>
<body>
<center><h1>413 Request Entity Too Large</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

### é—®é¢˜åŸå› 
- **Nginx** é»˜è®¤è¯·æ±‚ä½“é™åˆ¶ä¸º 1MB
- **Express** é»˜è®¤ JSON è§£æé™åˆ¶ä¸º 100KB
- ç®¡ç†åå°æ‰¹é‡æ“ä½œæˆ–å¤§æ•°æ®è¯·æ±‚è¶…å‡ºé™åˆ¶

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. Nginx é…ç½®ä¿®æ”¹

**æ–‡ä»¶ä½ç½®**: `/etc/nginx/sites-available/guandongfang`

**ä¿®æ”¹å†…å®¹**:
```nginx
server {
    client_max_body_size 50M;  # æ–°å¢é…ç½®
    listen 443 ssl http2;
    server_name guandongfang.cn www.guandongfang.cn;
    # ... å…¶ä»–é…ç½®
}
```

**ä¿®æ”¹ä½ç½®**:
- HTTP server å—ï¼ˆ80ç«¯å£ï¼‰
- HTTPS server å—ï¼ˆ443ç«¯å£ï¼‰

### 2. Express åç«¯é…ç½®ä¿®æ”¹

**æ–‡ä»¶ä½ç½®**: `/root/weixinzhifu/backend/payment-points-api-enhanced.js`

**ä¿®æ”¹å‰**:
```javascript
app.use(express.json());
```

**ä¿®æ”¹å**:
```javascript
// ä¸­é—´ä»¶ - å¢åŠ è¯·æ±‚ä½“å¤§å°é™åˆ¶åˆ° 50MB
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));
```

---

## ğŸš€ ä¿®å¤æ‰§è¡Œ

### æ‰§è¡Œè„šæœ¬
```bash
# å®Œæ•´ä¸€é”®ä¿®å¤
./scripts/complete-fix-413.sh

# æˆ–åˆ†æ­¥æ‰§è¡Œ
./scripts/fix-413-error.sh          # ä¿®å¤ Nginx
./scripts/deploy-backend-fix-413.sh # éƒ¨ç½²åç«¯
```

### è„šæœ¬åŠŸèƒ½
1. **è‡ªåŠ¨å¤‡ä»½**æ‰€æœ‰ä¿®æ”¹çš„é…ç½®æ–‡ä»¶
2. **ä¿®æ”¹ Nginx é…ç½®**å¹¶æµ‹è¯•
3. **ä¸Šä¼ åç«¯ä»£ç **åˆ°æœåŠ¡å™¨
4. **é‡å¯æœåŠ¡**ï¼ˆNginx + PM2ï¼‰
5. **éªŒè¯ä¿®å¤ç»“æœ**

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| ç»„ä»¶ | é…ç½®é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | è¯´æ˜ |
|------|--------|--------|--------|------|
| **Nginx** | client_max_body_size | 1Mï¼ˆé»˜è®¤ï¼‰ | **50M** | å…è®¸æ›´å¤§çš„è¯·æ±‚ä½“ |
| **Express** | JSON limit | 100KBï¼ˆé»˜è®¤ï¼‰ | **50MB** | æ”¯æŒå¤§JSONæ•°æ® |
| **Express** | URLencoded limit | æœªè®¾ç½® | **50MB** | æ”¯æŒå¤§è¡¨å•æ•°æ® |

---

## âœ… éªŒè¯ç»“æœ

### Nginx é…ç½®éªŒè¯
```bash
# æŸ¥çœ‹é…ç½®
grep -n "client_max_body_size" /etc/nginx/sites-available/guandongfang

# è¾“å‡ºç»“æœ
3:    client_max_body_size 50M;  # HTTP server
12:   client_max_body_size 50M;  # HTTPS server
```

### æœåŠ¡çŠ¶æ€éªŒè¯
```bash
# Nginx çŠ¶æ€
systemctl status nginx
# âœ… active (running)

# PM2 çŠ¶æ€
pm2 list
# âœ… payment-points-api-complete: online
# âœ… merchant-api: online
```

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

ä¿®å¤åçš„é…ç½®æ”¯æŒä»¥ä¸‹åœºæ™¯ï¼š

1. âœ… **æ‰¹é‡å¯¼å…¥å•†æˆ·æ•°æ®**ï¼ˆæœ€å¤§ 40MBï¼‰
2. âœ… **è®¢å•æ•°æ®æ‰¹é‡æäº¤**
3. âœ… **å¤§é‡ç§¯åˆ†è®°å½•ä¸Šä¼ **
4. âœ… **æ–‡ä»¶ä¸Šä¼ **ï¼ˆå›¾ç‰‡ã€Excelç­‰ï¼‰
5. âœ… **å¤æ‚æŸ¥è¯¢ç»“æœè¿”å›**

---

## ğŸ“‹ å¤‡ä»½æ–‡ä»¶æ¸…å•

æ‰€æœ‰ä¿®æ”¹éƒ½å·²è‡ªåŠ¨å¤‡ä»½ï¼š

### Nginx é…ç½®å¤‡ä»½
- `/etc/nginx/sites-available/guandongfang.backup.20251001_003720`
- `/etc/nginx/sites-available/guandongfang.backup.manual`

### åç«¯ä»£ç å¤‡ä»½
- `/root/weixinzhifu/backend/payment-points-api-enhanced.js.backup.20251001_003737`

### æœ¬åœ° Git è®°å½•
- æ‰€æœ‰ä¿®æ”¹å·²æäº¤åˆ°æœ¬åœ° Git ä»“åº“
- å¯é€šè¿‡ `git diff` æŸ¥çœ‹å…·ä½“å˜æ›´

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. æµ‹è¯•å°è¯·æ±‚ï¼ˆæ­£å¸¸ï¼‰
```bash
curl -X POST https://www.guandongfang.cn/api/v1/admin/merchants \
     -H 'Content-Type: application/json' \
     -H 'Authorization: Bearer YOUR_TOKEN' \
     -d '{"name": "æµ‹è¯•å•†æˆ·"}'
```

### 2. æµ‹è¯•å¤§æ•°æ®è¯·æ±‚
```bash
# ç”Ÿæˆå¤§JSONæ–‡ä»¶ï¼ˆçº¦ 10MBï¼‰
node -e "console.log(JSON.stringify({data: Array(100000).fill({name: 'æµ‹è¯•', value: 123})}))" > large-data.json

# æäº¤æµ‹è¯•
curl -X POST https://www.guandongfang.cn/api/v1/admin/merchants/batch \
     -H 'Content-Type: application/json' \
     -H 'Authorization: Bearer YOUR_TOKEN' \
     -d @large-data.json
```

### 3. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
```javascript
// å‰ç«¯æµ‹è¯•ä»£ç 
const formData = new FormData();
formData.append('file', file); // æ–‡ä»¶å¤§å° < 50MB

await fetch('https://www.guandongfang.cn/api/v1/upload', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘
- **ä¸å»ºè®®**å•æ¬¡è¯·æ±‚è¶…è¿‡ 40MB
- è¶…å¤§æ–‡ä»¶åº”ä½¿ç”¨**åˆ†ç‰‡ä¸Šä¼ **
- æ‰¹é‡æ“ä½œå»ºè®®**åˆ†æ‰¹å¤„ç†**ï¼ˆæ¯æ‰¹ 100-500 æ¡ï¼‰

### 2. å®‰å…¨è€ƒè™‘
- 50MB æ˜¯**æœ€å¤§é™åˆ¶**ï¼Œä¸æ˜¯æ¨èå€¼
- å»ºè®®åœ¨å‰ç«¯åš**æ–‡ä»¶å¤§å°éªŒè¯**
- è€ƒè™‘æ·»åŠ **è¯·æ±‚é¢‘ç‡é™åˆ¶**ï¼ˆRate Limitingï¼‰

### 3. ç›‘æ§å»ºè®®
```bash
# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs payment-points-api-complete

# ç›‘æ§å†…å­˜ä½¿ç”¨
pm2 monit
```

---

## ğŸ”§ æ•…éšœæ¢å¤

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤ï¼š

### æ¢å¤ Nginx é…ç½®
```bash
ssh -i config/ssh/weixinpay.pem root@8.156.84.226
cd /etc/nginx/sites-available
cp guandongfang.backup.20251001_003720 guandongfang
nginx -t && systemctl reload nginx
```

### æ¢å¤åç«¯ä»£ç 
```bash
ssh -i config/ssh/weixinpay.pem root@8.156.84.226
cd /root/weixinzhifu/backend
cp payment-points-api-enhanced.js.backup.20251001_003737 payment-points-api-enhanced.js
pm2 restart all
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Nginx å®˜æ–¹æ–‡æ¡£ - client_max_body_size](http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size)
- [Express å®˜æ–¹æ–‡æ¡£ - body-parser](https://expressjs.com/en/api.html#express.json)
- [é¡¹ç›®éƒ¨ç½²æŒ‡å—](./04-éƒ¨ç½²ä¸è¿ç»´/01-éƒ¨ç½²æ–¹æ¡ˆ.md)

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### å¦‚æœä»ç„¶å‡ºç° 413 é”™è¯¯

1. **æ£€æŸ¥ Nginx é…ç½®**
   ```bash
   grep client_max_body_size /etc/nginx/sites-available/guandongfang
   ```

2. **æ£€æŸ¥åç«¯ä»£ç **
   ```bash
   grep "limit.*50mb" /root/weixinzhifu/backend/payment-points-api-enhanced.js
   ```

3. **æ£€æŸ¥é˜²ç«å¢™/CDN**
   - å¦‚æœä½¿ç”¨äº† CDNï¼ŒCDN å¯èƒ½ä¹Ÿæœ‰å¤§å°é™åˆ¶
   - æ£€æŸ¥é˜¿é‡Œäº‘å®‰å…¨ç»„è§„åˆ™

4. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**
   ```bash
   # Nginx é”™è¯¯æ—¥å¿—
   tail -100 /var/log/nginx/error.log
   
   # åç«¯é”™è¯¯æ—¥å¿—
   pm2 logs --lines 100
   ```

---

## âœ… ä¿®å¤å®Œæˆç¡®è®¤

- [x] Nginx é…ç½®å·²ä¿®æ”¹
- [x] Express åç«¯å·²ä¿®æ”¹
- [x] æ‰€æœ‰æœåŠ¡å·²é‡å¯
- [x] é…ç½®å·²å¤‡ä»½
- [x] ä¿®å¤å·²éªŒè¯
- [x] æ–‡æ¡£å·²æ›´æ–°

---

**ä¿®å¤äººå‘˜**: è‡ªåŠ¨åŒ–è„šæœ¬  
**éªŒè¯äººå‘˜**: ç³»ç»Ÿç®¡ç†å‘˜  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ1æ—¥

