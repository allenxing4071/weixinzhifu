# 系统架构设计文档

## 📖 文档信息
- **文档版本**：V1.0
- **创建日期**：2024年12月
- **架构师**：[姓名]
- **技术负责人**：[姓名]
- **评审状态**：待评审

---

## 🏗 整体架构设计

### 架构原则
1. **高可用性**：系统可用性≥99.9%
2. **高并发**：支持1000+并发用户
3. **数据一致性**：支付和积分数据强一致性
4. **安全性**：多层安全防护
5. **可扩展性**：支持业务快速扩展
6. **可维护性**：代码结构清晰，便于维护
7. **微信合规性**：严格遵循微信小程序审核规范
8. **代码包优化**：主包≤2MB，总包≤20MB

### 技术选型

#### 前端技术栈（微信小程序约束优化）
```
微信小程序
├── 开发框架：微信原生小程序
├── UI组件库：Vant Weapp（按需引入）
├── 状态管理：Zustand（轻量级，5KB）
├── 网络请求：wx.request 封装
├── 工具库：
│   ├── 时间处理：dayjs（2KB，替代moment.js）
│   ├── 工具函数：自定义utils（避免lodash全量引入）
│   └── 数据处理：原生JS（减少依赖）
├── 构建工具：
│   ├── 微信开发者工具
│   ├── Webpack（代码分割和压缩）
│   └── Terser（JS压缩，删除console）
└── 分包策略：
    ├── 主包：≤1.5MB（核心功能）
    ├── 支付分包：≤1.8MB
    ├── 积分分包：≤1.8MB
    └── 商户分包：≤1.8MB
```

#### 后端技术栈
```
Node.js 生态
├── 开发语言：TypeScript
├── Web框架：Express.js
├── ORM框架：Sequelize
├── 参数验证：Joi
├── 日志记录：Winston
├── 定时任务：node-cron
└── 进程管理：PM2
```

#### 数据存储
```
数据层
├── 关系数据库：MySQL 8.0
├── 缓存数据库：Redis 6.0
├── 文件存储：腾讯云COS
└── 搜索引擎：Elasticsearch（可选）
```

#### 基础设施
```
云服务
├── 云服务商：腾讯云
├── 容器化：Docker
├── 容器编排：Kubernetes
├── 负载均衡：腾讯云CLB
├── CDN：腾讯云CDN
├── 监控：Prometheus + Grafana
└── 日志：ELK Stack
```

---

## 🌐 系统架构图

### 总体架构图
```
                     用户端小程序
                          |
                     商户端小程序
                          |
                     管理后台Web
                          |
                 ┌─────────────────────┐
                 │    负载均衡(CLB)      │
                 └─────────────────────┘
                          |
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌─────────┐      ┌─────────┐      ┌─────────┐
   │应用服务器1│      │应用服务器2│      │应用服务器N│
   └─────────┘      └─────────┘      └─────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          |
                 ┌─────────────────────┐
                 │     API 网关        │
                 └─────────────────────┘
                          |
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌─────────┐      ┌─────────┐      ┌─────────┐
   │用户服务   │      │支付服务   │      │积分服务   │
   └─────────┘      └─────────┘      └─────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          |
                 ┌─────────────────────┐
                 │      数据层         │
                 │  MySQL + Redis      │
                 └─────────────────────┘
```

### 微服务架构图
```
┌─────────────────────────────────────────────────────────┐
│                     API Gateway                        │
│              (路由、鉴权、限流、监控)                      │
└─────────────────────────────────────────────────────────┘
                              |
                    ┌─────────┼─────────┐
                    │         │         │
            ┌───────────┐ ┌───────────┐ ┌───────────┐
            │ 用户服务   │ │ 支付服务   │ │ 积分服务   │
            │           │ │           │ │           │
            │- 用户注册  │ │- 微信支付  │ │- 积分发放  │
            │- 用户登录  │ │- 支付回调  │ │- 积分查询  │
            │- 用户信息  │ │- 订单管理  │ │- 积分统计  │
            └───────────┘ └───────────┘ └───────────┘
                    │         │         │
            ┌───────────┐ ┌───────────┐ ┌───────────┐
            │ 商户服务   │ │ 通知服务   │ │ 统计服务   │
            │           │ │           │ │           │
            │- 商户管理  │ │- 短信通知  │ │- 数据统计  │
            │- 收款码    │ │- 模板消息  │ │- 报表生成  │
            │- 权限控制  │ │- 推送消息  │ │- 数据分析  │
            └───────────┘ └───────────┘ └───────────┘
```

---

## 🎯 核心服务设计

### 1. 用户服务 (User Service)

#### 服务职责
- 用户注册、登录、信息管理
- 用户权限验证
- 用户状态管理
- 用户关系管理

#### 核心接口
```typescript
interface UserService {
  // 用户注册
  register(userInfo: RegisterDto): Promise<UserEntity>
  
  // 微信授权登录
  wechatLogin(code: string): Promise<LoginResult>
  
  // 获取用户信息
  getUserInfo(userId: string): Promise<UserEntity>
  
  // 更新用户信息
  updateUserInfo(userId: string, userInfo: UpdateUserDto): Promise<boolean>
  
  // 用户状态管理
  setUserStatus(userId: string, status: UserStatus): Promise<boolean>
}
```

#### 数据模型
```typescript
interface UserEntity {
  id: string                    // 用户ID
  wechatId: string             // 微信openid
  nickname: string             // 用户昵称
  avatar: string               // 头像URL
  phone?: string               // 手机号
  status: UserStatus           // 用户状态
  createdAt: Date              // 创建时间
  updatedAt: Date              // 更新时间
}
```

### 2. 支付服务 (Payment Service)

#### 服务职责
- 微信支付接口对接
- 支付订单管理
- 支付回调处理
- 支付数据统计

#### 核心接口
```typescript
interface PaymentService {
  // 创建支付订单
  createPayment(paymentInfo: CreatePaymentDto): Promise<PaymentResult>
  
  // 处理支付回调
  handlePaymentCallback(callbackData: PaymentCallbackDto): Promise<boolean>
  
  // 查询支付状态
  queryPaymentStatus(orderId: string): Promise<PaymentStatus>
  
  // 申请退款
  refund(orderId: string, refundAmount: number): Promise<RefundResult>
}
```

#### 支付流程设计
```
1. 用户扫码 → 获取商户信息
2. 确认支付 → 创建支付订单
3. 调用微信支付 → 获取支付参数
4. 用户支付 → 微信支付处理
5. 支付成功 → 接收微信回调
6. 更新订单状态 → 触发积分发放
7. 通知用户 → 支付完成
```

### 3. 积分服务 (Points Service)

#### 服务职责
- 积分发放和扣减
- 积分查询和统计
- 积分规则管理
- 积分过期处理

#### 核心接口
```typescript
interface PointsService {
  // 发放积分
  awardPoints(userId: string, amount: number, source: PointsSource): Promise<boolean>
  
  // 扣减积分
  deductPoints(userId: string, amount: number, reason: string): Promise<boolean>
  
  // 查询积分余额
  getPointsBalance(userId: string): Promise<number>
  
  // 积分明细查询
  getPointsHistory(userId: string, pagination: Pagination): Promise<PointsHistory[]>
  
  // 积分统计
  getPointsStatistics(userId: string): Promise<PointsStatistics>
}
```

#### 积分发放规则
```typescript
interface PointsRule {
  ratio: number                // 积分比例 (1:1)
  minAmount: number           // 最小发放金额
  maxAmount: number           // 最大发放金额
  dailyLimit: number          // 每日发放上限
  totalLimit: number          // 总发放上限
  expireDays: number          // 积分有效期(天)
}
```

### 4. 商户服务 (Merchant Service)

#### 服务职责
- 商户信息管理
- 收款码生成管理
- 商户权限控制
- 商户数据统计

#### 核心接口
```typescript
interface MerchantService {
  // 商户注册
  registerMerchant(merchantInfo: MerchantRegisterDto): Promise<MerchantEntity>
  
  // 商户信息查询
  getMerchantInfo(merchantId: string): Promise<MerchantEntity>
  
  // 生成收款码
  generatePaymentCode(merchantId: string, codeInfo: PaymentCodeDto): Promise<string>
  
  // 商户交易统计
  getMerchantStatistics(merchantId: string, dateRange: DateRange): Promise<MerchantStats>
}
```

---

## 🗄 数据库设计

### 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  wechat_id VARCHAR(64) UNIQUE NOT NULL,
  nickname VARCHAR(100),
  avatar VARCHAR(500),
  phone VARCHAR(20),
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_wechat_id (wechat_id),
  INDEX idx_phone (phone)
);
```

#### 商户表 (merchants)
```sql
CREATE TABLE merchants (
  id VARCHAR(36) PRIMARY KEY,
  merchant_name VARCHAR(200) NOT NULL,
  contact_name VARCHAR(100),
  contact_phone VARCHAR(20),
  business_license VARCHAR(100),
  address VARCHAR(500),
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_merchant_name (merchant_name),
  INDEX idx_contact_phone (contact_phone)
);
```

#### 支付订单表 (payment_orders)
```sql
CREATE TABLE payment_orders (
  id VARCHAR(36) PRIMARY KEY,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  merchant_id VARCHAR(36) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  status TINYINT DEFAULT 0,
  payment_method VARCHAR(20) DEFAULT 'wechat',
  wechat_transaction_id VARCHAR(64),
  paid_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_merchant_id (merchant_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);
```

#### 积分记录表 (points_records)
```sql
CREATE TABLE points_records (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  order_id VARCHAR(36),
  points_change INT NOT NULL,
  points_balance INT NOT NULL,
  change_type TINYINT NOT NULL,
  source VARCHAR(50),
  description VARCHAR(200),
  expires_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_order_id (order_id),
  INDEX idx_change_type (change_type),
  INDEX idx_expires_at (expires_at),
  INDEX idx_created_at (created_at)
);
```

#### 用户积分汇总表 (user_points)
```sql
CREATE TABLE user_points (
  user_id VARCHAR(36) PRIMARY KEY,
  total_points INT DEFAULT 0,
  available_points INT DEFAULT 0,
  used_points INT DEFAULT 0,
  expired_points INT DEFAULT 0,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_available_points (available_points)
);
```

### 数据库设计原则

#### 1. 分表策略
- **按时间分表**：积分记录表按月分表
- **按用户分表**：高并发时可考虑用户表分表
- **读写分离**：主库写入，从库读取

#### 2. 索引设计
- **主键索引**：所有表使用UUID主键
- **唯一索引**：订单号、微信ID等唯一字段
- **组合索引**：常用查询字段组合
- **时间索引**：按时间范围查询的字段

#### 3. 数据一致性
- **事务控制**：支付和积分发放使用事务
- **乐观锁**：积分余额更新使用版本号控制
- **补偿机制**：异常情况下的数据修复

---

## 🚀 缓存架构设计

### Redis 缓存策略

#### 缓存层次
```
L1 缓存：应用内存缓存 (Node.js Memory)
├── 用户Session信息
├── 商户基础信息
└── 积分规则配置

L2 缓存：Redis分布式缓存
├── 用户积分余额
├── 支付订单状态
├── 商户交易统计
└── 热点数据缓存
```

#### 缓存键设计
```typescript
// 缓存键规范
const CacheKeys = {
  // 用户相关
  USER_INFO: 'user:info:{userId}',
  USER_POINTS: 'user:points:{userId}',
  USER_SESSION: 'user:session:{sessionId}',
  
  // 支付相关
  PAYMENT_ORDER: 'payment:order:{orderId}',
  PAYMENT_STATUS: 'payment:status:{orderId}',
  
  // 商户相关
  MERCHANT_INFO: 'merchant:info:{merchantId}',
  MERCHANT_STATS: 'merchant:stats:{merchantId}:{date}',
  
  // 业务相关
  POINTS_RULES: 'points:rules',
  SYSTEM_CONFIG: 'system:config',
}
```

#### 缓存更新策略
- **Cache Aside Pattern**：应用负责缓存维护
- **Write Through**：写入时同步更新缓存
- **TTL设置**：不同数据设置不同过期时间
- **缓存预热**：系统启动时预加载热点数据

---

## 🔒 安全架构设计

### 1. 接口安全

#### API鉴权机制
```typescript
// JWT Token 结构
interface JWTPayload {
  userId: string
  merchantId?: string
  role: UserRole
  permissions: string[]
  iat: number
  exp: number
}

// 请求签名验证
interface RequestSignature {
  timestamp: number
  nonce: string
  signature: string  // MD5(timestamp + nonce + secretKey)
}
```

#### 接口限流
```typescript
// 限流规则配置
const RateLimitRules = {
  // 支付接口：每用户每分钟最多5次
  '/api/payment/create': {
    windowMs: 60 * 1000,
    max: 5,
    keyGenerator: (req) => req.user.id
  },
  
  // 查询接口：每用户每分钟最多100次
  '/api/points/query': {
    windowMs: 60 * 1000,
    max: 100,
    keyGenerator: (req) => req.user.id
  }
}
```

### 2. 数据安全

#### 敏感数据加密
```typescript
// 数据加密配置
const EncryptionConfig = {
  // 用户手机号加密
  phone: {
    algorithm: 'AES-256-GCM',
    keyRotation: 90 // 90天轮换
  },
  
  // 支付密钥加密
  paymentKey: {
    algorithm: 'RSA-2048',
    keyRotation: 365 // 一年轮换
  }
}
```

#### 数据脱敏
```typescript
// 日志脱敏规则
const DataMaskingRules = {
  phone: (phone: string) => phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'),
  idCard: (idCard: string) => idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2'),
  bankCard: (card: string) => card.replace(/(\d{4})\d+(\d{4})/, '$1****$2')
}
```

### 3. 业务安全

#### 风控规则
```typescript
// 风控规则引擎
interface RiskRule {
  name: string
  condition: (context: RiskContext) => boolean
  action: RiskAction
  priority: number
}

const PaymentRiskRules: RiskRule[] = [
  {
    name: '单用户高频支付',
    condition: (ctx) => ctx.userPaymentCount > 10, // 1分钟内超过10次
    action: RiskAction.BLOCK,
    priority: 1
  },
  {
    name: '异常IP支付',
    condition: (ctx) => ctx.isUnknownIP,
    action: RiskAction.VERIFY,
    priority: 2
  }
]
```

---

## 📊 监控和日志

### 1. 应用监控

#### 监控指标
```typescript
// 业务监控指标
const BusinessMetrics = {
  // 支付相关
  paymentSuccessRate: '支付成功率',
  paymentResponseTime: '支付响应时间',
  dailyPaymentAmount: '日支付金额',
  
  // 积分相关
  pointsAwardSuccessRate: '积分发放成功率',
  pointsAwardDelay: '积分发放延迟',
  dailyPointsAmount: '日积分发放量',
  
  // 用户相关
  userRegistrationRate: '用户注册率',
  userRetentionRate: '用户留存率',
  userActiveRate: '用户活跃率'
}

// 技术监控指标
const TechnicalMetrics = {
  responseTime: '接口响应时间',
  errorRate: '错误率',
  throughput: '吞吐量',
  concurrency: '并发数',
  cpuUsage: 'CPU使用率',
  memoryUsage: '内存使用率',
  diskUsage: '磁盘使用率'
}
```

#### 告警规则
```typescript
const AlertRules = [
  {
    metric: 'paymentSuccessRate',
    condition: '< 95%',
    level: 'Critical',
    channels: ['钉钉', '短信', '邮件']
  },
  {
    metric: 'responseTime',
    condition: '> 500ms',
    level: 'Warning',
    channels: ['钉钉']
  }
]
```

### 2. 日志系统

#### 日志分类
```typescript
// 日志类型定义
enum LogLevel {
  ERROR = 'error',
  WARN = 'warn', 
  INFO = 'info',
  DEBUG = 'debug'
}

enum LogCategory {
  BUSINESS = 'business',  // 业务日志
  SECURITY = 'security',  // 安全日志
  SYSTEM = 'system',      // 系统日志
  AUDIT = 'audit'         // 审计日志
}
```

#### 日志格式
```typescript
interface LogEntry {
  timestamp: string
  level: LogLevel
  category: LogCategory
  traceId: string
  userId?: string
  merchantId?: string
  action: string
  message: string
  data?: any
  error?: Error
}
```

---

## 🚀 部署架构

### 1. 容器化部署

#### Docker 配置
```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

#### Kubernetes 配置
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: points-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: points-app
  template:
    metadata:
      labels:
        app: points-app
    spec:
      containers:
      - name: points-app
        image: points-app:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
```

### 2. 环境规划

#### 环境划分
```
开发环境 (DEV)
├── 用途：开发调试
├── 配置：单实例部署
├── 数据：测试数据
└── 域名：dev-points.example.com

测试环境 (TEST)
├── 用途：功能测试
├── 配置：双实例部署
├── 数据：模拟数据
└── 域名：test-points.example.com

预生产环境 (STAGING)
├── 用途：上线前验证
├── 配置：生产环境配置
├── 数据：脱敏生产数据
└── 域名：staging-points.example.com

生产环境 (PROD)
├── 用途：正式服务
├── 配置：高可用部署
├── 数据：真实数据
└── 域名：points.example.com
```

---

## 📈 性能优化

### 1. 应用层优化

#### 代码优化
- **异步处理**：使用 async/await 和 Promise
- **内存管理**：避免内存泄漏，及时释放资源
- **算法优化**：选择合适的数据结构和算法
- **缓存策略**：合理使用缓存减少计算

#### 数据库优化
- **索引优化**：合理创建和使用索引
- **查询优化**：避免N+1问题，使用连接查询
- **分页优化**：使用游标分页替代OFFSET
- **连接池**：合理配置数据库连接池

### 2. 基础设施优化

#### CDN 配置
```typescript
const CDNConfig = {
  // 静态资源CDN
  staticFiles: {
    domain: 'cdn.example.com',
    cache: '7d',
    gzip: true
  },
  
  // 图片CDN
  images: {
    domain: 'img.example.com',
    cache: '30d',
    webp: true,
    resize: true
  }
}
```

#### 负载均衡
```nginx
# nginx 配置
upstream points_backend {
    server 10.0.1.10:3000 weight=3;
    server 10.0.1.11:3000 weight=2;
    server 10.0.1.12:3000 weight=1;
}

server {
    listen 80;
    server_name points.example.com;
    
    location / {
        proxy_pass http://points_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 🔮 扩展性设计

### 1. 微服务演进

#### 服务拆分策略
```
单体应用 → 服务化 → 微服务化

Phase 1: 单体应用
├── 快速开发上线
├── 功能验证
└── 积累业务经验

Phase 2: 服务化
├── 核心服务分离
├── 数据库分库
└── 接口标准化

Phase 3: 微服务化
├── 服务彻底分离
├── 独立部署
└── 服务治理
```

### 2. 数据库扩展

#### 分库分表策略
```typescript
// 分表策略
const ShardingStrategy = {
  // 按用户ID分表
  userPoints: {
    shardKey: 'user_id',
    shardCount: 16,
    algorithm: 'hash'
  },
  
  // 按时间分表
  pointsRecords: {
    shardKey: 'created_at',
    shardType: 'monthly',
    retentionMonths: 12
  }
}
```

### 3. 业务扩展

#### 多租户支持
```typescript
// 多租户数据隔离
interface TenantContext {
  tenantId: string
  tenantType: TenantType
  permissions: Permission[]
  restrictions: Restriction[]
}

// 数据访问控制
class DataAccessControl {
  filterByTenant(query: Query, tenant: TenantContext): Query {
    return query.where('tenant_id', tenant.tenantId)
  }
}
```

---

## 📝 总结

### 架构优势
1. **高可用**：多层容错和故障恢复机制
2. **高性能**：缓存、CDN、负载均衡等优化
3. **高安全**：多层安全防护体系
4. **易扩展**：微服务架构支持业务快速扩展
5. **易维护**：清晰的分层架构和代码规范

### 技术债务
1. **监控完善**：需要进一步完善监控体系
2. **自动化**：提升自动化测试和部署水平
3. **文档维护**：保持技术文档与代码同步
4. **性能调优**：持续进行性能监控和优化

### 后续规划
1. **第二期架构**：支持分账和红包功能
2. **大数据平台**：构建数据仓库和分析平台
3. **AI能力**：集成机器学习和智能推荐
4. **开放平台**：提供API和SDK给第三方

---

**文档状态**：待技术评审  
**下一步行动**：数据库详细设计  
**责任人**：架构师  
**评审时间**：待定
