# ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“– æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ
- **æ¶æ„å¸ˆ**ï¼š[å§“å]
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼š[å§“å]
- **è¯„å®¡çŠ¶æ€**ï¼šå¾…è¯„å®¡

---

## ğŸ— æ•´ä½“æ¶æ„è®¾è®¡

### æ¶æ„åŸåˆ™
1. **é«˜å¯ç”¨æ€§**ï¼šç³»ç»Ÿå¯ç”¨æ€§â‰¥99.9%
2. **é«˜å¹¶å‘**ï¼šæ”¯æŒ1000+å¹¶å‘ç”¨æˆ·
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ”¯ä»˜å’Œç§¯åˆ†æ•°æ®å¼ºä¸€è‡´æ€§
4. **å®‰å…¨æ€§**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤
5. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒä¸šåŠ¡å¿«é€Ÿæ‰©å±•
6. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤
7. **å¾®ä¿¡åˆè§„æ€§**ï¼šä¸¥æ ¼éµå¾ªå¾®ä¿¡å°ç¨‹åºå®¡æ ¸è§„èŒƒ
8. **ä»£ç åŒ…ä¼˜åŒ–**ï¼šä¸»åŒ…â‰¤2MBï¼Œæ€»åŒ…â‰¤20MB

### æŠ€æœ¯é€‰å‹

#### å‰ç«¯æŠ€æœ¯æ ˆï¼ˆå¾®ä¿¡å°ç¨‹åºçº¦æŸä¼˜åŒ–ï¼‰
```
å¾®ä¿¡å°ç¨‹åº
â”œâ”€â”€ å¼€å‘æ¡†æ¶ï¼šå¾®ä¿¡åŸç”Ÿå°ç¨‹åº
â”œâ”€â”€ UIç»„ä»¶åº“ï¼šVant Weappï¼ˆæŒ‰éœ€å¼•å…¥ï¼‰
â”œâ”€â”€ çŠ¶æ€ç®¡ç†ï¼šZustandï¼ˆè½»é‡çº§ï¼Œ5KBï¼‰
â”œâ”€â”€ ç½‘ç»œè¯·æ±‚ï¼šwx.request å°è£…
â”œâ”€â”€ å·¥å…·åº“ï¼š
â”‚   â”œâ”€â”€ æ—¶é—´å¤„ç†ï¼šdayjsï¼ˆ2KBï¼Œæ›¿ä»£moment.jsï¼‰
â”‚   â”œâ”€â”€ å·¥å…·å‡½æ•°ï¼šè‡ªå®šä¹‰utilsï¼ˆé¿å…lodashå…¨é‡å¼•å…¥ï¼‰
â”‚   â””â”€â”€ æ•°æ®å¤„ç†ï¼šåŸç”ŸJSï¼ˆå‡å°‘ä¾èµ–ï¼‰
â”œâ”€â”€ æ„å»ºå·¥å…·ï¼š
â”‚   â”œâ”€â”€ å¾®ä¿¡å¼€å‘è€…å·¥å…·
â”‚   â”œâ”€â”€ Webpackï¼ˆä»£ç åˆ†å‰²å’Œå‹ç¼©ï¼‰
â”‚   â””â”€â”€ Terserï¼ˆJSå‹ç¼©ï¼Œåˆ é™¤consoleï¼‰
â””â”€â”€ åˆ†åŒ…ç­–ç•¥ï¼š
    â”œâ”€â”€ ä¸»åŒ…ï¼šâ‰¤1.5MBï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    â”œâ”€â”€ æ”¯ä»˜åˆ†åŒ…ï¼šâ‰¤1.8MB
    â”œâ”€â”€ ç§¯åˆ†åˆ†åŒ…ï¼šâ‰¤1.8MB
    â””â”€â”€ å•†æˆ·åˆ†åŒ…ï¼šâ‰¤1.8MB
```

#### åç«¯æŠ€æœ¯æ ˆ
```
Node.js ç”Ÿæ€
â”œâ”€â”€ å¼€å‘è¯­è¨€ï¼šTypeScript
â”œâ”€â”€ Webæ¡†æ¶ï¼šExpress.js
â”œâ”€â”€ ORMæ¡†æ¶ï¼šSequelize
â”œâ”€â”€ å‚æ•°éªŒè¯ï¼šJoi
â”œâ”€â”€ æ—¥å¿—è®°å½•ï¼šWinston
â”œâ”€â”€ å®šæ—¶ä»»åŠ¡ï¼šnode-cron
â””â”€â”€ è¿›ç¨‹ç®¡ç†ï¼šPM2
```

#### æ•°æ®å­˜å‚¨
```
æ•°æ®å±‚
â”œâ”€â”€ å…³ç³»æ•°æ®åº“ï¼šMySQL 8.0
â”œâ”€â”€ ç¼“å­˜æ•°æ®åº“ï¼šRedis 6.0
â”œâ”€â”€ æ–‡ä»¶å­˜å‚¨ï¼šè…¾è®¯äº‘COS
â””â”€â”€ æœç´¢å¼•æ“ï¼šElasticsearchï¼ˆå¯é€‰ï¼‰
```

#### åŸºç¡€è®¾æ–½
```
äº‘æœåŠ¡
â”œâ”€â”€ äº‘æœåŠ¡å•†ï¼šè…¾è®¯äº‘
â”œâ”€â”€ å®¹å™¨åŒ–ï¼šDocker
â”œâ”€â”€ å®¹å™¨ç¼–æ’ï¼šKubernetes
â”œâ”€â”€ è´Ÿè½½å‡è¡¡ï¼šè…¾è®¯äº‘CLB
â”œâ”€â”€ CDNï¼šè…¾è®¯äº‘CDN
â”œâ”€â”€ ç›‘æ§ï¼šPrometheus + Grafana
â””â”€â”€ æ—¥å¿—ï¼šELK Stack
```

---

## ğŸŒ ç³»ç»Ÿæ¶æ„å›¾

### æ€»ä½“æ¶æ„å›¾
```
                     ç”¨æˆ·ç«¯å°ç¨‹åº
                          |
                     å•†æˆ·ç«¯å°ç¨‹åº
                          |
                     ç®¡ç†åå°Web
                          |
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚    è´Ÿè½½å‡è¡¡(CLB)      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚åº”ç”¨æœåŠ¡å™¨1â”‚      â”‚åº”ç”¨æœåŠ¡å™¨2â”‚      â”‚åº”ç”¨æœåŠ¡å™¨Nâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          |
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚     API ç½‘å…³        â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ç”¨æˆ·æœåŠ¡   â”‚      â”‚æ”¯ä»˜æœåŠ¡   â”‚      â”‚ç§¯åˆ†æœåŠ¡   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          |
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚      æ•°æ®å±‚         â”‚
                 â”‚  MySQL + Redis      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¾®æœåŠ¡æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API Gateway                        â”‚
â”‚              (è·¯ç”±ã€é‰´æƒã€é™æµã€ç›‘æ§)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              |
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ç”¨æˆ·æœåŠ¡   â”‚ â”‚ æ”¯ä»˜æœåŠ¡   â”‚ â”‚ ç§¯åˆ†æœåŠ¡   â”‚
            â”‚           â”‚ â”‚           â”‚ â”‚           â”‚
            â”‚- ç”¨æˆ·æ³¨å†Œ  â”‚ â”‚- å¾®ä¿¡æ”¯ä»˜  â”‚ â”‚- ç§¯åˆ†å‘æ”¾  â”‚
            â”‚- ç”¨æˆ·ç™»å½•  â”‚ â”‚- æ”¯ä»˜å›è°ƒ  â”‚ â”‚- ç§¯åˆ†æŸ¥è¯¢  â”‚
            â”‚- ç”¨æˆ·ä¿¡æ¯  â”‚ â”‚- è®¢å•ç®¡ç†  â”‚ â”‚- ç§¯åˆ†ç»Ÿè®¡  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚         â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ å•†æˆ·æœåŠ¡   â”‚ â”‚ é€šçŸ¥æœåŠ¡   â”‚ â”‚ ç»Ÿè®¡æœåŠ¡   â”‚
            â”‚           â”‚ â”‚           â”‚ â”‚           â”‚
            â”‚- å•†æˆ·ç®¡ç†  â”‚ â”‚- çŸ­ä¿¡é€šçŸ¥  â”‚ â”‚- æ•°æ®ç»Ÿè®¡  â”‚
            â”‚- æ”¶æ¬¾ç     â”‚ â”‚- æ¨¡æ¿æ¶ˆæ¯  â”‚ â”‚- æŠ¥è¡¨ç”Ÿæˆ  â”‚
            â”‚- æƒé™æ§åˆ¶  â”‚ â”‚- æ¨é€æ¶ˆæ¯  â”‚ â”‚- æ•°æ®åˆ†æ  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒæœåŠ¡è®¾è®¡

### 1. ç”¨æˆ·æœåŠ¡ (User Service)

#### æœåŠ¡èŒè´£
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†
- ç”¨æˆ·æƒé™éªŒè¯
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- ç”¨æˆ·å…³ç³»ç®¡ç†

#### æ ¸å¿ƒæ¥å£
```typescript
interface UserService {
  // ç”¨æˆ·æ³¨å†Œ
  register(userInfo: RegisterDto): Promise<UserEntity>
  
  // å¾®ä¿¡æˆæƒç™»å½•
  wechatLogin(code: string): Promise<LoginResult>
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo(userId: string): Promise<UserEntity>
  
  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  updateUserInfo(userId: string, userInfo: UpdateUserDto): Promise<boolean>
  
  // ç”¨æˆ·çŠ¶æ€ç®¡ç†
  setUserStatus(userId: string, status: UserStatus): Promise<boolean>
}
```

#### æ•°æ®æ¨¡å‹
```typescript
interface UserEntity {
  id: string                    // ç”¨æˆ·ID
  wechatId: string             // å¾®ä¿¡openid
  nickname: string             // ç”¨æˆ·æ˜µç§°
  avatar: string               // å¤´åƒURL
  phone?: string               // æ‰‹æœºå·
  status: UserStatus           // ç”¨æˆ·çŠ¶æ€
  createdAt: Date              // åˆ›å»ºæ—¶é—´
  updatedAt: Date              // æ›´æ–°æ—¶é—´
}
```

### 2. æ”¯ä»˜æœåŠ¡ (Payment Service)

#### æœåŠ¡èŒè´£
- å¾®ä¿¡æ”¯ä»˜æ¥å£å¯¹æ¥
- æ”¯ä»˜è®¢å•ç®¡ç†
- æ”¯ä»˜å›è°ƒå¤„ç†
- æ”¯ä»˜æ•°æ®ç»Ÿè®¡

#### æ ¸å¿ƒæ¥å£
```typescript
interface PaymentService {
  // åˆ›å»ºæ”¯ä»˜è®¢å•
  createPayment(paymentInfo: CreatePaymentDto): Promise<PaymentResult>
  
  // å¤„ç†æ”¯ä»˜å›è°ƒ
  handlePaymentCallback(callbackData: PaymentCallbackDto): Promise<boolean>
  
  // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
  queryPaymentStatus(orderId: string): Promise<PaymentStatus>
  
  // ç”³è¯·é€€æ¬¾
  refund(orderId: string, refundAmount: number): Promise<RefundResult>
}
```

#### æ”¯ä»˜æµç¨‹è®¾è®¡
```
1. ç”¨æˆ·æ‰«ç  â†’ è·å–å•†æˆ·ä¿¡æ¯
2. ç¡®è®¤æ”¯ä»˜ â†’ åˆ›å»ºæ”¯ä»˜è®¢å•
3. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ â†’ è·å–æ”¯ä»˜å‚æ•°
4. ç”¨æˆ·æ”¯ä»˜ â†’ å¾®ä¿¡æ”¯ä»˜å¤„ç†
5. æ”¯ä»˜æˆåŠŸ â†’ æ¥æ”¶å¾®ä¿¡å›è°ƒ
6. æ›´æ–°è®¢å•çŠ¶æ€ â†’ è§¦å‘ç§¯åˆ†å‘æ”¾
7. é€šçŸ¥ç”¨æˆ· â†’ æ”¯ä»˜å®Œæˆ
```

### 3. ç§¯åˆ†æœåŠ¡ (Points Service)

#### æœåŠ¡èŒè´£
- ç§¯åˆ†å‘æ”¾å’Œæ‰£å‡
- ç§¯åˆ†æŸ¥è¯¢å’Œç»Ÿè®¡
- ç§¯åˆ†è§„åˆ™ç®¡ç†
- ç§¯åˆ†è¿‡æœŸå¤„ç†

#### æ ¸å¿ƒæ¥å£
```typescript
interface PointsService {
  // å‘æ”¾ç§¯åˆ†
  awardPoints(userId: string, amount: number, source: PointsSource): Promise<boolean>
  
  // æ‰£å‡ç§¯åˆ†
  deductPoints(userId: string, amount: number, reason: string): Promise<boolean>
  
  // æŸ¥è¯¢ç§¯åˆ†ä½™é¢
  getPointsBalance(userId: string): Promise<number>
  
  // ç§¯åˆ†æ˜ç»†æŸ¥è¯¢
  getPointsHistory(userId: string, pagination: Pagination): Promise<PointsHistory[]>
  
  // ç§¯åˆ†ç»Ÿè®¡
  getPointsStatistics(userId: string): Promise<PointsStatistics>
}
```

#### ç§¯åˆ†å‘æ”¾è§„åˆ™
```typescript
interface PointsRule {
  ratio: number                // ç§¯åˆ†æ¯”ä¾‹ (1:1)
  minAmount: number           // æœ€å°å‘æ”¾é‡‘é¢
  maxAmount: number           // æœ€å¤§å‘æ”¾é‡‘é¢
  dailyLimit: number          // æ¯æ—¥å‘æ”¾ä¸Šé™
  totalLimit: number          // æ€»å‘æ”¾ä¸Šé™
  expireDays: number          // ç§¯åˆ†æœ‰æ•ˆæœŸ(å¤©)
}
```

### 4. å•†æˆ·æœåŠ¡ (Merchant Service)

#### æœåŠ¡èŒè´£
- å•†æˆ·ä¿¡æ¯ç®¡ç†
- æ”¶æ¬¾ç ç”Ÿæˆç®¡ç†
- å•†æˆ·æƒé™æ§åˆ¶
- å•†æˆ·æ•°æ®ç»Ÿè®¡

#### æ ¸å¿ƒæ¥å£
```typescript
interface MerchantService {
  // å•†æˆ·æ³¨å†Œ
  registerMerchant(merchantInfo: MerchantRegisterDto): Promise<MerchantEntity>
  
  // å•†æˆ·ä¿¡æ¯æŸ¥è¯¢
  getMerchantInfo(merchantId: string): Promise<MerchantEntity>
  
  // ç”Ÿæˆæ”¶æ¬¾ç 
  generatePaymentCode(merchantId: string, codeInfo: PaymentCodeDto): Promise<string>
  
  // å•†æˆ·äº¤æ˜“ç»Ÿè®¡
  getMerchantStatistics(merchantId: string, dateRange: DateRange): Promise<MerchantStats>
}
```

---

## ğŸ—„ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  wechat_id VARCHAR(64) UNIQUE NOT NULL,
  nickname VARCHAR(100),
  avatar VARCHAR(500),
  phone VARCHAR(20),
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_wechat_id (wechat_id),
  INDEX idx_phone (phone)
);
```

#### å•†æˆ·è¡¨ (merchants)
```sql
CREATE TABLE merchants (
  id VARCHAR(36) PRIMARY KEY,
  merchant_name VARCHAR(200) NOT NULL,
  contact_name VARCHAR(100),
  contact_phone VARCHAR(20),
  business_license VARCHAR(100),
  address VARCHAR(500),
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_merchant_name (merchant_name),
  INDEX idx_contact_phone (contact_phone)
);
```

#### æ”¯ä»˜è®¢å•è¡¨ (payment_orders)
```sql
CREATE TABLE payment_orders (
  id VARCHAR(36) PRIMARY KEY,
  order_no VARCHAR(32) UNIQUE NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  merchant_id VARCHAR(36) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  status TINYINT DEFAULT 0,
  payment_method VARCHAR(20) DEFAULT 'wechat',
  wechat_transaction_id VARCHAR(64),
  paid_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_merchant_id (merchant_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
);
```

#### ç§¯åˆ†è®°å½•è¡¨ (points_records)
```sql
CREATE TABLE points_records (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  order_id VARCHAR(36),
  points_change INT NOT NULL,
  points_balance INT NOT NULL,
  change_type TINYINT NOT NULL,
  source VARCHAR(50),
  description VARCHAR(200),
  expires_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_order_id (order_id),
  INDEX idx_change_type (change_type),
  INDEX idx_expires_at (expires_at),
  INDEX idx_created_at (created_at)
);
```

#### ç”¨æˆ·ç§¯åˆ†æ±‡æ€»è¡¨ (user_points)
```sql
CREATE TABLE user_points (
  user_id VARCHAR(36) PRIMARY KEY,
  total_points INT DEFAULT 0,
  available_points INT DEFAULT 0,
  used_points INT DEFAULT 0,
  expired_points INT DEFAULT 0,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_available_points (available_points)
);
```

### æ•°æ®åº“è®¾è®¡åŸåˆ™

#### 1. åˆ†è¡¨ç­–ç•¥
- **æŒ‰æ—¶é—´åˆ†è¡¨**ï¼šç§¯åˆ†è®°å½•è¡¨æŒ‰æœˆåˆ†è¡¨
- **æŒ‰ç”¨æˆ·åˆ†è¡¨**ï¼šé«˜å¹¶å‘æ—¶å¯è€ƒè™‘ç”¨æˆ·è¡¨åˆ†è¡¨
- **è¯»å†™åˆ†ç¦»**ï¼šä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–

#### 2. ç´¢å¼•è®¾è®¡
- **ä¸»é”®ç´¢å¼•**ï¼šæ‰€æœ‰è¡¨ä½¿ç”¨UUIDä¸»é”®
- **å”¯ä¸€ç´¢å¼•**ï¼šè®¢å•å·ã€å¾®ä¿¡IDç­‰å”¯ä¸€å­—æ®µ
- **ç»„åˆç´¢å¼•**ï¼šå¸¸ç”¨æŸ¥è¯¢å­—æ®µç»„åˆ
- **æ—¶é—´ç´¢å¼•**ï¼šæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢çš„å­—æ®µ

#### 3. æ•°æ®ä¸€è‡´æ€§
- **äº‹åŠ¡æ§åˆ¶**ï¼šæ”¯ä»˜å’Œç§¯åˆ†å‘æ”¾ä½¿ç”¨äº‹åŠ¡
- **ä¹è§‚é”**ï¼šç§¯åˆ†ä½™é¢æ›´æ–°ä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶
- **è¡¥å¿æœºåˆ¶**ï¼šå¼‚å¸¸æƒ…å†µä¸‹çš„æ•°æ®ä¿®å¤

---

## ğŸš€ ç¼“å­˜æ¶æ„è®¾è®¡

### Redis ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜å±‚æ¬¡
```
L1 ç¼“å­˜ï¼šåº”ç”¨å†…å­˜ç¼“å­˜ (Node.js Memory)
â”œâ”€â”€ ç”¨æˆ·Sessionä¿¡æ¯
â”œâ”€â”€ å•†æˆ·åŸºç¡€ä¿¡æ¯
â””â”€â”€ ç§¯åˆ†è§„åˆ™é…ç½®

L2 ç¼“å­˜ï¼šRedisåˆ†å¸ƒå¼ç¼“å­˜
â”œâ”€â”€ ç”¨æˆ·ç§¯åˆ†ä½™é¢
â”œâ”€â”€ æ”¯ä»˜è®¢å•çŠ¶æ€
â”œâ”€â”€ å•†æˆ·äº¤æ˜“ç»Ÿè®¡
â””â”€â”€ çƒ­ç‚¹æ•°æ®ç¼“å­˜
```

#### ç¼“å­˜é”®è®¾è®¡
```typescript
// ç¼“å­˜é”®è§„èŒƒ
const CacheKeys = {
  // ç”¨æˆ·ç›¸å…³
  USER_INFO: 'user:info:{userId}',
  USER_POINTS: 'user:points:{userId}',
  USER_SESSION: 'user:session:{sessionId}',
  
  // æ”¯ä»˜ç›¸å…³
  PAYMENT_ORDER: 'payment:order:{orderId}',
  PAYMENT_STATUS: 'payment:status:{orderId}',
  
  // å•†æˆ·ç›¸å…³
  MERCHANT_INFO: 'merchant:info:{merchantId}',
  MERCHANT_STATS: 'merchant:stats:{merchantId}:{date}',
  
  // ä¸šåŠ¡ç›¸å…³
  POINTS_RULES: 'points:rules',
  SYSTEM_CONFIG: 'system:config',
}
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
- **Cache Aside Pattern**ï¼šåº”ç”¨è´Ÿè´£ç¼“å­˜ç»´æŠ¤
- **Write Through**ï¼šå†™å…¥æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜
- **TTLè®¾ç½®**ï¼šä¸åŒæ•°æ®è®¾ç½®ä¸åŒè¿‡æœŸæ—¶é—´
- **ç¼“å­˜é¢„çƒ­**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®

---

## ğŸ”’ å®‰å…¨æ¶æ„è®¾è®¡

### 1. æ¥å£å®‰å…¨

#### APIé‰´æƒæœºåˆ¶
```typescript
// JWT Token ç»“æ„
interface JWTPayload {
  userId: string
  merchantId?: string
  role: UserRole
  permissions: string[]
  iat: number
  exp: number
}

// è¯·æ±‚ç­¾åéªŒè¯
interface RequestSignature {
  timestamp: number
  nonce: string
  signature: string  // MD5(timestamp + nonce + secretKey)
}
```

#### æ¥å£é™æµ
```typescript
// é™æµè§„åˆ™é…ç½®
const RateLimitRules = {
  // æ”¯ä»˜æ¥å£ï¼šæ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡
  '/api/payment/create': {
    windowMs: 60 * 1000,
    max: 5,
    keyGenerator: (req) => req.user.id
  },
  
  // æŸ¥è¯¢æ¥å£ï¼šæ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š100æ¬¡
  '/api/points/query': {
    windowMs: 60 * 1000,
    max: 100,
    keyGenerator: (req) => req.user.id
  }
}
```

### 2. æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®åŠ å¯†
```typescript
// æ•°æ®åŠ å¯†é…ç½®
const EncryptionConfig = {
  // ç”¨æˆ·æ‰‹æœºå·åŠ å¯†
  phone: {
    algorithm: 'AES-256-GCM',
    keyRotation: 90 // 90å¤©è½®æ¢
  },
  
  // æ”¯ä»˜å¯†é’¥åŠ å¯†
  paymentKey: {
    algorithm: 'RSA-2048',
    keyRotation: 365 // ä¸€å¹´è½®æ¢
  }
}
```

#### æ•°æ®è„±æ•
```typescript
// æ—¥å¿—è„±æ•è§„åˆ™
const DataMaskingRules = {
  phone: (phone: string) => phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'),
  idCard: (idCard: string) => idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2'),
  bankCard: (card: string) => card.replace(/(\d{4})\d+(\d{4})/, '$1****$2')
}
```

### 3. ä¸šåŠ¡å®‰å…¨

#### é£æ§è§„åˆ™
```typescript
// é£æ§è§„åˆ™å¼•æ“
interface RiskRule {
  name: string
  condition: (context: RiskContext) => boolean
  action: RiskAction
  priority: number
}

const PaymentRiskRules: RiskRule[] = [
  {
    name: 'å•ç”¨æˆ·é«˜é¢‘æ”¯ä»˜',
    condition: (ctx) => ctx.userPaymentCount > 10, // 1åˆ†é’Ÿå†…è¶…è¿‡10æ¬¡
    action: RiskAction.BLOCK,
    priority: 1
  },
  {
    name: 'å¼‚å¸¸IPæ”¯ä»˜',
    condition: (ctx) => ctx.isUnknownIP,
    action: RiskAction.VERIFY,
    priority: 2
  }
]
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨ç›‘æ§

#### ç›‘æ§æŒ‡æ ‡
```typescript
// ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡
const BusinessMetrics = {
  // æ”¯ä»˜ç›¸å…³
  paymentSuccessRate: 'æ”¯ä»˜æˆåŠŸç‡',
  paymentResponseTime: 'æ”¯ä»˜å“åº”æ—¶é—´',
  dailyPaymentAmount: 'æ—¥æ”¯ä»˜é‡‘é¢',
  
  // ç§¯åˆ†ç›¸å…³
  pointsAwardSuccessRate: 'ç§¯åˆ†å‘æ”¾æˆåŠŸç‡',
  pointsAwardDelay: 'ç§¯åˆ†å‘æ”¾å»¶è¿Ÿ',
  dailyPointsAmount: 'æ—¥ç§¯åˆ†å‘æ”¾é‡',
  
  // ç”¨æˆ·ç›¸å…³
  userRegistrationRate: 'ç”¨æˆ·æ³¨å†Œç‡',
  userRetentionRate: 'ç”¨æˆ·ç•™å­˜ç‡',
  userActiveRate: 'ç”¨æˆ·æ´»è·ƒç‡'
}

// æŠ€æœ¯ç›‘æ§æŒ‡æ ‡
const TechnicalMetrics = {
  responseTime: 'æ¥å£å“åº”æ—¶é—´',
  errorRate: 'é”™è¯¯ç‡',
  throughput: 'ååé‡',
  concurrency: 'å¹¶å‘æ•°',
  cpuUsage: 'CPUä½¿ç”¨ç‡',
  memoryUsage: 'å†…å­˜ä½¿ç”¨ç‡',
  diskUsage: 'ç£ç›˜ä½¿ç”¨ç‡'
}
```

#### å‘Šè­¦è§„åˆ™
```typescript
const AlertRules = [
  {
    metric: 'paymentSuccessRate',
    condition: '< 95%',
    level: 'Critical',
    channels: ['é’‰é’‰', 'çŸ­ä¿¡', 'é‚®ä»¶']
  },
  {
    metric: 'responseTime',
    condition: '> 500ms',
    level: 'Warning',
    channels: ['é’‰é’‰']
  }
]
```

### 2. æ—¥å¿—ç³»ç»Ÿ

#### æ—¥å¿—åˆ†ç±»
```typescript
// æ—¥å¿—ç±»å‹å®šä¹‰
enum LogLevel {
  ERROR = 'error',
  WARN = 'warn', 
  INFO = 'info',
  DEBUG = 'debug'
}

enum LogCategory {
  BUSINESS = 'business',  // ä¸šåŠ¡æ—¥å¿—
  SECURITY = 'security',  // å®‰å…¨æ—¥å¿—
  SYSTEM = 'system',      // ç³»ç»Ÿæ—¥å¿—
  AUDIT = 'audit'         // å®¡è®¡æ—¥å¿—
}
```

#### æ—¥å¿—æ ¼å¼
```typescript
interface LogEntry {
  timestamp: string
  level: LogLevel
  category: LogCategory
  traceId: string
  userId?: string
  merchantId?: string
  action: string
  message: string
  data?: any
  error?: Error
}
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### 1. å®¹å™¨åŒ–éƒ¨ç½²

#### Docker é…ç½®
```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

#### Kubernetes é…ç½®
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: points-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: points-app
  template:
    metadata:
      labels:
        app: points-app
    spec:
      containers:
      - name: points-app
        image: points-app:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
```

### 2. ç¯å¢ƒè§„åˆ’

#### ç¯å¢ƒåˆ’åˆ†
```
å¼€å‘ç¯å¢ƒ (DEV)
â”œâ”€â”€ ç”¨é€”ï¼šå¼€å‘è°ƒè¯•
â”œâ”€â”€ é…ç½®ï¼šå•å®ä¾‹éƒ¨ç½²
â”œâ”€â”€ æ•°æ®ï¼šæµ‹è¯•æ•°æ®
â””â”€â”€ åŸŸåï¼šdev-points.example.com

æµ‹è¯•ç¯å¢ƒ (TEST)
â”œâ”€â”€ ç”¨é€”ï¼šåŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ é…ç½®ï¼šåŒå®ä¾‹éƒ¨ç½²
â”œâ”€â”€ æ•°æ®ï¼šæ¨¡æ‹Ÿæ•°æ®
â””â”€â”€ åŸŸåï¼štest-points.example.com

é¢„ç”Ÿäº§ç¯å¢ƒ (STAGING)
â”œâ”€â”€ ç”¨é€”ï¼šä¸Šçº¿å‰éªŒè¯
â”œâ”€â”€ é…ç½®ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ æ•°æ®ï¼šè„±æ•ç”Ÿäº§æ•°æ®
â””â”€â”€ åŸŸåï¼šstaging-points.example.com

ç”Ÿäº§ç¯å¢ƒ (PROD)
â”œâ”€â”€ ç”¨é€”ï¼šæ­£å¼æœåŠ¡
â”œâ”€â”€ é…ç½®ï¼šé«˜å¯ç”¨éƒ¨ç½²
â”œâ”€â”€ æ•°æ®ï¼šçœŸå®æ•°æ®
â””â”€â”€ åŸŸåï¼špoints.example.com
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. åº”ç”¨å±‚ä¼˜åŒ–

#### ä»£ç ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ async/await å’Œ Promise
- **å†…å­˜ç®¡ç†**ï¼šé¿å…å†…å­˜æ³„æ¼ï¼ŒåŠæ—¶é‡Šæ”¾èµ„æº
- **ç®—æ³•ä¼˜åŒ–**ï¼šé€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„å’Œç®—æ³•
- **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘è®¡ç®—

#### æ•°æ®åº“ä¼˜åŒ–
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé¿å…N+1é—®é¢˜ï¼Œä½¿ç”¨è¿æ¥æŸ¥è¯¢
- **åˆ†é¡µä¼˜åŒ–**ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£OFFSET
- **è¿æ¥æ± **ï¼šåˆç†é…ç½®æ•°æ®åº“è¿æ¥æ± 

### 2. åŸºç¡€è®¾æ–½ä¼˜åŒ–

#### CDN é…ç½®
```typescript
const CDNConfig = {
  // é™æ€èµ„æºCDN
  staticFiles: {
    domain: 'cdn.example.com',
    cache: '7d',
    gzip: true
  },
  
  // å›¾ç‰‡CDN
  images: {
    domain: 'img.example.com',
    cache: '30d',
    webp: true,
    resize: true
  }
}
```

#### è´Ÿè½½å‡è¡¡
```nginx
# nginx é…ç½®
upstream points_backend {
    server 10.0.1.10:3000 weight=3;
    server 10.0.1.11:3000 weight=2;
    server 10.0.1.12:3000 weight=1;
}

server {
    listen 80;
    server_name points.example.com;
    
    location / {
        proxy_pass http://points_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### 1. å¾®æœåŠ¡æ¼”è¿›

#### æœåŠ¡æ‹†åˆ†ç­–ç•¥
```
å•ä½“åº”ç”¨ â†’ æœåŠ¡åŒ– â†’ å¾®æœåŠ¡åŒ–

Phase 1: å•ä½“åº”ç”¨
â”œâ”€â”€ å¿«é€Ÿå¼€å‘ä¸Šçº¿
â”œâ”€â”€ åŠŸèƒ½éªŒè¯
â””â”€â”€ ç§¯ç´¯ä¸šåŠ¡ç»éªŒ

Phase 2: æœåŠ¡åŒ–
â”œâ”€â”€ æ ¸å¿ƒæœåŠ¡åˆ†ç¦»
â”œâ”€â”€ æ•°æ®åº“åˆ†åº“
â””â”€â”€ æ¥å£æ ‡å‡†åŒ–

Phase 3: å¾®æœåŠ¡åŒ–
â”œâ”€â”€ æœåŠ¡å½»åº•åˆ†ç¦»
â”œâ”€â”€ ç‹¬ç«‹éƒ¨ç½²
â””â”€â”€ æœåŠ¡æ²»ç†
```

### 2. æ•°æ®åº“æ‰©å±•

#### åˆ†åº“åˆ†è¡¨ç­–ç•¥
```typescript
// åˆ†è¡¨ç­–ç•¥
const ShardingStrategy = {
  // æŒ‰ç”¨æˆ·IDåˆ†è¡¨
  userPoints: {
    shardKey: 'user_id',
    shardCount: 16,
    algorithm: 'hash'
  },
  
  // æŒ‰æ—¶é—´åˆ†è¡¨
  pointsRecords: {
    shardKey: 'created_at',
    shardType: 'monthly',
    retentionMonths: 12
  }
}
```

### 3. ä¸šåŠ¡æ‰©å±•

#### å¤šç§Ÿæˆ·æ”¯æŒ
```typescript
// å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
interface TenantContext {
  tenantId: string
  tenantType: TenantType
  permissions: Permission[]
  restrictions: Restriction[]
}

// æ•°æ®è®¿é—®æ§åˆ¶
class DataAccessControl {
  filterByTenant(query: Query, tenant: TenantContext): Query {
    return query.where('tenant_id', tenant.tenantId)
  }
}
```

---

## ğŸ“ æ€»ç»“

### æ¶æ„ä¼˜åŠ¿
1. **é«˜å¯ç”¨**ï¼šå¤šå±‚å®¹é”™å’Œæ•…éšœæ¢å¤æœºåˆ¶
2. **é«˜æ€§èƒ½**ï¼šç¼“å­˜ã€CDNã€è´Ÿè½½å‡è¡¡ç­‰ä¼˜åŒ–
3. **é«˜å®‰å…¨**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ä½“ç³»
4. **æ˜“æ‰©å±•**ï¼šå¾®æœåŠ¡æ¶æ„æ”¯æŒä¸šåŠ¡å¿«é€Ÿæ‰©å±•
5. **æ˜“ç»´æŠ¤**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„å’Œä»£ç è§„èŒƒ

### æŠ€æœ¯å€ºåŠ¡
1. **ç›‘æ§å®Œå–„**ï¼šéœ€è¦è¿›ä¸€æ­¥å®Œå–„ç›‘æ§ä½“ç³»
2. **è‡ªåŠ¨åŒ–**ï¼šæå‡è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æ°´å¹³
3. **æ–‡æ¡£ç»´æŠ¤**ï¼šä¿æŒæŠ€æœ¯æ–‡æ¡£ä¸ä»£ç åŒæ­¥
4. **æ€§èƒ½è°ƒä¼˜**ï¼šæŒç»­è¿›è¡Œæ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### åç»­è§„åˆ’
1. **ç¬¬äºŒæœŸæ¶æ„**ï¼šæ”¯æŒåˆ†è´¦å’Œçº¢åŒ…åŠŸèƒ½
2. **å¤§æ•°æ®å¹³å°**ï¼šæ„å»ºæ•°æ®ä»“åº“å’Œåˆ†æå¹³å°
3. **AIèƒ½åŠ›**ï¼šé›†æˆæœºå™¨å­¦ä¹ å’Œæ™ºèƒ½æ¨è
4. **å¼€æ”¾å¹³å°**ï¼šæä¾›APIå’ŒSDKç»™ç¬¬ä¸‰æ–¹

---

**æ–‡æ¡£çŠ¶æ€**ï¼šå¾…æŠ€æœ¯è¯„å®¡  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šæ•°æ®åº“è¯¦ç»†è®¾è®¡  
**è´£ä»»äºº**ï¼šæ¶æ„å¸ˆ  
**è¯„å®¡æ—¶é—´**ï¼šå¾…å®š
