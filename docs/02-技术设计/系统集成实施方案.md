# ğŸš€ å•†æˆ·äºŒç»´ç +ç§¯åˆ†ç³»ç»Ÿæ•´åˆå®æ–½æ–¹æ¡ˆ

## ğŸ¯ **æ ¸å¿ƒæ€è·¯**

åŸºäºç°æœ‰ä»£ç æ¶æ„ï¼Œå®Œå–„"å•†æˆ·ç”³è¯·åŒæ­¥ + ä¸“å±äºŒç»´ç  + ç§¯åˆ†å¥–åŠ±"çš„å®Œæ•´é—­ç¯ï¼

## ğŸ“‹ **ç°æœ‰åŸºç¡€è¯„ä¼°**

### âœ… **å·²æœ‰çš„ä¼˜ç§€åŸºç¡€**
- `MerchantQRCodeService` - äºŒç»´ç ç”ŸæˆæœåŠ¡
- `PointsService` - ç§¯åˆ†ç®¡ç†æœåŠ¡  
- `PaymentService` - æ”¯ä»˜å¤„ç†æœåŠ¡
- `WechatService` - å¾®ä¿¡æ¥å£æœåŠ¡
- çœŸå®å•†æˆ·æ•°æ®ï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼‰

### ğŸ”§ **éœ€è¦å®Œå–„çš„åŠŸèƒ½**
1. å•†æˆ·ç”³è¯·æ—¶åŒæ­¥å½•å…¥ç³»ç»Ÿ
2. å•†æˆ·ä¸“å±äºŒç»´ç ä¸ç§¯åˆ†è§„åˆ™ç»‘å®š
3. æ”¯ä»˜å›è°ƒè‡ªåŠ¨è¯†åˆ«å•†æˆ·å¹¶å‘æ”¾ç§¯åˆ†
4. å•†æˆ·ç§¯åˆ†è§„åˆ™é…ç½®ç®¡ç†

## ğŸ› ï¸ **å…·ä½“å®æ–½æ–¹æ¡ˆ**

### **Step 1: å¢å¼ºå•†æˆ·æ•°æ®ç®¡ç†**

#### **A. å•†æˆ·è¡¨ç»“æ„ä¼˜åŒ–**
```sql
-- åœ¨ç°æœ‰å•†æˆ·è¡¨åŸºç¡€ä¸Šå¢åŠ ç§¯åˆ†é…ç½®å­—æ®µ
ALTER TABLE merchants ADD COLUMN points_ratio DECIMAL(5,2) DEFAULT 1.00 COMMENT 'ç§¯åˆ†æ¯”ä¾‹(1å…ƒ=Xç§¯åˆ†)';
ALTER TABLE merchants ADD COLUMN points_bonus_threshold DECIMAL(10,2) DEFAULT 0 COMMENT 'å¥–åŠ±é—¨æ§›é‡‘é¢';  
ALTER TABLE merchants ADD COLUMN points_bonus_ratio DECIMAL(5,2) DEFAULT 0 COMMENT 'è¶…é¢å¥–åŠ±æ¯”ä¾‹';
ALTER TABLE merchants ADD COLUMN qr_code_status ENUM('active','inactive','expired') DEFAULT 'inactive' COMMENT 'äºŒç»´ç çŠ¶æ€';
ALTER TABLE merchants ADD COLUMN qr_code_updated_at TIMESTAMP COMMENT 'äºŒç»´ç æ›´æ–°æ—¶é—´';
```

#### **B. å•†æˆ·ç§¯åˆ†é…ç½®æœåŠ¡**
```typescript
// backend/src/services/MerchantPointsConfigService.ts
export class MerchantPointsConfigService {
  
  // è®¾ç½®å•†æˆ·ç§¯åˆ†è§„åˆ™
  static async setMerchantPointsRule(
    merchantId: string,
    baseRatio: number = 1.0,        // åŸºç¡€æ¯”ä¾‹ï¼š1å…ƒ=Xç§¯åˆ†
    bonusThreshold?: number,        // å¥–åŠ±é—¨æ§›ï¼šæ»¡Xå…ƒ
    bonusRatio?: number            // é¢å¤–å¥–åŠ±æ¯”ä¾‹
  ) {
    const updateData = {
      points_ratio: baseRatio,
      points_bonus_threshold: bonusThreshold || 0,
      points_bonus_ratio: bonusRatio || 0,
      updated_at: new Date()
    };
    
    return await MerchantModel.updateById(merchantId, updateData);
  }
  
  // è®¡ç®—ç”¨æˆ·åœ¨æŒ‡å®šå•†æˆ·çš„ç§¯åˆ†å¥–åŠ±
  static async calculatePointsReward(
    merchantId: string, 
    paymentAmount: number
  ): Promise<number> {
    const merchant = await MerchantModel.findById(merchantId);
    if (!merchant) return 0;
    
    let totalPoints = Math.floor(paymentAmount * merchant.points_ratio);
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å¥–åŠ±é—¨æ§›
    if (merchant.points_bonus_threshold > 0 && 
        paymentAmount >= merchant.points_bonus_threshold) {
      const bonusPoints = Math.floor(paymentAmount * merchant.points_bonus_ratio);
      totalPoints += bonusPoints;
    }
    
    return totalPoints;
  }
}
```

### **Step 2: å®Œå–„äºŒç»´ç ç”Ÿæˆæµç¨‹**

#### **A. å¢å¼ºMerchantQRCodeService**
```typescript
// åœ¨ç°æœ‰MerchantQRCodeServiceåŸºç¡€ä¸Šå¢åŠ ç§¯åˆ†ä¿¡æ¯
export class EnhancedMerchantQRCodeService extends MerchantQRCodeService {
  
  // ç”ŸæˆåŒ…å«ç§¯åˆ†è§„åˆ™çš„å•†æˆ·äºŒç»´ç 
  static async generateMerchantQRCodeWithPoints(
    merchantId: string,
    fixedAmount?: number
  ): Promise<{
    qrCodeBuffer: Buffer;
    qrCodeUrl: string;
    merchantInfo: any;
    pointsRule: any;
    expiresAt: Date;
  }> {
    // 1. è·å–å•†æˆ·ä¿¡æ¯å’Œç§¯åˆ†è§„åˆ™
    const merchant = await MerchantModel.findById(merchantId);
    if (!merchant) throw new Error('å•†æˆ·ä¸å­˜åœ¨');
    
    // 2. ç”ŸæˆåŸºç¡€äºŒç»´ç 
    const qrResult = await super.generateWechatNativeQRCode(
      merchantId,
      merchant.wechat_merchant_id,
      fixedAmount || 5000, // é»˜è®¤50å…ƒ
      `${merchant.merchant_name}æ”¶æ¬¾`
    );
    
    // 3. æ„å»ºç§¯åˆ†è§„åˆ™ä¿¡æ¯
    const pointsRule = {
      baseRatio: merchant.points_ratio,
      bonusThreshold: merchant.points_bonus_threshold,
      bonusRatio: merchant.points_bonus_ratio,
      description: this.generatePointsDescription(merchant)
    };
    
    // 4. æ›´æ–°å•†æˆ·äºŒç»´ç çŠ¶æ€
    await MerchantModel.updateById(merchantId, {
      qr_code_status: 'active',
      qr_code_updated_at: new Date()
    });
    
    return {
      qrCodeBuffer: qrResult.qrCodeBuffer,
      qrCodeUrl: qrResult.codeUrl,
      merchantInfo: {
        id: merchant.id,
        name: merchant.merchant_name,
        wechatMerchantId: merchant.wechat_merchant_id
      },
      pointsRule,
      expiresAt: qrResult.expiresAt
    };
  }
  
  // ç”Ÿæˆç§¯åˆ†è§„åˆ™æè¿°
  private static generatePointsDescription(merchant: any): string {
    let desc = `æ¶ˆè´¹1å…ƒè·å¾—${merchant.points_ratio}ç§¯åˆ†`;
    
    if (merchant.points_bonus_threshold > 0) {
      desc += `ï¼Œæ»¡${merchant.points_bonus_threshold}å…ƒé¢å¤–è·å¾—${merchant.points_bonus_ratio}å€ç§¯åˆ†`;
    }
    
    return desc;
  }
}
```

### **Step 3: æ”¯ä»˜å›è°ƒè‡ªåŠ¨ç§¯åˆ†**

#### **A. å¢å¼ºPaymentServiceæ”¯ä»˜å›è°ƒ**
```typescript
// åœ¨ç°æœ‰PaymentServiceåŸºç¡€ä¸Šå¢åŠ å•†æˆ·è¯†åˆ«å’Œç§¯åˆ†å‘æ”¾
export class EnhancedPaymentService extends PaymentService {
  
  // å¤„ç†æ”¯ä»˜æˆåŠŸå›è°ƒï¼ˆå«ç§¯åˆ†å¥–åŠ±ï¼‰
  static async handlePaymentCallbackWithPoints(
    callbackData: WechatPaymentCallback
  ): Promise<void> {
    try {
      // 1. éªŒè¯æ”¯ä»˜æ•°æ®
      const order = await PaymentOrderModel.findByOrderNo(callbackData.out_trade_no);
      if (!order) throw new Error('è®¢å•ä¸å­˜åœ¨');
      
      // 2. æ›´æ–°è®¢å•çŠ¶æ€
      await PaymentOrderModel.updateStatus(order.id, 'paid');
      
      // 3. è¯†åˆ«å•†æˆ·å¹¶è®¡ç®—ç§¯åˆ†
      const pointsToAward = await MerchantPointsConfigService.calculatePointsReward(
        order.merchantId,
        order.amount
      );
      
      // 4. å‘æ”¾ç§¯åˆ†ç»™ç”¨æˆ·
      if (pointsToAward > 0) {
        const merchant = await MerchantModel.findById(order.merchantId);
        
        await PointsService.awardPoints(
          order.userId,
          pointsToAward,
          'payment_reward',
          `åœ¨${merchant?.merchant_name}æ¶ˆè´¹è·å¾—ç§¯åˆ†`,
          order.id
        );
        
        // 5. å‘é€ç§¯åˆ†åˆ°è´¦é€šçŸ¥
        await this.sendPointsAwardNotification(
          order.userId,
          pointsToAward,
          merchant?.merchant_name || 'å•†æˆ·'
        );
      }
      
      console.log(`âœ… æ”¯ä»˜å›è°ƒå¤„ç†å®Œæˆ: è®¢å•${order.orderNo}, ç§¯åˆ†${pointsToAward}`);
      
    } catch (error) {
      console.error('æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥:', error);
      throw error;
    }
  }
  
  // å‘é€ç§¯åˆ†å¥–åŠ±é€šçŸ¥
  private static async sendPointsAwardNotification(
    userId: string,
    points: number,
    merchantName: string
  ): Promise<void> {
    try {
      const user = await UserModel.findById(userId);
      if (!user?.openid) return;
      
      await WechatService.sendPaymentSuccessMessage(user.openid, {
        orderNo: '',
        amount: 0,
        pointsAwarded: points,
        merchantName
      });
    } catch (error) {
      console.log('ç§¯åˆ†é€šçŸ¥å‘é€å¤±è´¥:', error);
    }
  }
}
```

### **Step 4: å•†æˆ·ç”³è¯·åŒæ­¥æµç¨‹**

#### **A. å•†æˆ·ç”³è¯·è¡¨å•**
```typescript
// å•†æˆ·ç”³è¯·æ—¶çš„æ•°æ®ç»“æ„
interface MerchantApplicationForm {
  // åŸºç¡€ä¿¡æ¯ï¼ˆä»å¾®ä¿¡å¹³å°å¤åˆ¶ï¼‰
  applymentId: string;           // ç”³è¯·å•å·
  merchantName: string;          // å•†æˆ·åç§°
  wechatMerchantId: string;      // å¾®ä¿¡å•†æˆ·å·
  contactPerson: string;         // è”ç³»äºº
  contactPhone: string;          // è”ç³»ç”µè¯
  
  // ç§¯åˆ†é…ç½®
  pointsRatio: number;           // ç§¯åˆ†æ¯”ä¾‹ (é»˜è®¤1.0)
  bonusThreshold?: number;       // å¥–åŠ±é—¨æ§› (å¯é€‰)
  bonusRatio?: number;          // å¥–åŠ±æ¯”ä¾‹ (å¯é€‰)
  
  // ä¸šåŠ¡ä¿¡æ¯
  businessType: string;          // ä¸šåŠ¡ç±»å‹
  address: string;              // åœ°å€
  description?: string;         // æè¿°
}
```

#### **B. å•†æˆ·ç”³è¯·å¤„ç†æœåŠ¡**
```typescript
export class MerchantApplicationService {
  
  // å•†æˆ·ç”³è¯·æäº¤ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
  static async submitMerchantApplication(
    formData: MerchantApplicationForm
  ): Promise<string> {
    try {
      // 1. åˆ›å»ºå•†æˆ·è®°å½•
      const merchantData = {
        id: generateId(),
        applyment_id: formData.applymentId,
        merchant_name: formData.merchantName,
        wechat_merchant_id: formData.wechatMerchantId,
        contact_person: formData.contactPerson,
        contact_phone: formData.contactPhone,
        status: 'active',
        points_ratio: formData.pointsRatio || 1.0,
        points_bonus_threshold: formData.bonusThreshold || 0,
        points_bonus_ratio: formData.bonusRatio || 0,
        business_type: formData.businessType,
        address: formData.address,
        description: formData.description,
        created_at: new Date()
      };
      
      const merchantId = await MerchantModel.create(merchantData);
      
      // 2. è‡ªåŠ¨ç”Ÿæˆä¸“å±äºŒç»´ç 
      await EnhancedMerchantQRCodeService.generateMerchantQRCodeWithPoints(merchantId);
      
      console.log(`âœ… å•†æˆ·ç”³è¯·æˆåŠŸ: ${formData.merchantName} (${merchantId})`);
      
      return merchantId;
      
    } catch (error) {
      console.error('å•†æˆ·ç”³è¯·å¤±è´¥:', error);
      throw error;
    }
  }
}
```

### **Step 5: å‰ç«¯ç®¡ç†ç•Œé¢**

#### **A. å•†æˆ·ç”³è¯·è¡¨å•é¡µé¢**
```typescript
// admin-frontend/src/pages/MerchantApplication/index.tsx
const MerchantApplicationForm: React.FC = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async (values: any) => {
    setLoading(true);
    try {
      const response = await apiRequest('/admin/merchants/apply', {
        method: 'POST',
        body: JSON.stringify(values)
      });
      
      if (response.success) {
        message.success('å•†æˆ·ç”³è¯·æˆåŠŸï¼');
        // è·³è½¬åˆ°å•†æˆ·åˆ—è¡¨æˆ–äºŒç»´ç ç”Ÿæˆé¡µé¢
      }
    } catch (error) {
      message.error('ç”³è¯·å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Card title="æ–°å•†æˆ·ç”³è¯·">
      <Form form={form} onFinish={handleSubmit} layout="vertical">
        {/* åŸºç¡€ä¿¡æ¯ */}
        <Divider>åŸºç¡€ä¿¡æ¯ï¼ˆä»å¾®ä¿¡å•†æˆ·å¹³å°å¤åˆ¶ï¼‰</Divider>
        <Form.Item name="applymentId" label="ç”³è¯·å•å·" rules={[{required: true}]}>
          <Input placeholder="å¦‚ï¼š2000002691156098" />
        </Form.Item>
        <Form.Item name="merchantName" label="å•†æˆ·åç§°" rules={[{required: true}]}>
          <Input placeholder="å¦‚ï¼šä»å¯¿å¿æ€€ä»è¡—é“äº‘é”¦æ±‡ä¼šæ‰€ï¼ˆä¸ªä½“å·¥å•†æˆ·ï¼‰" />
        </Form.Item>
        <Form.Item name="wechatMerchantId" label="å¾®ä¿¡å•†æˆ·å·" rules={[{required: true}]}>
          <Input placeholder="å¦‚ï¼š1728001633" />
        </Form.Item>
        
        {/* ç§¯åˆ†é…ç½® */}
        <Divider>ç§¯åˆ†å¥–åŠ±é…ç½®</Divider>
        <Form.Item name="pointsRatio" label="åŸºç¡€ç§¯åˆ†æ¯”ä¾‹" initialValue={1.0}>
          <InputNumber 
            min={0.1} 
            max={10} 
            step={0.1} 
            addonAfter="ç§¯åˆ†/å…ƒ"
            placeholder="1å…ƒå¯è·å¾—å¤šå°‘ç§¯åˆ†"
          />
        </Form.Item>
        
        <Button type="primary" htmlType="submit" loading={loading}>
          æäº¤ç”³è¯·å¹¶ç”ŸæˆäºŒç»´ç 
        </Button>
      </Form>
    </Card>
  );
};
```

## ğŸ¯ **ç”¨æˆ·ä½¿ç”¨æµç¨‹**

### **å®Œæ•´æµç¨‹å›¾**
```
1. ç®¡ç†å‘˜ç”³è¯·å•†æˆ·
   â†“
2. ä»å¾®ä¿¡å¹³å°å¤åˆ¶çœŸå®æ•°æ®
   â†“  
3. å¡«å†™ç”³è¯·è¡¨å•ï¼ˆå«ç§¯åˆ†é…ç½®ï¼‰
   â†“
4. ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆä¸“å±äºŒç»´ç 
   â†“
5. å•†æˆ·æ”¶åˆ°äºŒç»´ç ï¼Œå±•ç¤ºç»™é¡¾å®¢
   â†“
6. ç”¨æˆ·æ‰«ç æ”¯ä»˜
   â†“
7. æ”¯ä»˜æˆåŠŸå›è°ƒ
   â†“
8. ç³»ç»Ÿè¯†åˆ«å•†æˆ·ï¼Œè‡ªåŠ¨å‘æ”¾ç§¯åˆ†
   â†“
9. ç”¨æˆ·æ”¶åˆ°ç§¯åˆ†åˆ°è´¦é€šçŸ¥
```

## ğŸ’° **å•†ä¸šä»·å€¼**

### **å¯¹å•†æˆ·çš„ä»·å€¼**
- ğŸ¯ **å®¢æˆ·ç²˜æ€§**: ç§¯åˆ†å¥–åŠ±å¢åŠ å¤è´­ç‡
- ğŸ“ˆ **é”€å”®å¢é•¿**: ç”¨æˆ·ä¸ºè·ç§¯åˆ†å¢åŠ æ¶ˆè´¹
- ğŸ“Š **æ•°æ®æ´å¯Ÿ**: äº†è§£å®¢æˆ·æ¶ˆè´¹è¡Œä¸º
- ğŸ¨ **å“ç‰Œæå‡**: ä¸“å±äºŒç»´ç æå‡å½¢è±¡

### **å¯¹å¹³å°çš„ä»·å€¼**  
- ğŸ’° **æ”¶å…¥æ¥æº**: æ¯ç¬”äº¤æ˜“æ”¶å–å°é¢ä½£é‡‘
- ğŸ“± **ç”¨æˆ·å¢é•¿**: ç§¯åˆ†å¸å¼•ç”¨æˆ·æ³¨å†Œä½¿ç”¨
- ğŸ”„ **ç”Ÿæ€é—­ç¯**: æ”¯ä»˜â†’ç§¯åˆ†â†’æ¶ˆè´¹â†’å¤è´­
- ğŸ“Š **æ•°æ®ä»·å€¼**: æŒæ¡å•†æˆ·å’Œç”¨æˆ·æ•°æ®

## ğŸš€ **å®æ–½æ—¶é—´è¡¨**

- **Week 1**: æ•°æ®åº“ç»“æ„è°ƒæ•´ + å•†æˆ·ç”³è¯·æµç¨‹
- **Week 2**: äºŒç»´ç ç”Ÿæˆå¢å¼º + ç§¯åˆ†é…ç½®
- **Week 3**: æ”¯ä»˜å›è°ƒå¤„ç† + ç§¯åˆ†å‘æ”¾
- **Week 4**: å‰ç«¯ç•Œé¢ + æµ‹è¯•ä¼˜åŒ–

**æ€»ä½“å‘¨æœŸï¼š1ä¸ªæœˆå®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼**

---

**ç»“è®ºï¼šåŸºäºæ‚¨ç°æœ‰çš„ä¼˜ç§€æ¶æ„ï¼Œè¿™ä¸ªæ•´åˆæ–¹æ¡ˆæ—¢è§£å†³äº†æ•°æ®åŒæ­¥é—®é¢˜ï¼Œåˆåˆ›é€ äº†å·¨å¤§çš„å•†ä¸šä»·å€¼ï¼**
