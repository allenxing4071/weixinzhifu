<!--points/index.wxml-->
<view class="points-container">
  
  <!-- 积分余额卡片 -->
  <view class="balance-card">
    <view class="balance-header">
      <view class="balance-title">我的积分</view>
      <view class="balance-refresh" bind:tap="refreshBalance">
        <view class="refresh-icon {{refreshing ? 'rotating' : ''}}">🔄</view>
      </view>
    </view>
    
    <view class="balance-main">
      <view class="balance-number">{{formattedBalance}}</view>
      <view class="balance-label">可用积分</view>
      <view class="balance-value">约等于¥{{pointsValue}}元</view>
    </view>
    
    <view class="balance-stats">
      <view class="stat-item">
        <view class="stat-value">{{balanceInfo.totalEarned || 0}}</view>
        <view class="stat-label">累计获得</view>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <view class="stat-value">{{balanceInfo.totalSpent || 0}}</view>
        <view class="stat-label">累计消费</view>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <view class="stat-value">{{balanceInfo.expiringPoints || 0}}</view>
        <view class="stat-label">即将过期</view>
      </view>
    </view>
    
    <!-- 积分服务区域 -->
    <view class="services-section">
      <view class="service-header">
        <view class="service-title">🎁 积分服务</view>
        <view class="service-desc">使用微信扫一扫支付，立即获得积分奖励</view>
      </view>
      
      <view class="services-grid">
        <view class="service-card mall-card" bind:tap="goToMall">
          <view class="card-icon">🏬</view>
          <view class="card-content">
            <view class="card-title">积分商城</view>
            <view class="card-desc">使用积分兑换商品</view>
            <view class="card-status">即将上线</view>
          </view>
          <view class="card-arrow">→</view>
        </view>
        
        <view class="service-card rules-card" bind:tap="showPointsRules">
          <view class="card-icon">📝</view>
          <view class="card-content">
            <view class="card-title">积分规则</view>
            <view class="card-desc">了解积分获取规则</view>
          </view>
          <view class="card-arrow">→</view>
        </view>
      </view>
      
      <view class="usage-tip">
        <view class="tip-icon">💡</view>
        <view class="tip-text">使用微信扫一扫付款码支付，积分自动入账</view>
      </view>
    </view>
    
    <!-- 积分价值说明（底部总结） -->
    <view class="points-value-summary">
      <view class="summary-title">💰 积分价值</view>
      <view class="value-items">
        <view class="value-item">
          <view class="value-icon">¥</view>
          <view class="value-text">1元 = 1积分</view>
        </view>
        <view class="value-item">
          <view class="value-icon">⚡</view>
          <view class="value-text">支付即时到账</view>
        </view>
        <view class="value-item">
          <view class="value-icon">₵</view>
          <view class="value-text">1积分=1元钱</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 筛选器 -->
  <view class="filter-section card">
    <view class="filter-title">积分记录</view>
    <view class="filter-tabs">
      <view 
        wx:for="{{filterTabs}}" 
        wx:key="value"
        class="filter-tab {{currentFilter == item.value ? 'active' : ''}}"
        bind:tap="switchFilter"
        data-filter="{{item.value}}"
      >
        {{item.label}}
      </view>
    </view>
  </view>

  <!-- 积分记录列表 -->
  <view class="records-section">
    
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-icon">⏳</view>
      <view class="loading-text">加载中...</view>
    </view>
    
    <!-- 空状态 -->
    <view wx:elif="{{records.length === 0}}" class="empty-container card">
      <view class="empty-icon">📝</view>
      <view class="empty-text">暂无积分记录</view>
      <view class="empty-desc">完成支付后即可获得积分奖励</view>
      <button class="btn-primary mt-30" bind:tap="goToScan">去扫码支付</button>
    </view>
    
    <!-- 记录列表 -->
    <view wx:else>
      <view 
        wx:for="{{records}}" 
        wx:key="id"
        class="record-item card"
      >
        <view class="record-header">
          <view class="record-source">
            <view class="source-icon">{{item.sourceIcon}}</view>
            <view class="source-text">{{item.sourceText}}</view>
          </view>
          <view class="record-time">{{item.formattedTime}}</view>
        </view>
        
        <view class="record-content">
          <view class="record-desc">{{item.description}}</view>
          <view class="record-details" wx:if="{{item.orderNo}}">
            订单号：{{item.orderNo}}
          </view>
        </view>
        
        <view class="record-footer">
          <view class="points-change {{item.pointsChange > 0 ? 'positive' : 'negative'}}">
            {{item.formattedChange}}
          </view>
          <view class="balance-after">
            余额：{{item.pointsBalance}}
          </view>
        </view>
        
        <!-- 过期提示 -->
        <view wx:if="{{item.expiresAt && item.pointsChange > 0}}" class="expiry-info">
          <view class="expiry-text">{{item.expiryText}}</view>
        </view>
      </view>
      
      <!-- 加载更多 -->
      <view wx:if="{{hasMore}}" class="load-more">
        <button 
          class="load-more-btn" 
          bind:tap="loadMore"
          disabled="{{loadingMore}}"
        >
          {{loadingMore ? '加载中...' : '加载更多'}}
        </button>
      </view>
      
      <!-- 没有更多 -->
      <view wx:else class="no-more">
        <view class="no-more-text">没有更多记录了</view>
      </view>
    </view>
  </view>

</view>
