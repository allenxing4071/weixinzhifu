<!--pages/points/history.wxml-->
<view class="points-history-container">
  
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-title">ç§¯åˆ†è®°å½•</view>
    <view class="header-subtitle">æŸ¥çœ‹æ‚¨çš„ç§¯åˆ†è·å¾—å’Œä½¿ç”¨æ˜ç»†</view>
  </view>

  <!-- ç§¯åˆ†ç»Ÿè®¡ -->
  <view class="points-stats card">
    <view class="stats-header">
      <view class="stats-title">ç§¯åˆ†ç»Ÿè®¡</view>
      <view class="refresh-btn" bind:tap="refreshData">
        <view class="refresh-icon {{refreshing ? 'rotating' : ''}}">ğŸ”„</view>
      </view>
    </view>
    
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-number">{{pointsStats.currentBalance}}</view>
        <view class="stat-label">å½“å‰ä½™é¢</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{pointsStats.totalEarned}}</view>
        <view class="stat-label">ç´¯è®¡è·å¾—</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{pointsStats.totalSpent}}</view>
        <view class="stat-label">ç´¯è®¡ä½¿ç”¨</view>
      </view>
      <view class="stat-card">
        <view class="stat-number">{{pointsStats.expiringPoints}}</view>
        <view class="stat-label">å³å°†è¿‡æœŸ</view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section card">
    <view class="filter-tabs">
      <view 
        wx:for="{{filterOptions}}" 
        wx:key="value"
        class="filter-tab {{currentFilter === item.value ? 'active' : ''}}"
        bind:tap="switchFilter"
        data-filter="{{item.value}}"
      >
        {{item.label}}
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†è®°å½•åˆ—è¡¨ -->
  <view class="records-section">
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner">â­</view>
      <view class="loading-text">åŠ è½½ç§¯åˆ†è®°å½•ä¸­...</view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{records.length === 0}}" class="empty-container card">
      <view class="empty-icon">ğŸ</view>
      <view class="empty-title">æš‚æ— ç§¯åˆ†è®°å½•</view>
      <view class="empty-desc">ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜åï¼Œç§¯åˆ†è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</view>
      <button class="btn-primary" bind:tap="goToPayment">å»æ¶ˆè´¹èµšç§¯åˆ†</button>
    </view>
    
    <!-- è®°å½•åˆ—è¡¨ -->
    <view wx:else>
      <view 
        wx:for="{{records}}" 
        wx:key="id"
        class="points-record card"
        bind:tap="viewDetail"
        data-record="{{item}}"
      >
        <view class="record-header">
          <view class="record-source">
            <view class="source-icon {{item.type}}">{{item.sourceIcon}}</view>
            <view class="source-details">
              <view class="source-name">{{item.sourceName}}</view>
              <view class="source-desc">{{item.description}}</view>
            </view>
          </view>
          <view class="record-time">{{item.formattedTime}}</view>
        </view>
        
        <view class="record-body">
          <view class="points-change-display">
            <view class="change-amount {{item.changeType}}">
              <view class="change-sign">{{item.changeType === 'earn' ? '+' : '-'}}</view>
              <view class="change-value">{{item.pointsChange}}</view>
              <view class="change-unit">ç§¯åˆ†</view>
            </view>
            <view class="balance-after">
              <view class="balance-label">ä½™é¢</view>
              <view class="balance-value">{{item.balanceAfter}}</view>
            </view>
          </view>
          
          <!-- å…³è”æ”¯ä»˜ä¿¡æ¯ -->
          <view wx:if="{{item.relatedPayment}}" class="related-payment">
            <view class="related-label">å…³è”æ”¯ä»˜</view>
            <view class="related-info">
              <view class="related-merchant">{{item.relatedPayment.merchantName}}</view>
              <view class="related-amount">Â¥{{item.relatedPayment.amount}}</view>
            </view>
          </view>
          
          <!-- è¿‡æœŸä¿¡æ¯ -->
          <view wx:if="{{item.expirationInfo}}" class="expiration-info">
            <view class="expiration-text">{{item.expirationInfo}}</view>
          </view>
        </view>
        
        <view wx:if="{{item.orderNo}}" class="record-footer">
          <view class="order-reference">
            <view class="order-label">å…³è”è®¢å•</view>
            <view class="order-number">{{item.orderNo}}</view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{hasMore}}" class="load-more-section">
        <button 
          class="load-more-btn" 
          bind:tap="loadMore"
          disabled="{{loadingMore}}"
        >
          {{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
        </button>
      </view>
      
      <!-- æ²¡æœ‰æ›´å¤š -->
      <view wx:else class="no-more-section">
        <view class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨è®°å½•</view>
      </view>
    </view>
  </view>

</view>