<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>积分助手 - 扫码支付</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 微信小程序跳转关键配置 -->
    <meta name="wx:appid" content="wx9bed12ef0904d035">
    <meta name="wx:path" content="pages/payment/index">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333; text-align: center; padding: 20px;
        }
        .container { max-width: 400px; margin: 50px auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(45deg, #1AAD19, #07C160); color: white; padding: 40px 20px; }
        .content { padding: 30px 20px; }
        .merchant-info { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; }
        .amount-info { font-size: 24px; color: #1AAD19; font-weight: bold; margin: 15px 0; }
        .jump-btn { width: 100%; background: #1AAD19; color: white; border: none; padding: 16px; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .tips { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px; color: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎉 积分助手</h1>
            <p>扫码支付，立享积分奖励</p>
        </div>
        
        <div class="content">
            <div class="merchant-info">
                <h3 id="merchant-name">商户信息加载中...</h3>
                <div class="amount-info" id="amount-display">💰 金额待确认</div>
            </div>
            
            <div class="tips">
                <p>💡 微信扫码后会自动跳转到小程序</p>
                <p>💎 支付成功立即获得积分奖励</p>
            </div>
            
            <button class="jump-btn" onclick="jumpToMiniProgram()">
                🚀 立即打开小程序支付
            </button>
        </div>
    </div>

    <script>
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const merchantId = urlParams.get('merchantId') || 'merchant_real_004';
        const amount = urlParams.get('amount');
        
        // 商户信息映射
        const merchantNames = {
            'merchant_real_001': '仁寿县怀仁街道云锦汇会所',
            'merchant_real_002': '仁寿县怀仁街道储府鱼庄店', 
            'merchant_real_003': '仁寿县怀仁街道颐善滋养园养生馆',
            'merchant_real_004': '成都市中鑫博海国际酒业贸易有限公司',
            'merchant_real_005': '德阳市叁思科技有限公司'
        };
        
        // 更新页面信息
        document.getElementById('merchant-name').textContent = merchantNames[merchantId] || '商户';
        document.getElementById('amount-display').textContent = amount ? `💰 支付金额: ¥${amount}` : '💰 金额: 用户自定义';
        
        // 检测微信环境
        function isWeixin() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        // 跳转到小程序
        function jumpToMiniProgram() {
            if (isWeixin()) {
                // 构建小程序路径
                let path = `pages/payment/index?merchantId=${merchantId}`;
                if (amount) {
                    path += `&amount=${amount}`;
                }
                
                console.log('跳转小程序路径:', path);
                
                // 使用微信JSSDK跳转
                if (typeof wx !== 'undefined' && wx.miniProgram) {
                    wx.miniProgram.navigateTo({
                        url: path,
                        success: function() {
                            console.log('跳转小程序成功');
                        },
                        fail: function(res) {
                            console.log('跳转小程序失败:', res);
                            // 降级处理：显示提示
                            alert('请在微信中打开此页面以使用小程序支付功能');
                        }
                    });
                } else {
                    // 尝试使用URL Scheme跳转
                    const miniProgramUrl = `weixin://dl/business/?t=*&s=${encodeURIComponent(path)}`;
                    window.location.href = miniProgramUrl;
                }
            } else {
                alert('请在微信中扫码打开此页面');
            }
        }
        
        // 页面加载后自动尝试跳转（延迟1秒让用户看到页面）
        if (isWeixin()) {
            setTimeout(jumpToMiniProgram, 1000);
        }
    </script>
    
    <!-- 微信JSSDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
</body>
</html>
